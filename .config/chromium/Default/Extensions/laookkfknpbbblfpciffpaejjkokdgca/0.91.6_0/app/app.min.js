/*! Momentum Dashboard - app.min.js
Copyright (c) 2013-2016 Momentum Dashboard Corp. All rights reserved.

All portions of this file are the confidential and proprietary
intellectual property of Momentum Dashboard Corp.

Use of this file is permitted only within the Momentum Google Chrome
extension as published on the Google Chrome Web Store at
https://chrome.google.com/webstore/detail/momentum/laookkfknpbbblfpciffpaejjkokdgca
*/
function momoInit(){return!0}function validateEmail(e){var t=/[^@]+@[^@]+\.[^@]+/;return t.test(e)}function getQueryParameter(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),i=t.exec(location.search);return null===i?"":decodeURIComponent(i[1].replace(/\+/g," "))}function getActiveDateString(){var e=new Date;return activeDateStringForDate(e)}function activeDateStringForDate(e){var t=new Date(e);t.getHours()<5&&(t=new Date(t.getTime()-864e5));var i=t.getFullYear().toString()+"-"+twoDigit(t.getMonth()+1)+"-"+twoDigit(t.getDate());return i}function twoDigit(e){var t=parseInt(e),i=t>=10?t:"0"+t.toString();return i.toString()}function submitStats(e){}function setMomentumAuthHeader(e){if(localStorage.token&&e.setRequestHeader("Authorization","Bearer "+localStorage.token),localStorage.client_uuid&&e.setRequestHeader("X-Momentum-ClientId",localStorage.client_uuid),e.setRequestHeader("X-Momentum-Version",m.globals.version),e.setRequestHeader("X-Momentum-ClientDate",getActiveDateString()),m.conditionalFeatures.featureEnabled("allowoptions")){var t=localStorage.getItem("X-Momentum-Options");t&&e.setRequestHeader("X-Momentum-Options",t)}localStorage.activeTags&&e.setRequestHeader("X-Momentum-Tags",localStorage.activeTags)}function isDateInFuture(e){return Date.parse(e)>Date.parse(new Date)}function setEndOfContenteditable(e){var t,i;document.createRange&&(t=document.createRange(),t.selectNodeContents(e),t.collapse(!1),i=window.getSelection(),i.removeAllRanges(),i.addRange(t))}window.m=_.extend({$window:$(window),appView:"",globals:{},models:{},collect:{},views:{},react:{mixins:{}},addins:{},utils:{},bootstrappers:{},commands:{},templates:{},widgets:[]},Backbone.Events),Backbone.View=function(e){return e.extend({constructor:function(t){this.options=t||{},e.apply(this,arguments)}})}(Backbone.View);var backboneSync=Backbone.sync;Backbone.sync=function(e,t,i){i.beforeSend=function(e){setMomentumAuthHeader(e)},backboneSync(e,t,i)},m.templates=m.templates||{},m.templates.background=m.templates.background||{},m.templates.background["background-info"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'<span class="background-info-title">'+(null!=(s=null!=(s=t.title||(null!=e?e.title:e))?s:a,o=typeof s===l?s.call(e,{name:"title",hash:{},data:n}):s)?o:"")+'<i class="icon-angle-right"></i></span>\n<span class="background-info-source">\n    <span class="background-info-source-link" data-url="'+r((s=null!=(s=t.sourceUrl||(null!=e?e.sourceUrl:e))?s:a,typeof s===l?s.call(e,{name:"sourceUrl",hash:{},data:n}):s))+'">'+(null!=(s=null!=(s=t.attribution||(null!=e?e.attribution:e))?s:a,o=typeof s===l?s.call(e,{name:"attribution",hash:{},data:n}):s)?o:"")+'</span><span class="control control-heart '+r((s=null!=(s=t.fav_class||(null!=e?e.fav_class:e))?s:a,typeof s===l?s.call(e,{name:"fav_class",hash:{},data:n}):s))+'"><img src="img/icon-heart-empty.svg" class="icon icon-heart-empty"><img src="img/icon-heart.svg" class="icon icon-heart"></span><span class="control control-refresh" title="Next Background"><img src="img/icon-refresh.svg" class="icon icon-refresh"></span>\n</span>\n'},useData:!0}),m.templates=m.templates||{},m.templates.centerclock=m.templates.centerclock||{},m.templates.centerclock.clock=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<h1 class="time">'+l((o=null!=(o=t.time||(null!=e?e.time:e))?o:s,typeof o===a?o.call(e,{name:"time",hash:{},data:n}):o))+'</h1>\n<span class="format">'+l((o=null!=(o=t.format||(null!=e?e.format:e))?o:s,typeof o===a?o.call(e,{name:"format",hash:{},data:n}):o))+"</span>"},useData:!0}),m.templates=m.templates||{},m.templates.focus=m.templates.focus||{},m.templates.focus["focus-prompt-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<h3>What is your main focus for today?</h3>\n<input type="text">'},useData:!0}),m.templates.focus["focus-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return"<h3>"+l((o=null!=(o=t.day||(null!=e?e.day:e))?o:s,typeof o===a?o.call(e,{name:"day",hash:{},data:n}):o))+'</h3>\n<span class="control checkbox"><i class="icon icon-checkbox-empty focus-open"></i><i class="icon icon-checkbox focus-done"></i></span><p class="todays-focus">'+l((o=null!=(o=t.focus||(null!=e?e.focus:e))?o:s,typeof o===a?o.call(e,{name:"focus",hash:{},data:n}):o))+'</p><span class="control delete"><i>✕</i></span>\n'},useData:!0}),m.templates.focus["focuses-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<ol></ol>\n<div class="message focus-message">\n    <i class="loading-icon"></i>Loading...</span>\n</div>\n'},useData:!0}),m.templates=m.templates||{},m.templates.greeting=m.templates.greeting||{},m.templates.greeting["greeting-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<h2>Good <span class="period">'+l((o=null!=(o=t.period||(null!=e?e.period:e))?o:s,typeof o===a?o.call(e,{name:"period",hash:{},data:n}):o))+'</span>, <span class="name" spellcheck="false">'+l((o=null!=(o=t.name||(null!=e?e.name:e))?o:s,typeof o===a?o.call(e,{name:"name",hash:{},data:n}):o))+"</span>.</h2>"},useData:!0}),m.templates=m.templates||{},m.templates.introduction=m.templates.introduction||{},m.templates.introduction["introduction-button-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o;return'<button class="button">'+this.escapeExpression((o=null!=(o=t.value||(null!=e?e.value:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"value",hash:{},data:n}):o))+"</button>"},useData:!0}),m.templates.introduction["introduction-content-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o;return'<div class="prompt">\n    <div id="introduction-question">'+this.escapeExpression((o=null!=(o=t.message||(null!=e?e.message:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"message",hash:{},data:n}):o))+'</div>\n    <input id="introduction-input" type="text">\n    <div class="tip"></div>\n</div>\n<div class="buttons"></div>'},useData:!0}),m.templates.introduction["introduction-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<p class="logo"><img src="img/logo-white.png"></p>\n<p class=content></p>'},useData:!0}),m.templates.introduction["introduction-tip-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o;return"<div>"+this.escapeExpression((o=null!=(o=t.value||(null!=e?e.value:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"value",hash:{},data:n}):o))+"</div>"},useData:!0}),m.templates=m.templates||{},m.templates.notification=m.templates.notification||{},m.templates.notification.notification=Handlebars.template({1:function(e,t,i,n){var o,s;return'<div class="notification-title">'+(null!=(o=t["if"].call(e,null!=e?e.icon_url:e,{name:"if",hash:{},fn:this.program(2,n,0),inverse:this.noop,data:n}))?o:"")+" "+this.escapeExpression((s=null!=(s=t.title||(null!=e?e.title:e))?s:t.helperMissing,"function"==typeof s?s.call(e,{name:"title",hash:{},data:n}):s))+"</div>"},2:function(e,t,i,n){var o;return'<img src="'+this.escapeExpression((o=null!=(o=t.icon_url||(null!=e?e.icon_url:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"icon_url",hash:{},data:n}):o))+'" style="height: 20px">'},4:function(e,t,i,n){var o;return'<button class="notification-button">'+this.escapeExpression((o=null!=(o=t.cta_text||(null!=e?e.cta_text:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"cta_text",hash:{},data:n}):o))+"</button>"},6:function(e,t,i,n){var o;return'<span class="button-text secondary-text">'+this.escapeExpression((o=null!=(o=t.secondary_text||(null!=e?e.secondary_text:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"secondary_text",hash:{},data:n}):o))+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s;return'<div class="pane widget-pop nipple-bottom-left notification">\n    <span class="hide notification-hide">✕</span>\n    '+(null!=(o=t["if"].call(e,null!=e?e.title:e,{name:"if",hash:{},fn:this.program(1,n,0),inverse:this.noop,data:n}))?o:"")+'\n    <div class="notification-description">'+this.escapeExpression((s=null!=(s=t.message||(null!=e?e.message:e))?s:t.helperMissing,"function"==typeof s?s.call(e,{name:"message",hash:{},data:n}):s))+"</div>\n    "+(null!=(o=t["if"].call(e,null!=e?e.cta_cmd:e,{name:"if",hash:{},fn:this.program(4,n,0),inverse:this.noop,data:n}))?o:"")+(null!=(o=t["if"].call(e,null!=e?e.secondary_cmd:e,{name:"if",hash:{},fn:this.program(6,n,0),inverse:this.noop,data:n}))?o:"")+"\n</div>\n"},useData:!0}),m.templates=m.templates||{},m.templates.quicklinks=m.templates.quicklinks||{},m.templates.quicklinks["quicklinks-item-template"]=Handlebars.template({1:function(e,t,i,n){return' class="local"'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'<div draggable="true" class="view '+r((s=null!=(s=t.classes||(null!=e?e.classes:e))?s:a,typeof s===l?s.call(e,{name:"classes",hash:{},data:n}):s))+'">\n    <a draggable="false" href="'+r((s=null!=(s=t.url||(null!=e?e.url:e))?s:a,typeof s===l?s.call(e,{name:"url",hash:{},data:n}):s))+'"'+(null!=(o=t["if"].call(e,null!=e?e.local:e,{name:"if",hash:{},fn:this.program(1,n,0),inverse:this.noop,data:n}))?o:"")+'><img src="'+r((s=null!=(s=t.favicon_url||(null!=e?e.favicon_url:e))?s:a,typeof s===l?s.call(e,{name:"favicon_url",hash:{},data:n}):s))+'"> '+r((s=null!=(s=t.title||(null!=e?e.title:e))?s:a,typeof s===l?s.call(e,{name:"title",hash:{},data:n}):s))+'</a>\n    <span draggable="false" class="control destroy">✕</span>\n</div>\n'},useData:!0}),m.templates.quicklinks["quicklinks-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div class="quicklinks-wrapper nipple-top-left">\n    <div class="pane quicklinks-pane">\n        <ol>\n            <li><a href="chrome-search://local-ntp/local-ntp.html" class="local"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyRpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoTWFjaW50b3NoKSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDozNUExQ0NERUQxMjIxMUU0QThCQkIwMDhCNEE2NDg4MyIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDozNUExQ0NERkQxMjIxMUU0QThCQkIwMDhCNEE2NDg4MyI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjM1QTFDQ0RDRDEyMjExRTRBOEJCQjAwOEI0QTY0ODgzIiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjM1QTFDQ0RERDEyMjExRTRBOEJCQjAwOEI0QTY0ODgzIi8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+9GSZXwAAAItJREFUeNrslLEOgCAMRKkOfrmDiT8MamoxlElxKmW4JhdCbuBI+o6YOXjOFJwHARBgiACrKIq4o2J5N5D0wCnn7PD5JFpyAM8moiF24HJ6O2mATS8d5xDtuoTogbceqJxa+60eeDgVmfp/PUAlsZnfwlDJMPW/MKyYWPtDYAgKQAEoQAAEcJ1bgAEAiqqzy70omloAAAAASUVORK5CYII=" class="icon-chrome-tab" > Chrome Tab</a></li>\n            <li><a href="chrome://apps" id="app-return" class="local"><i class="icon icon-th"></i> Apps</a></li>\n        </ol>\n        <div class="message connection-message"><i class="loading-icon"></i>Loading...</div>\n        <div class="error-message">Connection required to add link</div>\n        <span class="control add">+</span>\n        <ul class="message link-hint">\n            <li class="empty">\n                <span class="empty-title">Add your favorite links</span>\n                <span class="empty-description">Use the <strong><span class="icon">+</span> button</strong> above</span>\n                <span class="hide">✕</span>\n            </li>\n        </ul>\n        <div class="quicklinks-new">\n            <input id="quicklinks-new-title" class="title-input" type="text" placeholder="Title">\n            <input id="quicklinks-new-url" class="address-input" type="text" placeholder="Address">\n        </div>\n    </div>\n</div>\n<span class="quicklinks-show top-nav toggle" href="">Links</span>\n'},useData:!0}),m.templates=m.templates||{},m.templates.quote=m.templates.quote||{},m.templates.quote.quote=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<p class="quote-body">\n	<span class="quote-body-text">&ldquo;'+l((o=null!=(o=t.body||(null!=e?e.body:e))?o:s,typeof o===a?o.call(e,{name:"body",hash:{},data:n}):o))+'&rdquo;</span><i class="icon-angle-right"></i>\n	<span class="quote-source"><span class="quote-source-text">'+l((o=null!=(o=t.source||(null!=e?e.source:e))?o:s,typeof o===a?o.call(e,{name:"source",hash:{},data:n}):o))+'</span><span class="control control-heart '+l((o=null!=(o=t.fav_class||(null!=e?e.fav_class:e))?o:s,typeof o===a?o.call(e,{name:"fav_class",hash:{},data:n}):o))+'"><img src="img/icon-heart-empty.svg" class="icon icon-heart-empty"><img src="img/icon-heart.svg" class="icon icon-heart"></span><span class="control control-refresh"><img src="img/icon-refresh.svg" class="icon icon-refresh"></span><span data-url="'+l((o=null!=(o=t.twitterIntentUrl||(null!=e?e.twitterIntentUrl:e))?o:s,typeof o===a?o.call(e,{name:"twitterIntentUrl",hash:{},data:n}):o))+'" class="control control-twitter"><i class="icon icon-twitter"></i></span></span>\n</p>'},useData:!0}),m.templates=m.templates||{},m.templates.settings=m.templates.settings||{},m.templates.settings.about=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o;return'<div class="pop-body settings-about">\n	<img src="img/logo-white.png" class="about-logo">\n	<img src="icon-512.png" class="about-logo-light">\n	<h3>Momentum</h3>\n	<p class="made">Personal Dashboard <span id="momo-version">v'+this.escapeExpression((o=null!=(o=t.version||(null!=e?e.version:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"version",hash:{},data:n}):o))+'</span></p>\n	<p class="thanks">Thank you for your support!</p>\n	<p class="links">\n		<a href="http://momentumdash.com/help" target="_blank">Feedback</a>\n		<a href="http://momentumdash.com" target="_blank">Website</a>\n		<a href="https://www.facebook.com/momentumdash" target="_blank">Facebook</a>\n		<a href="https://twitter.com/momentumdash" target="_blank">Twitter</a>\n	</p>\n	<p class="footer">\n		Made with &#9829; in beautiful BC, Canada\n	</p>\n</div>'},useData:!0}),m.templates.settings["color-picker-popup"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div class="cp-color-picker nipple-bottom-right">\n    <div class="cp-xy-slider">\n        <div class="cp-white"></div>\n        <div class="cp-xy-cursor"></div>\n    </div>\n    <div class="cp-z-slider">\n        <div class="cp-z-cursor"></div>\n    </div>\n    <div class="cp-alpha-container">\n        <div class="cp-alpha">\n            <div class="cp-alpha-cursor"></div>\n        </div>\n    </div>\n</div>'},useData:!0}),m.templates.settings["color-picker"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div class="swatch-container"><div class="swatch" style="background: #222;"></div></div>'},useData:!0}),m.templates.settings.connect=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<span class="back action action-back"><i class="icon icon-angle-left"></i></span>\n\n<section class="provider">\n	<div class="provider-logo-box">\n		<img src="'+l((o=null!=(o=t.large_icon_url||(null!=e?e.large_icon_url:e))?o:s,typeof o===a?o.call(e,{name:"large_icon_url",hash:{},data:n}):o))+'" class="provider-logo">\n	</div>\n	<h2 class="provider-title">Connect to '+l((o=null!=(o=t.provider_title||(null!=e?e.provider_title:e))?o:s,typeof o===a?o.call(e,{name:"provider_title",hash:{},data:n}):o))+'</h2>\n</section>\n<!--<section class="extra-info">-->\n	<!--<label for="blah">Please enter your account name</label>-->\n	<!--<input type="text" name="blah" id="blah" class="input">-->\n<!--</section>-->\n<p class="description">A secure window will open.</p>\n<section class="button-group">\n	<span id="connect-button" class="button">Connect</span>\n	<p class="description">Momentum won\'t ever have access to your login information.</p>\n</section>\n'},useData:!0}),m.templates.settings["general-toggle-options"]=Handlebars.template({1:function(e,t,i,n){return'<span class="badge plus-badge">PLUS</span>'},3:function(e,t,i,n,o,s){var a;return null!=(a=t.unless.call(e,n&&n.last,{name:"unless",hash:{},fn:this.program(4,n,0,o,s),inverse:this.program(9,n,0,o,s),data:n}))?a:""},4:function(e,t,i,n,o,s){var a,l,r=this.lambda,d=this.escapeExpression,c=t.helperMissing,u="function";return'                <span class="toggle-option '+d(r(null!=s[2]?s[2].widget:s[2],e))+'" data-related-widget="'+d(r(null!=s[2]?s[2].widget:s[2],e))+'" data-option-value='+d((l=null!=(l=t.value||(null!=e?e.value:e))?l:c,typeof l===u?l.call(e,{name:"value",hash:{},data:n}):l))+'><div class="sub-view"></div>'+d((l=null!=(l=t.label||(null!=e?e.label:e))?l:c,typeof l===u?l.call(e,{name:"label",hash:{},data:n}):l))+"</span>"+(null!=(a=t["if"].call(e,null!=e?e.breakafter:e,{name:"if",hash:{},fn:this.program(5,n,0,o,s),inverse:this.program(7,n,0,o,s),data:n}))?a:"")+"\n"},5:function(e,t,i,n){return"<br>"},7:function(e,t,i,n){return' <span class="toggle-divider">|</span> '},9:function(e,t,i,n,o,s){var a,l=this.lambda,r=this.escapeExpression,d=t.helperMissing,c="function";return'                <span class="toggle-option '+r(l(null!=s[2]?s[2].widget:s[2],e))+'" data-related-widget="'+r(l(null!=s[2]?s[2].widget:s[2],e))+'" data-option-value='+r((a=null!=(a=t.value||(null!=e?e.value:e))?a:d,typeof a===c?a.call(e,{name:"value",hash:{},data:n}):a))+'><div class="sub-view"></div>'+r((a=null!=(a=t.label||(null!=e?e.label:e))?a:d,typeof a===c?a.call(e,{name:"label",hash:{},data:n}):a))+"</span>\n"},11:function(e,t,i,n){var o;return'<span class="option-message">'+this.escapeExpression((o=null!=(o=t.message||(null!=e?e.message:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"message",hash:{},data:n}):o))+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n,o,s){var a,l;return'<li class="slide-toggle">\n    <span class="setting-name">'+this.escapeExpression((l=null!=(l=t.name||(null!=e?e.name:e))?l:t.helperMissing,"function"==typeof l?l.call(e,{name:"name",hash:{},data:n}):l))+"</span>\n    "+(null!=(a=t["if"].call(e,null!=e?e.plusOnly:e,{name:"if",hash:{},fn:this.program(1,n,0,o,s),inverse:this.noop,data:n}))?a:"")+'\n	<span class="toggle-options">\n'+(null!=(a=t.each.call(e,null!=e?e.options:e,{name:"each",hash:{},fn:this.program(3,n,0,o,s),inverse:this.noop,data:n}))?a:"")+"    </span>\n    "+(null!=(a=t["if"].call(e,null!=e?e.message:e,{name:"if",hash:{},fn:this.program(11,n,0,o,s),inverse:this.noop,data:n}))?a:"")+'\n    <div class="option-clear"></div>\n</li>'},useData:!0,useDepths:!0}),m.templates.settings["general-toggle-slider"]=Handlebars.template({1:function(e,t,i,n){return'<span class="badge plus-badge">PLUS</span>'},3:function(e,t,i,n){return'<span class="badge beta-badge">Beta</span>'},5:function(e,t,i,n){var o;return'<span class="option-message">'+this.escapeExpression((o=null!=(o=t.message||(null!=e?e.message:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"message",hash:{},data:n}):o))+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'<li class="slide-toggle" data-related-widget="'+r((s=null!=(s=t.widget||(null!=e?e.widget:e))?s:a,typeof s===l?s.call(e,{name:"widget",hash:{},data:n}):s))+'">\n    <input type="checkbox"></input>\n    <span class="setting-name">'+r((s=null!=(s=t.name||(null!=e?e.name:e))?s:a,typeof s===l?s.call(e,{name:"name",hash:{},data:n}):s))+"</span>\n	"+(null!=(o=t["if"].call(e,null!=e?e.plusOnly:e,{name:"if",hash:{},fn:this.program(1,n,0),inverse:this.noop,data:n}))?o:"")+"\n	"+(null!=(o=t["if"].call(e,null!=e?e.beta:e,{name:"if",hash:{},fn:this.program(3,n,0),inverse:this.noop,data:n}))?o:"")+'\n	<span class="toggle-slider"><span class="toggle-switch"></span></span>\n    '+(null!=(o=t["if"].call(e,null!=e?e.message:e,{name:"if",hash:{},fn:this.program(5,n,0),inverse:this.noop,data:n}))?o:"")+"\n</li>"},useData:!0}),m.templates.settings.general=Handlebars.template({1:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'        <div class="user">\n            <nav class="user-actions">\n                <span class="action plan">Account</span><span class="action action-logout">Logout</span>\n            </nav>\n            <div class="user-avatar">\n                <div class="user-gravatar">\n                    <img src="">\n                </div>\n                <span class="badge plus-badge">PLUS</span>\n            </div>\n            <span class="name">'+l((o=null!=(o=t.displayname||(null!=e?e.displayname:e))?o:s,typeof o===a?o.call(e,{name:"displayname",hash:{},data:n}):o))+'</span><br>\n            <span class="email">'+l((o=null!=(o=t.email||(null!=e?e.email:e))?o:s,typeof o===a?o.call(e,{name:"email",hash:{},data:n}):o))+"</span>\n        </div>\n"},3:function(e,t,i,n){return'        <div class="user login">\n            <span class="name">Login</span>\n            <span class="action">Sync account and more!</span>\n        </div>\n'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s;return'<div class="pop-body">\n'+(null!=(o=t["if"].call(e,null!=e?e.loggedIn:e,{name:"if",hash:{},fn:this.program(1,n,0),inverse:this.program(3,n,0),data:n}))?o:"")+'\n    <h4>Widgets</h4>\n    <ul id="widgets-list" class="settings-list options-list"></ul>\n\n    <h4>Customize</h4>\n    <ul id="customize-list" class="settings-list options-list"></ul>\n\n    <h4>Options</h4>\n    <ul id="misc-list" class="settings-list options-list"></ul>\n\n    <h4>Account Sync</h4>\n    <ul class="settings-list options-list">\n        <li class="slide-toggle sync-option">\n            <input class="sync-check" type="checkbox"></input>\n            <span class="sync-caption">Account Sync</span>\n            <span class="toggle-slider"><span class="toggle-switch"></span></span>\n            <span class="option-message">'+this.escapeExpression((s=null!=(s=t.syncMessage||(null!=e?e.syncMessage:e))?s:t.helperMissing,"function"==typeof s?s.call(e,{name:"syncMessage",hash:{},data:n}):s))+'</span>\n        </li>\n    </ul>\n\n    <h5>Tip</h5>\n    <p class="no-top-margin">Many items in Momentum can be edited by double clicking on them, including: <strong>your name</strong>, <strong>location</strong>, <strong>clock</strong>, <strong>temperature</strong>, and <strong>todos</strong>.\n    </p>\n</div>\n'},useData:!0}),m.templates.settings.help=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div class="pop-body settings-help">\n	<h3>Help</h3>\n	<p class="description"></p>\n\n	<h5>Tips</h5>\n	<p>To change your name, toggle the temperature between C and F, change your location, or toggle the clock between 12 and 24 hour, <strong>double click</strong> on the setting you wish to change.</p>\n\n	<h5>Hotkeys</h5>\n	<p class="hotkeys">\n		<span class="col">\n			<strong>T</strong> - Todo<br>\n			<strong>F</strong> - Focus<br>\n			<strong>,</strong> - Settings<br>\n			<strong>ESC</strong> - Cancel, close\n		</span><span class="col">\n			<strong>L</strong> - Links<br>\n			<strong>S</strong> - Search<br>\n			<strong>C</strong> - Chrome Tab<br>\n		</span>\n	</p>\n	<p>\n		Press <strong>TAB</strong> twice when opening a new tab to be able to use hotkeys\n	</p>\n\n	<h5>Need more help?</h5>\n	<p>\n		Check out our Help Center<br>\n		<a href="http://momentumdash.com/help" class="button button-inline" target="_blank">Go to Help Center</a>\n	</p>\n</div>'},useData:!0}),m.templates.settings.loading=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div class="pop-body settings-loading">\n    <p class="settings-loading-loading-message"><i class="loading-icon"></i>Loading...</span></p>\n    <p class="settings-loading-error-message">We\'re having trouble loading these settings.</p>\n    <span class="button button-retry">Retry</span>\n</div>'},useData:!0}),m.templates.settings.main=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div class="pane widget-pop settings nipple-bottom-left">\n    <ul id="nav-menu" class="settings-nav border-right"></ul>\n    <div class="subpanel-container"></div>\n</div>'},useData:!0}),m.templates.settings.navmenu=Handlebars.template({1:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'    <li data-navitem="'+l((o=null!=(o=t.id||(null!=e?e.id:e))?o:s,typeof o===a?o.call(e,{name:"id",hash:{},data:n}):o))+'" class="main-nav-item">'+l((o=null!=(o=t.title||(null!=e?e.title:e))?o:s,typeof o===a?o.call(e,{name:"title",hash:{},data:n}):o))+"</li>\n"},3:function(e,t,i,n){var o;return null!=(o=t["if"].call(e,n&&n.first,{name:"if",hash:{},fn:this.program(4,n,0),inverse:this.program(6,n,0),data:n}))?o:""},4:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'        <li data-navitem="'+l((o=null!=(o=t.id||(null!=e?e.id:e))?o:s,typeof o===a?o.call(e,{name:"id",hash:{},data:n}):o))+'" class="main-nav-item secondary secondary-first">'+l((o=null!=(o=t.title||(null!=e?e.title:e))?o:s,typeof o===a?o.call(e,{name:"title",hash:{},data:n}):o))+"</li>\n"},6:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'        <li data-navitem="'+l((o=null!=(o=t.id||(null!=e?e.id:e))?o:s,typeof o===a?o.call(e,{name:"id",hash:{},data:n}):o))+'" class="main-nav-item secondary">'+l((o=null!=(o=t.title||(null!=e?e.title:e))?o:s,typeof o===a?o.call(e,{name:"title",hash:{},data:n}):o))+"</li>\n"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o;return(null!=(o=t.each.call(e,null!=e?e.navItems:e,{name:"each",hash:{},fn:this.program(1,n,0),inverse:this.noop,data:n}))?o:"")+(null!=(o=t.each.call(e,null!=e?e.secondaryNavItems:e,{name:"each",hash:{},fn:this.program(3,n,0),inverse:this.noop,data:n}))?o:"")},useData:!0}),m.templates.settings.todo=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div class="pop-body settings-todo">\n    <h3>Todo</h3>\n    <p class="description"></p>\n\n\n    <h4>Settings</h4>\n    <ul class="settings-list options-list">\n        <li class="slide-toggle on" id="remember-open-state">\n            <span class="toggle-slider"><span class="toggle-switch"></span></span>\n            Remember open state\n            <span class="option-message">Keep Todo open on new tab</span>\n        </li>\n        <li class="slide-toggle on" id="auto-focus">\n            <span class="toggle-slider"><span class="toggle-switch"></span></span>\n            Autofocus <span class="badge plus-badge">PLUS</span>\n            <span class="option-message">Automatically set top todo as your main focus</span>\n        </li>\n    </ul>\n\n\n    <h4>Sources</h4>\n\n    <div id="connected-providers"><span class="loading"><i class="loading-icon"></i>Loading...</span></div>\n    <p class="empty">No external providers connected yet. Add an integration to get started!</p>\n\n    <button class="button show-form toggle-form">Add Integration</button>\n\n    <div class="form" style="display: none;">\n    	<h4>Add Integration<i class="badge plus-badge">PLUS</i></h4>\n        <p class="description">Sync with other providers and use Todo on your mobile device</p>\n        <p class="all-connected">Congratulations, you\'re fully connected!</p>\n        <div id="available-providers"><span class="loading"><i class="loading-icon"></i>Loading...</span></div>\n        <div class="suggest-integration">\n            <h5>Looking for another integration?</h5>\n            <p><!--We\'d love to hear what other services you use.<br>-->\n                <a href="https://momentumdash.com/contact">Suggest an Integration</a></p>\n        </div>\n    </div>\n\n</div>\n<div class="pop-body settings-connect"></div>'},useData:!0}),m.templates.settings.todo_available=Handlebars.template({1:function(e,t,i,n){var o,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'        <li data-provider-id="'+r((s=null!=(s=t.id||(null!=e?e.id:e))?s:a,typeof s===l?s.call(e,{name:"id",hash:{},data:n}):s))+'" class="connect-todo"><img src="'+r((s=null!=(s=t.small_icon_url||(null!=e?e.small_icon_url:e))?s:a,typeof s===l?s.call(e,{name:"small_icon_url",hash:{},data:n}):s))+'"><span class="provider-title">'+r((s=null!=(s=t.provider_title||(null!=e?e.provider_title:e))?s:a,typeof s===l?s.call(e,{name:"provider_title",hash:{},data:n}):s))+(null!=(o=t["if"].call(e,null!=e?e.beta:e,{name:"if",hash:{},fn:this.program(2,n,0),inverse:this.noop,data:n}))?o:"")+'</span><span class="scope">'+r((s=null!=(s=t.short_description||(null!=e?e.short_description:e))?s:a,typeof s===l?s.call(e,{name:"short_description",hash:{},data:n}):s))+"</span>"+(null!=(o=t.unless.call(e,null!=e?e.active:e,{name:"unless",hash:{},fn:this.program(4,n,0),inverse:this.noop,data:n}))?o:"")+"</li>\n"},2:function(e,t,i,n){return' <span class="badge beta-badge">Beta</span>'},4:function(e,t,i,n){return'<span class="u--right status">Coming Soon</span>'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o;return'<ul class="settings-list provider-list add-provider">\n'+(null!=(o=t.each.call(e,e,{name:"each",hash:{},fn:this.program(1,n,0),inverse:this.noop,data:n}))?o:"")+"</ul>"},useData:!0}),m.templates.settings.todo_connected=Handlebars.template({1:function(e,t,i,n){var o,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'        <li data-provider-id="'+r((s=null!=(s=t.id||(null!=e?e.id:e))?s:a,typeof s===l?s.call(e,{name:"id",hash:{},data:n}):s))+'" class="has-provider-id"><img src="'+r((s=null!=(s=t.small_icon_url||(null!=e?e.small_icon_url:e))?s:a,typeof s===l?s.call(e,{name:"small_icon_url",hash:{},data:n}):s))+'">'+r((s=null!=(s=t.provider_title||(null!=e?e.provider_title:e))?s:a,typeof s===l?s.call(e,{name:"provider_title",hash:{},data:n}):s))+(null!=(o=t["if"].call(e,null!=e?e.beta:e,{name:"if",hash:{},fn:this.program(2,n,0),inverse:this.noop,data:n}))?o:"")+'<span class="scope">'+r((s=null!=(s=t.short_description||(null!=e?e.short_description:e))?s:a,typeof s===l?s.call(e,{name:"short_description",hash:{},data:n}):s))+'</span>\n            <span class="u--right">\n                <span class="provider-actions">\n                    '+(null!=(o=t["if"].call(e,null!=e?e.config_command:e,{name:"if",hash:{},fn:this.program(4,n,0),inverse:this.noop,data:n}))?o:"")+"\n                    "+(null!=(o=t.unless.call(e,null!=e?e.provider_active:e,{name:"unless",hash:{},fn:this.program(6,n,0),inverse:this.noop,data:n}))?o:"")+"\n                    "+(null!=(o=t.unless.call(e,null!=e?e.prevent_disconnect:e,{name:"unless",hash:{},fn:this.program(8,n,0),inverse:this.noop,data:n}))?o:"")+'\n                </span>\n                <span class="status">'+r((s=null!=(s=t.status||(null!=e?e.status:e))?s:a,
typeof s===l?s.call(e,{name:"status",hash:{},data:n}):s))+"</span>\n            </span>\n        </li>\n"},2:function(e,t,i,n){return' <span class="badge beta-badge">Beta</span>'},4:function(e,t,i,n){return'<span class="provider-action launch-config">Configure</span>'},6:function(e,t,i,n){return'<span class="provider-action set-active">Set Active</span>'},8:function(e,t,i,n){return'<span class="provider-action disconnect">Disconnect</span>'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o;return'<ul class="settings-list provider-list connected-providers">\n'+(null!=(o=t.each.call(e,e,{name:"each",hash:{},fn:this.program(1,n,0),inverse:this.noop,data:n}))?o:"")+"</ul>"},useData:!0}),m.templates.settings.upgrade=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o;return'<div class="hero upgrade-hero">\n	<style type="text/css">\n		.upgrade-hero { padding-bottom: 30px; border-bottom: 1px solid #444; }\n		.upgrade-hero h3 { margin-bottom: 6px; }\n		.upgrade-hero .description { margin-bottom: 15px; opacity: 0.8; }\n		.settings-upgrade .button { padding: 12px 30px; font-size: 95%; font-weight: 500; text-transform: uppercase; }\n	</style>\n\n	<h3>Momentum Plus is Here!</h3>\n	<p class="description" style="margin-bottom: 15px; opacity: 0.8;" ">Level up your focus with customization, integrations, and new widgets.</p>\n\n	<div class="login-needed">\n		<span class="login-needed-title">Please log in</span>\n		<span class="login-needed-desc">Go to <strong>General → Login</strong>, then come back and try again. Thanks!</span>\n	</div>\n\n	<span class="button button-upgrade">Get Momentum Plus</span>\n	<span class="special">Launch Special!<strong style="margin-left: 5px;"><i class="fa fa-sun-o"></i> 33% Off</strong></span>\n	<span class="price-line"><span class="price">$1.99/month</span> or <span class="price">$19.99/year</span> (equal to 2 months free!)<br></span>\n</div>\n\n\n\n<div class="feature-list">\n	<style type="text/css">\n		.feature-list { margin-top: 30px; }\n		.feature-list h4 { margin-bottom: 15px; font-size: 95%; opacity: 0.8; text-transform: uppercase; }\n		.feature-list-icon { width: 40px; margin-top: -2px; float: left; font-size: 120%; text-align: center; }\n		.feature-list-info { margin-left: 40px; margin-bottom: 20px; }\n		.feature-list-info h5 { margin: 0 0 4px; font-size: 92%; opacity: 1; }\n		.feature-list-info p { margin-top: 5px; font-size: 13px; line-height: 135%; opacity: 0.7; }\n	</style>\n\n\n\n	<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n	<div class="feature-list-info">\n		<h5>Todo Integrations</h5>\n		<p>Momentum Plus connects with your favorite task management services! See, update, and create new tasks from Trello, Todoist, Wunderlist, and Google Tasks.</p>\n	</div>\n\n\n	<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n	<div class="feature-list-info">\n		<h5>Custom Background Photos</h5>\n		<p>Light up your day every time you open a new tab. Add your own photos or choose from your favorites or past photos in Momentum.</p>\n	</div>\n\n\n	<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n	<div class="feature-list-info">\n		<h5>Personalize Font and Color</h5>\n		<p>Make Momentum your own by choosing a font and color that suits your personality. Incorporate your own style to motivate, inspire, and bring focus to your day.</p>\n	</div>\n\n\n	<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n	<div class="feature-list-info">\n		<h5>Custom Quotes</h5>\n		<p>Add your favourite quotes to maximize your inspiration. Set the quote of the day to anything you want, anytime.</p>\n	</div>\n\n\n	<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n	<div class="feature-list-info">\n		<h5>Skip Photo/Quote</h5>\n		<p>Not feeling the photo or quote of the day? No problem; a new one is just a refresh away. Cycle between five photos and five quotes per day.</p>\n	</div>\n\n\n	<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n	<div class="feature-list-info">\n		<h5>Autofocus Mode</h5>\n		<p>Set your priorities at the start of the day and Momentum will show you the one thing you need to focus on at a time. Check it off, and the next up todo becomes your focus.</p>\n	</div>\n\n\n	<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n	<div class="feature-list-info">\n		<h5>Inbox, Today, and Done Lists</h5>\n		<p>Keep your todo list clutter free with the Inbox list. Know exactly what you need to do for the day with the Today list. Follow up on what you’ve completed with the Done list.</p>\n	</div>\n\n\n	<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n	<div class="feature-list-info">\n		<h5>Priority Support</h5>\n		<p>Plus subscribers can be assured that their messages, suggestions and requests will be answered promptly by a real human. Your satisfaction is of the utmost importance to us.</p>\n	</div>\n\n\n	<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n	<div class="feature-list-info">\n		<h5>Early Access</h5>\n		<p>Get exclusive early access to exciting new Momentum features. Have a say in the direction of the product. Next early release feature: Notes.</p>\n	</div>\n\n\n	<div class="feature-list-icon"><i class="icon icon-check"></i></div>\n	<div class="feature-list-info">\n		<h5>Support Momentum</h5>\n		<p>Your subscription helps Momentum  Plus subscriptions help sustain Momentum and enable the addition of more features. Thank you for your support — we are incredibly grateful!</p>\n	</div>\n</div>\n\n\n\n<div class="cta">\n	<style type="text/css">\n		.settings-upgrade .cta { margin: 50px 0 70px; padding: 25px 10px 10px; border-top: 1px solid #444; border-bottom: 1px solid #444; text-align: center; }\n		.settings-upgrade .cta .pitch { margin: 0 0 19px; font-size: 125%; line-height: 135%; }\n		.settings-upgrade .cta .button { margin-bottom: 0; }\n		.settings-upgrade .link { margin: 3px 0 0; padding: 8px; display: inline-block; background: none !important; cursor: pointer; opacity: 0.5; text-decoration: none; -webkit-transition: all 0.1s ease; }\n		.settings-upgrade .link:hover { opacity: 0.7; }\n	</style>\n\n	<p class="pitch">Upgrade to Momentum Plus today and turn<br>your potential into progress.</p>\n\n	<div class="login-needed">\n		<span class="login-needed-title">Please log in</span>\n		<span class="login-needed-desc">Go to <strong>General → Login</strong>, then come back and try again. Thanks!</span>\n	</div>\n\n	<span class="button button-upgrade">Get Momentum Plus</span><br>\n	<a href="https://momentumdash.com/plus?'+this.escapeExpression((o=null!=(o=t.campaignDetails||(null!=e?e.campaignDetails:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"campaignDetails",hash:{},data:n}):o))+'" class="link">Learn More</a>\n</div>\n\n\n\n<div class="faq">\n	<style type="text/css">\n		.settings-upgrade .faq { margin-top: 0; padding: 0 75px; font-size: 90%; opacity: 1; }\n		.settings-upgrade .faq:first-child { margin-top: 0; }\n		.settings-upgrade .faq:last-child { margin-bottom: 10px !important; }\n\n		.settings-upgrade .faq-question { opacity: 0.9; }\n		.settings-upgrade .faq-answer { opacity: 0.7; }\n	</style>\n	<p>\n		<span class="faq-question">What are the available integrations?</span>\n		<span class="faq-answer">Currently we integrate with Wunderlist, Google Tasks, Todoist, and Fitbit. Coming soon: Trello and Asana.<!--Github, Google Analytics, Uservoice, Harvest.--></span>\n	</p>\n\n	<p>\n		<span class="faq-question">I thought Momentum was free?</span>\n		<span class="faq-answer">Momentum Free will always be free. We created Momentum Plus to bring more control and functionality to those who desire it, while still keeping the experience simple and focused.</span>\n	</p>\n</div>'},useData:!0}),m.templates.settings.whatsnew=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div class="pop-body settings-detail whatsnew">\n	<div class="settings-detail-header">\n		<h3>What\'s New</h3>\n		<p class="description">Updates from the Momentum Team</p>\n	</div>\n\n	<div class="whatsnew-body">\n		<h4>October 17</h4>\n		<p>\n			- "Last seen" now shows on the Favorites and History detail pages.\n		</p>\n\n\n		<h4>October 7</h4>\n		<p>\n			<strong>Favorites and History are here!</strong><br>\n		<p>One of the most popular suggestions that we’ve received has been the ability to view past Momentum backgrounds. With this week’s update, this is now possible.</p>\n\n		<p>On the Favorites page, you can view the backgrounds that you’ve favorited (aka “hearted”). On the History page, you can view all of the past backgrounds that have displayed on your Momentum dashboard.</p>\n\n		<p>Explore your Favorites and History pages by clicking <strong>Settings → Backgrounds</strong>.</p>\n\n		<p>Plus users can also make any favorite or past photo into their current background just as they would a custom background.</p>\n\n		<p>To learn more check out the help articles: <a href="http://help.momentumdash.com/knowledgebase/articles/1083655-backgrounds-favorites">Favorites Help</a> • <a href="http://help.momentumdash.com/knowledgebase/articles/1083682-backgrounds-history">History Help</a>.</p>\n\n\n\n		<h4>October 3</h4>\n		<p>\n			<strong>Account page, now with fewer infinite loops</strong><br>\n			The account page has gotten an overhaul and added functionality. You can now:<br>\n			- Change your personal details<br>\n			- Add multiple emails to your account<br>\n			- Manage your Plus account much more easily<br>\n			<br>\n			Find Account in Settings → General by your name, or go to <a href="http://account.momentumdash.com">http://account.momentumdash.com</a>.</p>\n\n\n\n		<h4>August 26</h4>\n		<p>\n			- Added Custom Backgrounds (Plus)<br>\n			- Disconnect integration now possible!<br>\n			- Drag and drop an image onto Momentum to add to Custom Backgrounds<br>\n			- Ongoing work with the drag and drop to reorder todo<br>\n			- Settings panels now loaded on the fly<br>\n			- Many improvements to the Settings widget\n		</p>\n\n\n\n		<h4>July 13</h4>\n		<p>\n			<strong>New on Plus: Custom Backgrounds</strong><br>\n			Curate your own quote collection. Add your favourite quotes to maximize your inspiration. Set the quote of the day to anything you want, anytime.<br>\n		</p>\n\n\n\n		<h4>July 6</h4>\n		<p>\n			<strong>New on Plus: Trello!</strong><br>\n			We\'re super excited to announce the new Trello integration! Add any Trello boards you\'d like to see in the Momentum Todo. See all the cards in each list and check off a card to move it to the next list.  To switch between lists, use the list dropdown (or left/right arrow keys). To switch quickly between boards, hold shift and use the left and right arrow keys.\n		</p>\n\n\n\n		<h4>June 3</h4>\n		<p>\n			<strong>0.90.1 Update</strong><br>\n			We continue to work toward expanding the Plus offering. With this latest update we put one more plumbing style feature in place for the Trello integration. We will launch a beta of it soon which people can join.</p>\n\n		<p>\n			- Plus signs will now work in email addresses.<br>\n			- Getting one more plumbing feature in place for the Trello integration.<br>\n			- Cleanups and bug fixes.\n		</p>\n\n\n		<h4>May 23</h4>\n		<h5 style="margin: 0; font-size: 130%; opacity: 1;">Make Momentum your own</h5>\n		<p style="margin: 2px 0; line-height: 130%; opacity: 0.6;">Favorites, Custom Themes, Skip Photo/Quote, Trello Integration, and more! (v0.90 Update)</p>\n\n		<h5 style="margin-top: 1em">Summary</h5>\n\n		<p>This exciting new update is loaded with features that enable endless personalization possibilities. <strong>Customize</strong> your dashboard with new <strong>fonts</strong> and widget <strong>colors</strong>. Save your favorite background photos and inspiring quotes with the new Favorite feature, and pass by the ones you dislike with the new <strong>Skip</strong> feature. Also, introducing our newest integration — <strong>Trello </strong> — coming next. Thank you everyone for the support!</p>\n\n		New features:<br>\n		- Favorite photos/quotes<br>\n		- Custom font and color (Plus)<br>\n		- Skip photo/quote (Plus)<br>\n		- Trello integration (Plus)<br>\n		- Many bug fixes and improvements<br>\n		- New look to notifications<br>\n		- Next focus: Two new widgets!<br>\n\n\n		<h5>A message to the Momentum Community</h5>\n\n		<p>We are super excited to announce our latest update to Momentum (v. 0.90). The Momentum team has been really busy for the past couple months bringing this update to light, and late last night (May 22) we finally got it ready to launch and began the release process.</p>\n\n		<p>One of our main focuses right now is building out the value of our Plus offering to deliver more value to our existing subscribers and build out the appeal to potential subscribers. Momentum Plus represents our path to sustainability so we can continue to build out the product without sacrificing the vision to profit incentives of investors. We are approaching an official launch for Plus with a few more major things to come. We\'re very grateful to those of you who have signed up for Plus. It supports the Momentum team and continued development of the product!</p>\n\n\n		<h5>Favorite Photos and Quotes</h5>\n\n		<p>Like the background or quote of the day? Highlight the location or quote and click the heart to favorite it. In the future we will have a way to browse your favorites to see a nice collection of your tastes.</p>\n\n\n		<h5>Personalize the look and feel of Momentum! (Plus)</h5>\n\n		<p>Make Momentum your own by choosing a font and color theme for Momentum’s widgets. Our favorite font is Modern but we\'ve added quite a few options to suit a variety of different tastes: Modern, Startup, Retro, Warehouse, and Quirky. Head over to Customize in General settings and try them out!</p>\n\n		<p>Additionally, you can significantly change the look of your dashboard by switching your widget theme color! This new feature literally provides you with the ability to let your true colors shine through your dashboard. Our lead developer Jason is in to the new Light theme, but our community manager Ben is digging the dark green. The choice is yours! :)</p>\n\n		<p>These features started as a way of freshening up Momentum internally with a new font (Modern on Mac) and a light mode. We quickly realized it was a fun way to personalize and freshen things up for everyone, so we added more fonts and the ability to set any color. We have more in mind for personalization, including a photo match mode.</p>\n\n\n		<h5>Skip Photo/Quote (Plus)</h5>\n\n		<p>Ever have those days where you\'re not quite feeling the photo or quote? Us too. With this new feature you can change the photo or quote by simply hovering your mouse over the background location or quote and then click the "Next" arrow to get a new one!\n		</p>\n\n		<p>We still love the idea of putting a limit on the number of images to prevent binge behavior and support focus, so we\'ve set a limit of 5 images per day. When skipping the last image it will cycle back to the first image of the day, so you can set it to the one you like the most and switch it up throughout the day.</p>\n\n\n		<h5>Trello integration (Plus)</h5>\n\n		<p>We\'re heavy Trello users here at Momentum, so this one is pretty exciting for us. Hook up your Trello boards and sync your cards right into Momentum. Choose the boards you want to appear in Momentum and quickly switch between them with shift+left/right arrow. Switch between lists with the left/right arrow keys. There\'s also an option to show only cards assigned to you, to quickly cut through the clutter.</p>\n\n		<p>Trello will be rolling out later this week or early next week as we complete some of the back end functionality.</p>\n\n		<h5>Many, many Todo improvements</h5>\n\n		<p>Ah yes, the classic "bug fixes and performance improvements". We\'ve done a pile of fixes, including a lot of stuff to the Todo. We also fixed the What\'s New which was stuck on an update from last month.</p>\n\n\n		<h5>New look to notifications</h5>\n\n		<p>When Momentum first launched we needed a way to tell people we were rolling out updates, and as we added things like user accounts we used that same widget to notify about new account, logging out, etc. As often happens in software, it stuck around because we were too busy with other projects. With this recent update, your notifications will now be displayed at the bottom left corner of your dashboard and will mirror your customized theming. It\'s a lot prettier than the old one. :)</p>\n\n\n		<h5>A new product</h5>\n\n		<p>With all these updates, Momentum really feels like a new product to us. And we\'re really excited for what\'s on the horizon. We couldn\'t do it without you, so thank you for your support. In our next update we will be announcing two new widgets! Stay tuned for more on those.</p>\n\n		<p>Also, if any of you are interested in a new visualization mode for the clock, message in and we\'ll send you instructions on how to enable it. It\'s in an early testing mode right now and we\'d love to get your feedback.</p>\n\n		<p>We\'d love to hear your feedback on the new update and any suggestions for the future, so please <a href="https://momentumdash.com/contact">get in touch</a>!</p>\n\n\n\n		<h4>May 18</h4>\n\n		<p>All pending account sync requests have been activated. Also, account sync will now automatically activate when enabled. Yay to instant and automatic.</p>\n\n		<p>We are putting the finishing touches on our next release which adds a lot of control and customization to the Momentum Plus experience. If you\'ve ever found yourself not too enthused about the image of the day, you can now skip it. Same for the quote. We are also adding more fonts and color themes to freshen things up and add more personalization. Oh, and this release also includes the much anticipated Trello integration!</p>\n\n		<p>Both Momentum Plus and Free will also be getting Favorite background/quote. This will open the door to a Favorites page to see your favourite backgrounds and quotes anytime!</p>\n\n		<h5>Join the Momentum Kiva team</h5>\n		<p>Did you know we have a Momentum Kiva team? <a href="https://www.kiva.org/invitedto/momentum_dash/by/levibe">Join today</a> and empower people in challenging circumstances to improve their lives!</p>\n\n\n		<h4>April 29</h4>\n\n		<h5>Todoist</h5>\n		<p>Sorting of todos now works a lot better, especially those with nested todos. Nested todos will show properly indented in the next release.</p>\n\n		<p>Delete todo is now working for Google Tasks and Wunderlist. Todoist delete still needs some work.</p>\n\n\n		<h4>April 26</h4>\n\n		<p>After much confusion, we discovered that many of the messages from our website contact form weren\'t coming through. Fixed! However, if you already sent a message and haven\'t heard a response, then we likely lost your message. :( Please reach out again and we\'ll be very happy to hear from you.</p>\n\n\n		<h4>April 25</h4>\n		<h5>Wunderlist</h5>\n		<p>Default ordering of the todos will now be the same in Momentum as in Wunderlist.</p>\n\n		<h5>Todoist</h5>\n		<p>You can now choose separate Todoist lists instead of todos all being lumped into Today.</p>\n\n\n		<h4>April 19</h4>\n		<p>Google search now goes directly to the results page on Google.com. We were using a custom feed through Google and they shut it down.</p>\n\n\n		<h4>April 15</h4>\n		<h5>Todoist & Wunderlist</h5>\n		<p>Wunderlist, Todoist, and Google Tasks now work with our autofocus/set to focus features. Sorting on Todoist needs a bit more work, due to nested tasks. More to come on that in an upcoming release.</p>\n\n		<h4>April 14</h4>\n		<p>Plus users! We have a major release for the Todo widget to announcing including an exciting new feature that has been in the works for quite some time: <strong>automatically set your todos as your main focus</strong>.</p>\n\n		<h5>Autofocus Mode</h5>\n		<p>You can now have Momentum automatically set your top ordered todo as your main focus. To enable Autofocus mode, go into Settings or click the loop icon near the settings icon in the Todo list.</p>\n\n		<p>In the morning, set up your todo list in order of priority, then throughout the day you can simply check off your Focus and your next task will fill in as your main focus. Magic! Combine autofocus with integrations and you can have end to end integration from your other todo source right into your main focus.</p>\n\n		<p>You can also manually set a todo to your focus by clicking the <span class="hotkey">•••</span> dropdown and going to "Set to focus".</p>\n\n		<h5>Hotkeys to switch between lists and todo sources (integrations)</h5>\n		<p>\n			- Use <span class="hotkey">←</span> and <span class="hotkey">→</span> keys to move between lists (e.g. Inbox to Today)<br>\n			- Use <span class="hotkey">shift</span> + <span class="hotkey">←</span> and <span class="hotkey">→</span> keys to switch between sources/integrations (e.g. Momentum Todo to Todoist)</p>\n\n		<h5>Todo completely rebuilt</h5>\n		<p>We completely revamped the Todo widget to perform much better and fix a bunch of bugs. Sorting todos (by dragging and dropping) and moving todos between lists should now work properly. The Done list will also now show headings for the days todos were completed.</p>\n\n		<h5>Did you know?</h5>\n		<p>You can quickly move a todo between your Inbox and Today lists by hovering over the todo with your mouse and pressing <span class="hotkey">space</span>? We encourage keeping your Today list short and focused, and this is a way to help you do that!</p>\n\n		<h5>Momentum Free & Plus Updates</h5>\n		<p>\n			- Responsive styling added so Momentum will shrink down better on smaller screens<br>\n			- Setting a manual weather location (double click on location) will stay set again<br>\n			- Bug where weather will sometimes show a super high temperature has been fixed<br>\n			- Many bug fixes and improvements\n		</p>\n\n		<h4>Feb 17-18</h4>\n		<p>Wunderlist and Google Tasks Todos were broken when it came to editing and checking off. Fixed!</p>\n\n		<h4>Feb 12</h4>\n		<p>So, we had a pretty bad bug that we had trouble tracking down where the focus disappeared for some people after they saved it. Well, we finally found it and fixed it! It turns out it was happening for heavy focus users, who are the people for whom we want the focus to work the best! Sorry :(</p>\n\n		<h4>Feb 10</h4>\n		<p>Hello from the Momentum team! We have added this section to share real time updates on what we have been up to at Momentum, like a changelog. Keep checking back!</p>\n\n		<h4>Feb 8</h4>\n		<p>\n			- Todoist integration will now show just Today tasks instead of a firehose of all tasks. Project lists coming soon!<br>\n			- "Awaiting authorization" no longer shows when an integration is already authorized.<br>\n			- Fixed a bug on the Contact form on the website where emails wouldn\'t send if the person had a plugin that added an extra field into the form.\n		</p>\n	</div>\n</div>'},useData:!0}),m.templates=m.templates||{},m.templates.todos=m.templates.todos||{},m.templates.todos.dropdownmenu=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o;return'<i class="control control-dropdown icon '+this.escapeExpression((o=null!=(o=t.iClassName||(null!=e?e.iClassName:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"iClassName",hash:{},data:n}):o))+'"></i>\n<ul class="dropdown"></ul>'},useData:!0}),m.templates.todos["todo-complete-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<span class="metric-stat">'+l((o=null!=(o=t.done||(null!=e?e.done:e))?o:s,typeof o===a?o.call(e,{name:"done",hash:{},data:n}):o))+'</span>\n<span class="metric-label">'+l((o=null!=(o=t.item||(null!=e?e.item:e))?o:s,typeof o===a?o.call(e,{name:"item",hash:{},data:n}):o))+" complete</span>"},useData:!0}),m.templates.todos["todo-item-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<div class="view">\n    <i class="control destroy">✕</i>\n    <i class="loading-icon"></i>\n    <i class="control error-icon">!</i>\n    <label><input class="todo-item-checkbox" type="checkbox" '+l((o=null!=(o=t.checked||(null!=e?e.checked:e))?o:s,typeof o===a?o.call(e,{name:"checked",hash:{},data:n}):o))+'></label><span class="todo-item-title">'+l((o=null!=(o=t.title||(null!=e?e.title:e))?o:s,typeof o===a?o.call(e,{name:"title",hash:{},data:n}):o))+'</span>\n</div>\n<input class="edit todo-input" type="text" value="'+l((o=null!=(o=t.title||(null!=e?e.title:e))?o:s,typeof o===a?o.call(e,{name:"title",hash:{},data:n}):o))+'">'},useData:!0}),m.templates.todos["todo-list-empty-state"]=Handlebars.template({1:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<span class="empty-link" data-target-list-id="'+l((o=null!=(o=t.targetListId||(null!=e?e.targetListId:e))?o:s,typeof o===a?o.call(e,{name:"targetListId",hash:{},data:n}):o))+'" data-use-command="'+l((o=null!=(o=t.use_command||(null!=e?e.use_command:e))?o:s,typeof o===a?o.call(e,{name:"use_command",hash:{},data:n}):o))+'">'+l((o=null!=(o=t.submessage||(null!=e?e.submessage:e))?o:s,typeof o===a?o.call(e,{name:"submessage",hash:{},data:n}):o))+"</span>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s;return'<li class="empty">\n    <div><span class="empty-title">'+this.escapeExpression((s=null!=(s=t.message||(null!=e?e.message:e))?s:t.helperMissing,"function"==typeof s?s.call(e,{name:"message",hash:{},data:n}):s))+"</span>\n    "+(null!=(o=t["if"].call(e,null!=e?e.submessage:e,{name:"if",hash:{},fn:this.program(1,n,0),inverse:this.noop,data:n}))?o:"")+"\n    </div>\n</li>"},useData:!0}),m.templates.todos["todo-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div class="pane todo-pane">\n    <div class="todo-header">\n        <ul>\n            <li><span class="todo-count"><i class="loading-icon"></i>Loading...</span></li>\n        </ul>\n        <div class="error-message">Connection required to add Todo</div>\n    </div>\n    <div class="empty empty-todo">\n        <div class="content">\n            <div class="graphic">☺</div>\n            <div class="title">Nothing to do</div>\n            <div class="description">One step at a time...</div>\n        </div>\n        <div class="action"><span class="show-completed">Completed today</span></div>\n    </div>\n    <ol class="todo-list"></ol>\n    <input id="todo-new" class="todo-input todo-new" type="text" placeholder="New Todo">\n</div>\n<span id="todo-remaining"></span>\n<span class="toggle todo-toggle">Todo</span>'},useData:!0}),m.templates.todos.todoitem=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<div class="view">\n	<div class="dropdown-container"></div>\n	<i class="loading-icon"></i>\n	<i class="control error-icon" title="Error saving click to retry">!</i>\n	<label><input class="todo-item-checkbox" type="checkbox"></label><span class="todo-item-title">'+l((o=null!=(o=t.title||(null!=e?e.title:e))?o:s,typeof o===a?o.call(e,{name:"title",hash:{},data:n}):o))+'</span>\n</div>\n<input class="edit todo-input" type="text" value="'+l((o=null!=(o=t.title||(null!=e?e.title:e))?o:s,typeof o===a?o.call(e,{name:"title",hash:{},data:n}):o))+'">'},useData:!0}),m.templates.todos.todolist=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div className="pane todo-pane" style="display:none">\n    <m.react.TodoListHeader activeProvider={this.props.activeProvider}></m.react.TodoListHeader>\n    <div className="empty empty-todo">\n        <div className="content">\n            <div className="graphic">☺</div>\n            <div className="title">Nothing to do</div>\n            <div className="description">One step at a time...</div>\n        </div>\n        <div className="action"><span className="show-completed">Completed today</span></div>\n    </div>\n    <m.react.TodoItemList selectedTodoList={selectedList} provider={this.props.activeProvider}\n                          providerStatus={this.props.activeProvider.providerStatus()}></m.react.TodoItemList>\n    <m.react.NewTodoInput selectedTodoList={selectedList}></m.react.NewTodoInput>\n    <span id="todo-remaining"></span>\n</div>'},useData:!0}),m.templates.todos.todolistactive=Handlebars.template({1:function(e,t,i,n){var o;return'<img class="todo-list-icon" src="'+this.escapeExpression((o=null!=(o=t.providerLogo||(null!=e?e.providerLogo:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"providerLogo",hash:{},data:n}):o))+'">'},3:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<i class="'+l((o=null!=(o=t.loadingClass||(null!=e?e.loadingClass:e))?o:s,typeof o===a?o.call(e,{name:"loadingClass",hash:{},data:n}):o))+'"></i> '+l((o=null!=(o=t.loadingMessage||(null!=e?e.loadingMessage:e))?o:s,typeof o===a?o.call(e,{name:"loadingMessage",hash:{},data:n}):o))},5:function(e,t,i,n){var o;return this.escapeExpression((o=null!=(o=t.remaining||(null!=e?e.remaining:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"remaining",hash:{},data:n}):o))},7:function(e,t,i,n){var o;return'<div class="message todo-message"><span class="message-title">'+this.escapeExpression((o=null!=(o=t.statusMessage||(null!=e?e.statusMessage:e))?o:t.helperMissing,"function"==typeof o?o.call(e,{name:"statusMessage",hash:{},data:n}):o))+"</span>"},9:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<span class="message-action" id="status-action" data-action="'+l((o=null!=(o=t.action||(null!=e?e.action:e))?o:s,typeof o===a?o.call(e,{name:"action",hash:{},data:n}):o))+'">'+l((o=null!=(o=t.actionMessage||(null!=e?e.actionMessage:e))?o:s,typeof o===a?o.call(e,{name:"actionMessage",hash:{},data:n}):o))+"</span></div>"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s;return"<li>\n    <!-- no spaces between the elements below for a reason -->\n    "+(null!=(o=t["if"].call(e,null!=e?e.providerLogo:e,{name:"if",hash:{},fn:this.program(1,n,0),inverse:this.noop,data:n}))?o:"")+'<span class="todo-list-name">'+this.escapeExpression((s=null!=(s=t.listTitle||(null!=e?e.listTitle:e))?s:t.helperMissing,"function"==typeof s?s.call(e,{name:"listTitle",hash:{},data:n}):s))+'</span><i class="icon icon-angle-down" aria-hidden="true"></i><span class="todo-count active-todo-count">'+(null!=(o=t["if"].call(e,null!=e?e.loadingClass:e,{name:"if",hash:{},fn:this.program(3,n,0),inverse:this.program(5,n,0),data:n}))?o:"")+'</span>\n    <div class="todo-controls"><i class="control control-autofocus icon icon-loop" title="Automatically set top todo as focus"><!--<span class="tooltip">Autofocus</span>--></i><div class="dropdown-container" id="todo-top-menu"></div></div>\n</li>\n'+(null!=(o=t["if"].call(e,null!=e?e.statusMessage:e,{name:"if",hash:{},fn:this.program(7,n,0),inverse:this.noop,data:n}))?o:"")+" "+(null!=(o=t["if"].call(e,null!=e?e.actionMessage:e,{name:"if",hash:{},fn:this.program(9,n,0),inverse:this.noop,data:n}))?o:"")},useData:!0}),m.templates.todos.todolistchoice=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<li class="todo-list-choice" data-list-id="'+l((o=null!=(o=t.listId||(null!=e?e.listId:e))?o:s,typeof o===a?o.call(e,{name:"listId",hash:{},data:n}):o))+'">\n    <span class="todo-list-name">'+l((o=null!=(o=t.title||(null!=e?e.title:e))?o:s,typeof o===a?o.call(e,{name:"title",hash:{},data:n}):o))+'</span>\n    <span class="todo-count">'+l((o=null!=(o=t.count||(null!=e?e.count:e))?o:s,
typeof o===a?o.call(e,{name:"count",hash:{},data:n}):o))+"</span>\n</li>\n"},useData:!0}),m.templates.todos.todopane=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){return'<div class="todo-pane-container nipple-bottom-right">\n	<div class="pane todo-pane">\n		<div class="todo-header">\n			<ul class="todo-list-chooser todo-list-active">\n				<li><span class="todo-list-name"></span><span class="todo-count active-todo-count"><i class="loading-icon"></i> Loading...</span>\n				</li>\n			</ul>\n			<ul class="todo-list-chooser todo-list-chooser-dropdown" style="display: none"></ul>\n		</div>\n		<ol class="todo-list"></ol>\n		<input id="todo-new" class="todo-input todo-new" type="text" placeholder="New Todo"/>\n	</div>\n</div>\n<span class="toggle todo-toggle">Todo</span></div>'},useData:!0}),m.templates=m.templates||{},m.templates.weather=m.templates.weather||{},m.templates.weather.weather=Handlebars.template({1:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'        <span class="icon icon-weather" data-icon="'+l((o=null!=(o=t.code||(null!=e?e.code:e))?o:s,typeof o===a?o.call(e,{name:"code",hash:{},data:n}):o))+'" title="'+l((o=null!=(o=t.condition||(null!=e?e.condition:e))?o:s,typeof o===a?o.call(e,{name:"condition",hash:{},data:n}):o))+'"></span><span class="metric-stat-number">'+l((o=null!=(o=t.temperature||(null!=e?e.temperature:e))?o:s,typeof o===a?o.call(e,{name:"temperature",hash:{},data:n}):o))+'</span><span class="weather-degree">&deg;</span><span class="unit '+l((o=null!=(o=t.unitClass||(null!=e?e.unitClass:e))?o:s,typeof o===a?o.call(e,{name:"unitClass",hash:{},data:n}):o))+'">'+l((o=null!=(o=t.unit||(null!=e?e.unit:e))?o:s,typeof o===a?o.call(e,{name:"unit",hash:{},data:n}):o))+"</span>\n"},3:function(e,t,i,n){return"        N/A\n"},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s,a=t.helperMissing,l="function",r=this.escapeExpression;return'<div class="metric-stat">\n'+(null!=(o=t["if"].call(e,null!=e?e.temperature:e,{name:"if",hash:{},fn:this.program(1,n,0),inverse:this.program(3,n,0),data:n}))?o:"")+'</div>\n<span class="location metric-label data">'+r((s=null!=(s=t.location||(null!=e?e.location:e))?s:a,typeof s===l?s.call(e,{name:"location",hash:{},data:n}):s))+'</span>\n<span class="metric-message">'+r((s=null!=(s=t.message||(null!=e?e.message:e))?s:a,typeof s===l?s.call(e,{name:"message",hash:{},data:n}):s))+"</span>"},useData:!0}),m.templates=m.templates||{},m.templates.widgetmanager=m.templates.widgetmanager||{},m.templates.widgetmanager.metric=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<div class="view">\n	<div class="primary">\n		<div class="metric-stat">\n			<span class="metric-stat-number">'+l((o=null!=(o=t.metricValue||(null!=e?e.metricValue:e))?o:s,typeof o===a?o.call(e,{name:"metricValue",hash:{},data:n}):o))+'</span><span class="metric-stat-unit">'+l((o=null!=(o=t.metricUnit||(null!=e?e.metricUnit:e))?o:s,typeof o===a?o.call(e,{name:"metricUnit",hash:{},data:n}):o))+'</span>\n		</div>\n		<span class="metric-label">'+l((o=null!=(o=t.metricLabel||(null!=e?e.metricLabel:e))?o:s,typeof o===a?o.call(e,{name:"metricLabel",hash:{},data:n}):o))+'</span>\n	</div>\n	<span class="metric-message"></span>\n</div>'},useData:!0}),m.templates.widgetmanager.pane=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,i,n){var o,s=t.helperMissing,a="function",l=this.escapeExpression;return'<div class="pane pane-placeholder">\n    <div class="pane-placeholder-loading"><i class="loading-icon"></i>Loading...</div>\n</div>\n<span class="toggle '+l((o=null!=(o=t.label||(null!=e?e.label:e))?o:s,typeof o===a?o.call(e,{name:"label",hash:{},data:n}):o))+'-toggle">'+l((o=null!=(o=t.label||(null!=e?e.label:e))?o:s,typeof o===a?o.call(e,{name:"label",hash:{},data:n}):o))+"</span>"},useData:!0});var c=console;m.globals.version="0.91.6",m.globals.platform="chrome",m.globals.googleAnalyticsCode="UA-44319322-10",m.globals.urlRoot="https://api.momentumdash.com/",m.globals.urlRootApi="https://api.momentumdash.com/",m.globals.urlRootLogin="https://login.momentumdash.com/",m.globals.urlRootStats="https://stats.momentumdash.com/",m.globals.urlRootIntegration="https://integration.momentumdash.com/",m.sendEvent=function(e,t,i){e&&t&&i?ga("send","event",e,t,i):e&&t?ga("send","event",e,t):e&&ga("send","event",e)},m.models.Addin=Backbone.Model.extend({defaults:{evaluated:!1,processed:!1,lazy:!1}}),m.collect.AddinCollection=Backbone.Collection.extend({model:m.models.Addin}),m.models.AddinManager=Backbone.Model.extend({initialize:function(){var e=this;this.addinCollection=new m.collect.AddinCollection,setTimeout(function(){e.loadFromAddinObject(!0)},50)},loadEvaluatedAddin:function(e,t){this.addinCollection.add({id:e,evaluated:!0,addInCode:t})},loadAddin:function(e){this.addinCollection.add({rawCode:e})},loadFromAddinObject:function(e){var t=this;_.each(m.addins,function(e,i){var n=t.addinCollection.findWhere({id:i});n||t.loadEvaluatedAddin(i,e)}),e&&this.processPending()},registerAddinLocalSource:function(e,t){this.addinCollection.findWhere({id:e})||this.addinCollection.add({id:e,path:t})},ensureAddinLoaded:function(id,success,loading,error){var addin=this.addinCollection.get(id);if(addin&&addin.get("loaded"))return void(success&&success(addin));if(loading)try{loading()}catch(e){}if(addin||(addin=this.addinCollection.add({id:id,evaluated:!1,processed:!0,lazy:!0})),!addin.get("loading")){addin.set("loading",!0);var url="",dataType="text",path=addin.get("path");path?(dataType="script",url=path):url=m.globals.urlRootApi+"scripts/"+id,$.ajax({url:url,cache:!0,beforeSend:m.utils.setMomentumAuthHeader,dataType:dataType,success:function(text){try{"text"==dataType&&eval(text),addin.set({evaluated:!0,rawCode:text,loaded:!0,loading:!1})}catch(e){if(addin.set("loading",!1),error)return void error(e)}success&&success(addin)},error:function(e){addin.set("loading",!1),error&&error(e)}})}},refresh:function(){this.loadFromAddinObject(!0)},processPending:function(){this.evaluatePending(),_.each(this.addinCollection.where({evaluated:!0,processed:!1,lazy:!1}),function(e){try{var t=e.get("addInCode");t&&(t(m,$),e.set({processed:!0}))}catch(i){console.log(i)}})},evaluatePending:function(){_.each(this.addinCollection.where({evaluated:!1,lazy:!1}),function(addin){try{var rawCode=addin.get("rawCode");if(rawCode){var addIn=eval(rawCode);addin.set({evaluated:!0,addInCode:addIn})}}catch(e){console.log(e)}})}}),m.models.Command=Backbone.Model.extend({defaults:{id:null},getId:function(){return this.id},execute:function(){},canExecute:function(){return!0}}),m.CommandManager=Backbone.Collection.extend({model:m.models.Command,initialize:function(){var e=this;this.commandSources=new Backbone.Collection,m.commands&&_.mapObject(m.commands,function(t){e.registerCommandModel(t,!1)})},registerCommandModel:function(e,t){var i=new e;if(i&&i.id&&(t||!this.get(i.id))){var n=this.get(i.id);n&&this.remove(n),this.add(i)}},registerCommandSources:function(e){e&&e.length>0&&_.each(e,this.registerCommandSource,this)},registerCommandSource:function(e){if(!e.id)throw new Error("An id property is required in cmdSrc");if(!e.addin)throw new Error("An addin property is required in cmdSrc");this.commandSources.findWhere({id:e.id})||this.commandSources.add({id:e.id,addin:e.addin})},registerCommand:function(e,t,i,n){var o={defaults:{id:e},execute:t};i&&(o.canExecute=i);var s=m.models.Command.extend(o);this.registerCommandModel(s,n)},getCommand:function(e){return e?this.get(e):null},ensureCommandLoaded:function(e,t,i,n){var o=this,s=this.get(e);if(s)return void(t&&t(s));if(i)try{i()}catch(a){}var l=this.commandSources.get(e);l?l.get("loading")||(l.set("loading",!0),m.addinManager.ensureAddinLoaded(l.get("addin"),function(){l.set("loading",!1),l.set("loaded",!0),t&&t(s)},i,function(e){l.set("loading",!1),n&&n(e)})):(url=m.globals.urlRootApi+"commands/"+encodeURIComponent(e),$.ajax({url:url,beforeSend:m.utils.setMomentumAuthHeader,success:function(a){a&&(o.registerCommandSource(a),l=o.commandSources.get(e),l?l.get("loading")||(l.set("loading",!0),m.addinManager.ensureAddinLoaded(l.get("addin"),function(){l.set("loading",!1),l.set("loaded",!0),t&&t(s)},i,function(e){l.set("loading",!1),n&&n(e)})):n&&n("no command with that id is registered"))},error:function(e){n&&n("no command with that id is registered")}}))},execute:function(e){var t=this.getCommand(e);return t?t.execute.apply(t,[].slice.call(arguments,1)):void 0},canExecute:function(e){var t=this.getCommand(e);return t?t.canExecute.apply(t,[].slice.call(arguments,1)):!0}}),m.models.SettingsManager=Backbone.Model.extend({initialize:function(){this.listenTo(m,"settings:register:nav",this.registerNavItem),this.listenTo(m,"settings:register:subnav",this.registerSubNavItem),this.listenTo(m,"settings:register:panel",this.registerPanel),this.registerStockCommandSources()},stockNavItems:null,navItems:[],secondaryNavItems:[],panelItems:[],registerNavItem:function(e){return this.stockNavItems||this.populateStockNavItems(),this.addOrReplaceIfOverride(this.navItems,e)?!1:this.addOrReplaceIfOverride(this.stockNavItems.navItems,e)?!1:(this.navItems.push(e),!0)},registerPanel:function(e){return this.addOrReplaceIfOverride(this.panelItems,e)?!1:(this.panelItems.push(e),!0)},registerSubNavItem:function(e){return this.stockNavItems||this.populateStockNavItems(),this.addOrReplaceIfOverride(this.secondaryNavItems,e)?!1:this.addOrReplaceIfOverride(this.stockNavItems.secondaryNavItems,e)?!1:(this.secondaryNavItems.push(e),!0)},addOrReplaceIfOverride:function(e,t,i){var n=i||{id:t.id},o=_.findWhere(e,n);return o?t.override?(e.splice(e.indexOf(o),1),e.push(t),!0):!0:!1},registerNavItems:function(e){var t=this,i=!1;e&&(e.nav&&_.each(e.nav,function(e){t.registerNavItem(e)&&(i=!0)}),e.subNav&&_.each(e.subNav,function(e){t.registerSubNavItem(e)&&(i=!0)}),e.panels&&_.each(e.panels,function(e){t.registerPanel(e)}),i&&this.trigger("navItemsChanged"))},getNavItems:function(){this.populateStockNavItems();var e=_.chain(this.stockNavItems.navItems).union(this.navItems).sortBy("position").value(),t=_.chain(this.stockNavItems.secondaryNavItems).union(this.secondaryNavItems).sortBy("position").value();return{navItems:e,secondaryNavItems:t}},getPanelItems:function(){return this.panelItems},registerStockCommandSources:function(){m.commandManager.registerCommandSources([{id:"settings.panels.quotes",addin:"DD106F35-669C-4079-A9E3-82DDC5244D0B"},{id:"settings.panels.backgrounds",addin:"D52F5584-5033-4A16-866F-E97C7D7AC826"},{id:"settings.panels.metrics",addin:"DB0B33AA-8ED6-4FFC-B0E0-732A9FF3391D"},{id:"background.custom.uploadfiles",addin:"D52F5584-5033-4A16-866F-E97C7D7AC826"},{id:"tour.plus.show",addin:"E38E9785-27CE-4CAB-8497-8B34AB56B6A1"},{id:"settings.panels.trello.config",addin:"C61B7775-7AB8-443A-A6B7-C8C8DE6FC755"}]),this.registerPanel({id:"trello",section:"todo",cmd:"settings.panels.trello.config"})},populateStockNavItems:function(){if(!this.stockNavItems){var e=[],t=[];m.conditionalFeatures.featureEnabled("plus")?(e=[{id:"general",title:"General",position:10},{id:"todo",title:"Todo",position:20},{id:"metrics",title:"Metrics",cmd:"settings.panels.metrics",position:30},{id:"background-settings",title:"Backgrounds",cmd:"settings.panels.backgrounds",position:36},{id:"quote-settings",title:"Quotes",cmd:"settings.panels.quotes",position:40}],t=[{id:"help",title:"Help",position:10},{id:"whatsnew",title:"What's New",position:20},{id:"about",title:"About",position:30},{id:"tour",title:"Plus Intro",cmd:"tour.plus.show",cmdonly:!0,hide:!0,position:40}]):(e=[{id:"general",title:"General",position:10},{id:"todo",title:"Todo",position:20},{id:"background-settings",title:"Backgrounds",cmd:"settings.panels.backgrounds",position:36},{id:"quote-settings",title:"Quotes",cmd:"settings.panels.quotes",position:40}],t=[{id:"help",title:"Help",position:10},{id:"whatsnew",title:"What's New",position:20},{id:"about",title:"About",position:30},{id:"upgrade",title:"Upgrade to Plus",options:{source:"nav-upgrade-plus"},position:40}]),this.stockNavItems={navItems:e,secondaryNavItems:t}}},infinispin:function(){var e=localStorage.getItem("infinispin");return e=e?JSON.parse(e):!1},toggleInfinispin:function(){var e=!this.infinispin();return localStorage.setItem("infinispin",e),e}}),m.models.ThemeManager=Backbone.Model.extend({initialize:function(){},defaultFontFamily:'"Helvetica Neue",Helvetica,Arial,sans-serif',initializeThemes:function(){this.listenTo(m.models.customization,"change:themeColour",this.setThemeColour),this.listenTo(m.models.customization,"change:themeFont",this.setThemeFont),this.loadThemeColour(),this.setThemeColour(),this.setThemeFont()},setColorValues:function(e,t){this.colors=t,this.setThemeColour()},saveThemeColour:function(){this.colors&&m.models.customization.set("themeColourCustom",this.toRgbA(this.colors))},loadThemeColour:function(){try{if(m.models.customization.has("themeColourCustom")){var e=m.models.customization.get("themeColourCustom");e&&(this.colors=new Colors({color:e}).colors)}}catch(t){}},getThemeColour:function(){return this.colors},getThemeColourRGBA:function(){return this.colors?this.toRgbA(this.colors):null},setThemeColour:function(){if(m.conditionalFeatures.featureEnabled("plus")){var e=m.models.customization.get("themeColour");if("light"==e)$("body").addClass("light"),this.$themeColourCustom&&(this.$themeColourCustom.remove(),this.$themeColourCustom=null);else if("dark"==e)$("body").removeClass("light"),this.$themeColourCustom&&(this.$themeColourCustom.remove(),this.$themeColourCustom=null);else if("custom"==e)if(this.colors){var t=".pane, .widget-bg { background-color: "+this.toRgbA(this.colors)+" !important; }";t=t+".dropdown, .todo-list-chooser-dropdown { background-color: #"+this.colors.HEX+" !important; }",t=t+".nipple-bottom-left:before, .nipple-bottom-right:before { border-top-color: "+this.toRgbA(this.colors)+" !important}",t=t+".nipple-top-left:before, .nipple-top-right:before { border-bottom-color: "+this.toRgbA(this.colors)+" !important}",this.$themeColourCustom?$(this.$themeColourCustom).html(t):($("head").append('<style type="text/css" id="themeColourCustom">'+t+"</style>"),this.$themeColourCustom=$("head").find("#themeColourCustom").first()),this.colors.RGBLuminance>.5?$("body").addClass("light"):$("body").removeClass("light")}else $("body").removeClass("light")}else $("body").removeClass("light"),this.$themeColourCustom&&(this.$themeColourCustom.remove(),this.$themeColourCustom=null)},toRgbA:function(e){return"rgba("+Math.round(255*e.rgb.r)+","+Math.round(255*e.rgb.g)+","+Math.round(255*e.rgb.b)+","+e.alpha+")"},getAvailableFonts:function(){return[{label:"Classic",value:"default"},{label:"Modern",value:"modern"},{label:"Startup",value:"startup",breakafter:!0},{label:"Retro",value:"retro"},{label:"Warehouse",value:"warehouse"},{label:"Quirky",value:"quirky"}]},setThemeFont:function(){var e=this;if(m.conditionalFeatures.featureEnabled("plus")){var t=m.models.customization.get("themeFont"),i=this.defaultFontFamily;if(t&&"default"!=t){var n=null,o=localStorage.getItem("font-"+t);if(o)n=JSON.parse(o),i=this.setFontFromInfo(n)||this.defaultFontFamily,this.setActiveFont(i);else try{$.ajax({type:"GET",beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"fonts/"+t}).done(function(n){n&&(localStorage.setItem("font-"+t,JSON.stringify(n)),i=e.setFontFromInfo(n)||e.defaultFontFamily)}).fail(function(e,t){}).always(function(){e.setActiveFont(i)})}catch(s){}}else this.setActiveFont(i)}else this.setActiveFont(this.defaultFontFamily)},setFontFromInfo:function(e){var t=null;if(e){if(!e.builtin){var i=$("head"),n=i.find("#font-"+e.font).first();if(!n||0==n.length){var o=null;e.fontInline?(o=$('<style type="text/css"></style>'),o.html(e.fontInline)):e.fontUrl&&(o=$('<link rel="stylesheet" type="text/css">'),o.attr("href",e.fontUrl)),o&&(o.attr("id","font-"+e.font),i.append(o))}}t=e.exclude_default?e.fontFamily:e.fontFamily+","+this.defaultFontFamily}return t},setActiveFont:function(e){var t="body, input, select, textarea, button",i=t+" {font-family: "+e+"; !important}",n=document.createElement("style"),o=$(n);o.attr("type","text/css"),document.head.appendChild(n);var s=n.sheet;s.insertRule(i,0),o.attr("id","font-override")}}),m.models.SyncCoordinator=Backbone.Model.extend({initialize:function(){this.syncSettingsInProgress=!1,this.listenTo(m,"sync:download",this.doDownload),this.listenTo(m,"client:id_created",this.onClientIdCreated),this.listenTo(m,"user:successfulLogin",this.onUserLogin),this.listenTo(m,"user:successfulLogout",this.syncSettings),this.listenTo(m,"sync:downloadIfNeeded",this.doDownloadIfNeeded),this.listenTo(m.models.customization,"change",this.customizationChange),this.listenTo(m,"sync:customization",this.customizationChange),m.models.customization.get("etag")||this.customizationChange()},onUserLogin:function(e){this.doDownload(),this.syncSettings(e)},doDownload:function(e){try{var t=this;if(!localStorage.client_uuid)return;var i=m.globals.urlRootApi+"feed/bulk?syncTypes=";if(e){var n=[];e.indexOf("quote")>-1&&(n[n.length]="quote",localStorage.removeItem(t.ddlQuoteString())),e.indexOf("background")>-1&&(n[n.length]="background",localStorage.removeItem(t.ddlBackgroundString())),i+=n.length>0?n.join(","):"all"}else i+="all",localStorage.removeItem(t.ddlBackgroundString()),localStorage.removeItem(t.ddlQuoteString());if(i=i+"&localDate="+getActiveDateString(),!localStorage.firstSynchronized){var o=m.models.activeBackground.activeBackgroundUuid();if(!o){var s=m.collect.legacyBackgrounds.getCurrentLocalBackground();s&&(o=s.backgroundUuid())}o&&(i=i+"&legacyBackground="+o)}$.ajax({type:"GET",contentType:"application/json",beforeSend:setMomentumAuthHeader,url:i}).done(function(e){e.quotes&&e.quotes.length>0&&(m.collect.quotes.reset(e.quotes),m.collect.quotes.invoke("save"),localStorage.shortquote&&localStorage.removeItem("shortquote"),localStorage.setItem(t.ddlQuoteString(),Date.now()),e.ts_quotes&&localStorage.setItem("ts_quotes",JSON.stringify(e.ts_quotes))),e.backgrounds&&e.backgrounds.length>0&&(m.collect.backgrounds.reset(e.backgrounds),m.collect.backgrounds.invoke("save"),localStorage.background&&(localStorage.removeItem("background"),localStorage.removeItem("backgrounds")),localStorage.setItem(t.ddlBackgroundString(),Date.now()),e.ts_backgrounds&&localStorage.setItem("ts_backgrounds",JSON.stringify(e.ts_backgrounds))),localStorage.setItem("firstSynchronized",Date.now())}).fail(function(e,i){if(e.status>0){var n=m.models.backgroundManager.latestBackgroundDate();n&&n>Date.parse(getActiveDateString())&&localStorage.setItem(t.ddlBackgroundString(),Date.now());var o=m.models.quoteManager.latestQuoteDate();o&&o>Date.parse(getActiveDateString())&&localStorage.setItem(t.ddlQuoteString(),Date.now())}})}catch(a){}},doDownloadIfNeeded:function(e){var t=!1,i=!1;if(e){if(e.ts_backgrounds){var n=localStorage.getItem("ts_backgrounds");n?e.ts_backgrounds>JSON.parse(n)&&(t=!0):t=!0}if(e.ts_quotes){var o=localStorage.getItem("ts_quotes");o?e.ts_quotes>JSON.parse(o)&&(i=!0):i=!0}}t||localStorage[this.ddlBackgroundString()]||(t=!0),i||localStorage[this.ddlQuoteString()]||(i=!0),t&&i?this.doDownload():t?this.doDownload("background"):i&&this.doDownload("quote")},pingApi:function(e,t){$.ajax({type:"GET",contentType:"application/json",url:m.globals.urlRootApi}).done(function(t){e&&e()}).fail(function(e,i){t&&t()})},ddlBackgroundString:function(){return"ddl-bg-"+getActiveDateString()},ddlQuoteString:function(){return"ddl-qt-"+getActiveDateString()},onClientIdCreated:function(){this.doDownload(),this.syncSettings()},setSyncSettingsHeaders:function(e){m.utils.setMomentumAuthHeader(e);var t=m.models.customization.get("etag");t&&e.setRequestHeader("X-Momentum-Settings-ETag",t)},customizationChange:function(e){if(!this.syncSettingsInProgress&&!m.models.customization.fetching&&m.conditionalFeatures.featureEnabled("serversettings")){if(e){var t=e.changedAttributes();if(1===Object.keys(t).length&&_.contains(Object.keys(t),"etag"))return}else if(m.models.customization.get("etag"))return;$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(m.models.customization),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"settings"}).done(function(e){e.etag&&m.models.customization.save({etag:e.etag})}).fail(function(e,t){}).always(function(){})}},submitFeatureAccessRequest:function(e,t,i){var n={feature:e};$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(n),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"user/featurerequest"}).done(function(e){t&&t()}).fail(function(e,t){i&&i()})},syncSettings:function(e){if(localStorage.client_uuid){this.syncSettingsInProgress=!0;var t=this;$.ajax({type:"GET",contentType:"application/json",beforeSend:this.setSyncSettingsHeaders,url:m.globals.urlRootApi+"settings"}).done(function(e){if(e){e.greetings&&(localStorage.greetings=e.greetings),e.features&&m.conditionalFeatures.setFeatures(e.features),e.customization&&m.models.customization.save(e.customization),e.lists&&e.lists.length>0&&m.models.todoListManager&&m.models.todoListManager.mergeLists(e.lists),m.commandManager.execute("addins.load",e.addIns),m.commandManager.registerCommandSources(e.cmd),m.settingsManager.registerNavItems(e.nav),e.download&&m.trigger("sync:download",e.download),e.ts_notifications&&m.trigger("notifications:timestamp",e.ts_notifications);var t=null;e.ts_backgrounds&&(t=t||{},t.ts_backgrounds=e.ts_backgrounds),e.ts_quotes&&(t=t||{},t.ts_quotes=e.ts_quotes),t&&m.trigger("sync:downloadIfNeeded",t)}}).fail(function(e,t){}).always(function(){t.syncSettingsInProgress=!1}).always(function(){e&&e()})}}}),m.models.ConditionalFeatures=Backbone.Model.extend({initialize:function(){try{localStorage.f3t6b23d?this.featureList=JSON.parse(atob(localStorage.f3t6b23d)):this.featureList=[]}catch(e){this.featureList=[]}},featureEnabled:function(e){return _.contains(this.featureList,e)},setFeatures:function(e){localStorage.f3t6b23d!==e&&(localStorage.f3t6b23d=e,this.featureList=JSON.parse(atob(e)),m.trigger("feature:changed"))},clearFeatures:function(){this.featureList=[],localStorage.removeItem("f3t6b23d")},checkFeatureAndMigrateData:function(e,t,i,n,o,s){var a=null;if(this.featureEnabled(e)){for(var l=!1,r=0;r<localStorage.length;r++)if(keyName=localStorage.key(r),0===keyName.indexOf(i+"-")){var l=!0;break}if(l)try{for(var d=new Date,c=d.getFullYear().toString()+"-"+twoDigit(d.getMonth()+1)+"-"+twoDigit(d.getDate())+"-"+twoDigit(d.getHours())+":"+twoDigit(d.getMinutes())+":"+twoDigit(d.getSeconds()),u="migrated-"+i+"-"+c,h=[],g=[],r=0;r<localStorage.length;r++)if(keyName=localStorage.key(r),0===keyName.indexOf(i+"-")){g.push(keyName);var p=localStorage.getItem(keyName);if(p){var f=JSON.parse(p);h.push(f)}}var v={items:h},w=JSON.stringify(v);$.ajax({type:"POST",contentType:"application/json",data:w,beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"migrate/"+i}).done(function(e,o,s){localStorage.setItem(u,w);for(var a in g)localStorage.removeItem(g[a]);localStorage.removeItem(i),m.trigger("sync:customization"),(!t||m.models.customization.get(t))&&n()}).fail(function(e,i){(!t||m.models.customization.get(t))&&o()})}catch(y){console.log(y)}else a=n}else a=o;a&&(!t||m.models.customization.get(t)?a():s&&s(a))},checkPreferenceForRender:function(e,t,i){t&&(!e||m.models.customization.get(e)?t():i&&i(t))}}),m.models.Widget=Backbone.Model.extend({}),m.collect.Widgets=Backbone.Collection.extend({model:m.models.Widget}),m.views.BasePlaceholder=Backbone.View.extend({initialize:function(){this.render()},render:function(){var e=this.model.get("region"),t=(this.model.get("order")||"append")+"To";return this.$el[t]("#"+e).fadeTo(0,0).html(this.template(model.toJSON())).fadeTo(500,1),this},attributes:function(){return{id:this.model.get("id"),"class":this.model.get("class")}},detach:function(){this.unbind(),this.stopListening(),this.undelegateEvents()}}),m.views.PanePlaceholder=m.views.BasePlaceholder.extend({template:m.templates.widgetmanager.pane,open:!1,events:{"click .toggle":"toggleShow"},initialize:function(){this.visibleStateKey=this.model.get("visibleState"),this.render(),this.shouldShowPane()&&this.toggleShow()},attributes:function(){return{id:this.model.get("id"),"class":"widget-"+this.model.get("region")}},render:function(){var e=this.model.get("region"),t=this.model.get("label"),i=(this.model.get("order")||"append")+"To",n="nipple-"+e;this.$el[i]("#"+e).fadeTo(0,0).html(this.template({label:t})).fadeTo(500,1);var o=this.$(".pane"),s=this.model.get("width")+"px",a="200px",l=this.storedPaneHeight();return l?a=l+"px":this.model.has("height")&&(a=this.model.get("height")+"px"),o.css({width:s,height:a}),o.addClass(n),this},storedPaneHeight:function(){if(this.model.has("storedHeight")){var e=this.model.get("storedHeight"),t=localStorage[e];if(t)return JSON.parse(t)}return null},toggleShow:function(e){e&&e.stopPropagation(),this.$el.toggleClass("show"),this.open=!this.open,e&&localStorage.setItem(this.visibleStateKey,this.open),this.loading||this.model.has("addin")&&(this.loading=!0,m.addinManager.ensureAddinLoaded(this.model.get("addin")))},shouldShowPane:function(){if(this.model.has("visibleState")){var e=localStorage[this.visibleStateKey];if(e)return JSON.parse(e)}return!1}}),m.views.MetricPlaceholder=m.views.BasePlaceholder.extend({template:m.templates.widgetmanager.metric,initialize:function(){var e=this;this.render(),setTimeout(function(){m.addinManager.ensureAddinLoaded(e.model.get("addin"))},25)},render:function(){var e={},t=this.model.get("cachedKey");t&&(e=JSON.parse(localStorage.getItem(t)));var i=this.model.get("region"),n=(this.model.get("order")||"append")+"To";return this.$el[n]("#"+i).fadeTo(0,0).html(this.template(e)).fadeTo(500,1),this}}),m.models.WidgetManager=Backbone.Model.extend({initialize:function(){this.widgets=m.collect.widgets=new m.collect.Widgets,this.listenTo(this.widgets,"add",this.onAdd),this.populatePlaceholders()},populatePlaceholders:function(){this.widgets.add({id:"notes",label:"Notes",region:"bottom-right",order:"prepend",storedHeight:"notes-pane-height",visibleState:"showNotes",width:400,addin:"23c67761-9831-415e-b358-c6844eb6c244",requiredFeature:"notes",visibleSetting:"notesVisible"}),this.widgets.add({type:"metric",id:"countdown","class":"metric countdown add-shadow",region:"top-right",order:"prepend",cachedKey:"current-countdown",addin:"fb230b62-96ce-44b5-87c5-4a563553038b",requiredFeature:"countdown",visibleSetting:"countdownVisible"})},onAdd:function(e){this.addWidget(e)},addWidget:function(e,t){var i=this;if(t=t||!1,!e.has("requiredFeature")||m.conditionalFeatures.featureEnabled(e.get("requiredFeature"))){if(!t&&e.has("visibleSetting")){var n=e.get("visibleSetting");if(!m.models.customization.get(n))return void this.listenToOnce(m.models.customization,"change:"+n,function(){var t=!!m.models.customization.get(n);i.addWidget(e,t)})}var o=null;o="metric"==e.get("type")?new m.views.MetricPlaceholder({model:e}):new m.views.PanePlaceholder({model:e}),e.placeholder=o}},handover:function(e,t,i){var i=i||{},n=this.widgets.find({id:e});if(n){var o=n.placeholder;o&&(i.open=o.open,i.el=o.$el,o.detach());var s=new t(i);return n.placeholder&&delete n.placeholder,n.realview=s,s}return new t(i)}}),m.models.BackgroundBase=Backbone.Model.extend({backgroundUuid:function(){var e=this.get("_id");if(e)return e;var t=this.get("filename");if(0===t.indexOf("http"))return null;var i=t.split("/");if(2==i.length){var i=i[1].split(".");if(2==i.length)return i[0]}return null}}),m.models.Background=m.models.BackgroundBase.extend({idAttribute:"forDate"}),m.models.ActiveBackground=Backbone.Model.extend({initialize:function(e,t){this.displayLogged=!1,this.backgrounds=t.backgrounds,this.legacyBackgrounds=t.legacyBackgrounds,this.listenTo(this.backgrounds,"reset",this.collectionReady),this.listenTo(this.legacyBackgrounds,"reset",this.legacyCollectionReady),this.listenTo(m,"newDay",this.handleNewDay,this),this.listenTo(this,"background:fallback",this.handleFallback,this)},handleNewDay:function(){var e=this;e.intervalId=setInterval(function(){e.backgrounds.length>0&&(e.checkActiveBackground(),clearInterval(e.intervalId))},50)},handleFallback:function(){var e=this.fallbackKey(),t=localStorage.getItem(e),i=null;t&&(i=this.legacyBackgrounds.get(t)),i||(i=this.legacyBackgrounds.getCurrentLocalBackground(),i&&localStorage.setItem(e,i.backgroundUuid())),i&&(this.usingFallback=!0,this.setActiveBackground(i))},collectionReady:function(){this.usingFallback||this.checkActiveBackground()},fallbackKey:function(){return"fallback-"+getActiveDateString()},legacyCollectionReady:function(){if(this.backgrounds.length>0){var e=this.backgrounds.get(getActiveDateString());e||this.checkActiveBackground()}else this.checkActiveBackground()},activeBackgroundUuid:function(){return this.backgroundItem?this.backgroundItem.backgroundUuid():null},checkActiveBackground:function(){var e=null;return this.backgrounds&&this.backgrounds.length>0&&(e=this.backgrounds.getActiveBackground())?void this.setActiveBackground(e):void this.trigger("background:fallback")},successfullyLoaded:function(e){this.backgroundItem.backgroundUuid()==e&&this.trigger("background:successfullyLoaded",this.backgroundItem),this.preCacheFutureBackgroundImages()},setActiveBackground:function(e){e&&(this.backgroundItem&&this.backgroundItem.cid==e.cid||(this.displayLogged=!1,this.backgroundItem=e,this.trigger("background:activechanged",e)))},generateUUID:function(){var e=(new Date).getTime(),t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?i:3&i|8).toString(16)});return t},preCacheFutureBackgroundImages:function(){var e=this,t=Date.parse(getActiveDateString());this.backgrounds&&this.backgrounds.length>0&&this.backgrounds.map(function(i){var n=Date.parse(i.get("forDate"));n>t&&e.preCacheBackgroundImage(i)})},preCacheBackgroundImage:function(e){if(e){var t=e.get("filename");if(t&&0===t.indexOf("http"))try{var i=new Image;i.addEventListener("load",function(e){i.removeEventListener("load",arguments.callee,!1)},!1),i.src=t}catch(n){}}}}),m.models.LegacyBackground=m.models.BackgroundBase.extend({parse:function(e){var t=e.id;if(!t){var i=e.filename,n=i.split("/");if(2==n.length){var n=n[1].split(".");2==n.length&&(t=n[0])}}this.set({id:t,filename:e.filename,title:e.title,source:e.source,sourceUrl:e.sourceUrl})}}),m.collect.Fallbacks=Backbone.Collection.extend({model:Backbone.Model,beforeDate:function(e){return filtered=this.filter(function(t){return t.get("fallbackDate")<e}),new m.collect.Fallbacks(filtered)}}),m.collect.Backgrounds=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("momentum-background"),model:m.models.Background,getActiveBackground:function(){if(this.length>0){var e=getActiveDateString();return this.get(e)}}}),m.collect.LegacyBackgrounds=Backbone.Collection.extend({model:m.models.LegacyBackground,url:"app/backgrounds.json",parse:function(e){return e.backgrounds},initialize:function(){localStorage.firstSynchronized||this.listenTo(this,"reset",this.initializeBackground)},initializeBackground:function(){this.getCurrentLocalBackground(),m.trigger("sync:downloadIfNeeded")},getCurrentLocalBackground:function(){if(0===this.models.length)return null;var e=null,t=m.models.activeBackground.fallbackKey(),i=localStorage.getItem(t);if(i&&(e=this.get(i)),!e){if(!this.parseRecentFallbacks())return null;var n=Math.floor(.75*this.models.length),o=this.fallbacks.sortBy(function(e){return-e.get("fallbackDate")}),s=_.first(o,n),a=_.map(s,function(e){return e.get("backgroundGuid")}),l=this.pluck("id");if(m.collect.backgrounds){var r=m.collect.backgrounds.sortBy(function(e){return-Date.parse(e.get("forDate"))});n=Math.floor(.25*this.models.length);var d=_.first(r,n),c=_.map(d,function(e){return e.get("_id");
});a=_.union(a,c)}var u=_.difference(l,a);if(u.length>0){var h=_.sample(u);e=this.get(h)}else e=this.sample()}return e},parseRecentFallbacks:function(){if(this.fallbacks)return!0;this.fallbacks=new m.collect.Fallbacks;var e=this;return $.each(localStorage,function(t,i){if(0===t.indexOf("fallback-")){var n=t.slice(9),o=Date.parse(n),s=new Backbone.Model({fallbackDate:o,backgroundGuid:i});e.fallbacks.add(s)}}),!0}}),m.models.BackgroundManager=Backbone.Model.extend({initialize:function(e,t){m.collect.backgrounds=new m.collect.Backgrounds,m.collect.legacyBackgrounds=new m.collect.LegacyBackgrounds,m.models.activeBackground=new m.models.ActiveBackground({},{backgrounds:m.collect.backgrounds,legacyBackgrounds:m.collect.legacyBackgrounds})},firstFetch:function(){m.collect.backgrounds.fetch({reset:!0}),m.collect.legacyBackgrounds.fetch({reset:!0})},skipErrorMessage:{message:"Oops! We weren't able to get a new background. Please check your connection and try again.",viewLimit:1},favouriteErrorMessage:{message:"Oops! We weren't able to save the favorite. Please check your connection and try again.",viewLimit:1},skipBackground:function(e){var t=this,i=m.globals.urlRootApi+"backgrounds",n=m.models.activeBackground.activeBackgroundUuid(),o={operation:"skip",active_uuid:n};try{$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(o),url:i}).done(function(e){e&&e.success&&m.trigger("sync:download","background"),e&&e.notification&&m.commandManager.execute("notification.show.enhanced",e.notification)}).fail(function(i,n){m.commandManager.execute("notification.show.enhanced",t.skipErrorMessage),e&&e()})}catch(s){m.commandManager.execute("notification.show.enhanced",t.skipErrorMessage),e&&e()}},toggleFavorite:function(e,t){var i=this,n=m.globals.urlRootApi+"backgrounds/favorites",o=m.models.activeBackground.activeBackgroundUuid(),s={operation:"favorite",active_uuid:o,is_favorite:e};try{$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(s),url:n}).done(function(e){e&&e.success&&(m.trigger("sync:download","background"),m.trigger("background:favorite",{id:s.active_uuid,is_favorite:s.is_favorite}))}).fail(function(e,n){m.commandManager.execute("notification.show.enhanced",i.favouriteErrorMessage),t&&t()})}catch(a){m.commandManager.execute("notification.show.enhanced",i.favouriteErrorMessage),t&&t()}},latestBackgroundDate:function(){var e=null;return m.collect.backgrounds.models.forEach(function(t){var i=Date.parse(t.id);(!e||i>e)&&(e=i)}),e}}),m.views.Background=Backbone.View.extend({tagName:"li",attributes:{},events:{click:"closeTrays"},isBackgroundLoaded:!1,initialize:function(){this.model=m.models.backgroundManager,this.listenTo(m.models.activeBackground,"background:activechanged",this.setBackground)},render:function(){this.model&&this.model.backgroundItem&&this.setBackground(this.model.backgroundItem)},setBackground:function(e){var t=this,i=4e3,n=!1;t.isBackgroundLoaded&&(n=!0);var o=e.get("filename"),s=e.backgroundUuid(),a=(e.get("title"),e.get("source"),e.get("sourceUrl"),(this.options.order||"append")+"To");$("#background").css("background-image",$("#background").find("li").css("background-image")),this.lastId=s,this.loadCompleted=!1,$("<img/>").on("load",function(){var e="fadein";t.isBackgroundLoaded&&(e="fadein-slow"),t.loadCompleted=!0,m.models.activeBackground.successfullyLoaded(s),t.isBackgroundLoaded=!0,s===t.lastId&&(t.$el[a]("#"+t.options.region).css("background-image","url("+o+")").addClass(e),$(this).remove(),$(".widgets").addClass("fadein"),$(".background-overlay").addClass("fadein")),setTimeout(function(){m.trigger("background:loadSuccessful",s)},200)}).on("error",function(e){t.loadCompleted=!0,t.isBackgroundLoaded?m.trigger("background:error",s):m.models.activeBackground.trigger("background:fallback")}).attr("src",o),n||window.setTimeout(function(){t.loadCompleted||(t.loadCompleted=!0,console.log("image fallback via timer"),m.models.activeBackground.trigger("background:fallback"))},i)},closeTrays:function(e){$(".show").each(function(){removeClass("show")})}}),m.views.BackgroundInfo=Backbone.View.extend({tagName:"div",attributes:{id:"background-info","class":"background-info"},template:m.templates.background["background-info"],events:{mouseenter:"handleHoverOn",mouseleave:"handleHoverOff",click:"clickWidget","mouseenter .control":"controlHoverOn","mouseleave .control":"controlHoverOff","click .background-info-source-link":"clickSource","click .source-url":"trackClick","click .control-heart":"toggleFavorite","click .control-refresh":"skipBackground"},initialize:function(){this.listenTo(m.models.activeBackground,"background:successfullyLoaded",this.activeBackgroundReady)},parentReady:function(e){this.isParentReady=!0,(this.isBackgroundReady||e)&&this.render()},activeBackgroundReady:function(){this.isBackgroundReady=!0,this.isParentReady&&this.render()},render:function(){m.models.activeBackground&&m.models.activeBackground.backgroundItem&&this.setBackground(m.models.activeBackground.backgroundItem)},setBackground:function(e){var t=this,i="",n=null,o="",s="",a="",l="",r=!1,d=!1;e&&(i=e.get("title"),s=e.get("sourceUrl"),a=e.get("detail_url"),n=e.get("attribution"),o=e.get("source"),n||(n="Photo by "+o),e.get("is_favorite")&&(r=!0,l="active")),this.activeBackground?this.activeBackground.backgroundUuid()!=e.backgroundUuid()?d=!0:(i!=this.activeBackground.get("title")||n!=this.activeBackground.get("attribution"))&&(d=!0):d=!0,d&&(this.activeBackground=e),a&&a.length>0?(this.detail_url=a,this.$el.addClass("has-link")):(this.detail_url=null,this.$el.removeClass("has-link"));var c={title:i,source:o,sourceUrl:s,attribution:n,fav_class:l};if(this.renderedOnce)d&&this.$el.fadeTo(500,0,function(){t.$background_info_title.html(i+'<i class="icon-angle-right"></i>'),t.$background_info_source_link.text(n),t.$el.fadeTo(500,1)});else{var u=(this.options.order||"append")+"To";this.$el[u]("#"+this.options.region).fadeTo(0,0).html(this.template(c)).fadeTo(500,1),this.$background_info_source_link=this.$el.find(".background-info-source-link").first(),this.$background_info_title=this.$el.find(".background-info-title").first(),this.$control_heart=this.$el.find(".control-heart").first(),this.$control_refresh=this.$el.find(".control-refresh").first(),this.renderedOnce=!0}return s&&s.length>0?(this.$background_info_source_link.data("url",s),this.$background_info_source_link.removeClass("no-link")):(this.$background_info_source_link.data("url",null),this.$background_info_source_link.addClass("no-link")),this.$control_refresh.removeClass("active"),m.conditionalFeatures.featureEnabled("skip-bg")?this.$control_refresh.show():this.$control_refresh.hide(),this.$control_heart.show(),r?this.$control_heart.addClass("active"):this.$control_heart.removeClass("active"),this},handleHoverOn:function(){var e=this;setTimeout(function(){$(e.$el).find(".background-info-title").css({"z-index":1})},300)},handleHoverOff:function(){var e=this;setTimeout(function(){$(e.$el).find(".background-info-title").css({"z-index":2})},300)},clickWidget:function(e){this.detail_url&&this.detail_url.length>0&&(e.preventDefault(),e.stopPropagation(),window.open(this.detail_url,"_blank"))},controlHoverOn:function(){$(this.$el).removeClass("has-link")},controlHoverOff:function(){this.detail_url&&this.detail_url.length>0&&$(this.$el).addClass("has-link")},clickSource:function(e){e.preventDefault(),e.stopPropagation();var t=$(e.currentTarget).data("url");t&&window.open(t,"_blank")},trackClick:function(){m.sendEvent("BackgroundInfo","Click",localStorage.background)},toggleFavorite:function(e){e.stopPropagation(),$(e.currentTarget).toggleClass("active");var t=$(e.currentTarget).hasClass("active");m.models.backgroundManager.toggleFavorite(t,function(){$(e.currentTarget).toggleClass("active")}),m.sendEvent("Background",t?"Favourite":"Unfavourite")},skipBackground:function(e){e.stopPropagation(),this.$control_refresh.hasClass("active")||($(e.currentTarget).addClass("active"),m.models.backgroundManager.skipBackground(function(){$(e.currentTarget).removeClass("active")}),m.sendEvent("Background","Skip"))}}),m.views.Search=Backbone.View.extend({id:"search",className:"search top-widget",events:{"focusin .search-input":"handleFocusIn","focusout .search-input":"handleFocusOut","keyup .search-input":"checkForEscape","submit .form":"doSearch"},initialize:function(){this.renderedOnce=!1,this.listenTo(m,"globalEvent:click",this.hideResults),this.listenTo(m,"globalEvent:esc",this.hide),this.listenTo(m,"globalEvent:toggleSearch",this.toggleShow),this.listenTo(m.models.customization,"change:searchVisible",this.visibleChanged),this.render()},render:function(){var e='<form class="form"><span class="search-underline"></span><i class="icon-search"></i><input type="text" id="search-input" class="search-input" autocomplete="off"></form><iframe src="" class="search-results"></iframe>',t=(this.options.order||"append")+"To";return this.$el[t]("#"+this.options.region).fadeTo(0,0).html($.trim(e)).fadeTo(500,1),this.$input=this.$el.find("input"),this.renderedOnce=!0,this},visibleChanged:function(e){var t=m.models.customization.get("searchVisible");t?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},doSearch:function(e){e.preventDefault();var t=this.$el.find(".search-input")[0].value;if(t.length>0){var i=m.globals.urlRootApi+"search";if(!localStorage.token){var n=m.models.customization.get("searchProvider");n||(n="google"),i=i+"?provider="+n}$.ajax({type:"GET",beforeSend:m.utils.setMomentumAuthHeader,url:i}).done(function(e,i,n){if(e&&e.searchUrl){var o=e.searchUrl+encodeURIComponent(t);e.searchOutput&&"redirect"==e.searchOutput?window.location.href=o:$(".search-results").attr("src",o).attr("target","_top").addClass("fadein").css("display","block")}}).fail(function(e,i){var n="https://search.momentumdash.com/?q="+encodeURIComponent(t);$(".search-results").attr("src",n).attr("target","_top").addClass("fadein").css("display","block")}),m.sendEvent("Search","Searched")}},handleFocusIn:function(){$(".search").addClass("active"),m.sendEvent("Search","Focused")},handleFocusOut:function(){$(".search").removeClass("active")},hideResults:function(e){(!$.contains(this.el,e.target)&&$(".search-results").hasClass("fadein")||1==e.hide)&&$(".search-results").removeClass("fadein").css("display","none")},checkForEscape:function(e){27==e.keyCode&&this.hideResults({hide:"true"})},toggleShow:function(e){this.$input.is(":focus")?this.$input.blur():this.$input.focus()},hide:function(){this.$input.is(":focus")&&this.$input.blur()}}),m.bootstrappers.RenderSearch=function(e,t){e.conditionalFeatures.checkPreferenceForRender("searchVisible",function(){e.views.search=new e.views.Search({region:"top-left",order:"append"}),e.widgets.push(e.views.search)},function(t){e.listenToOnce(e.models.customization,"change:searchVisible",t)})},m.models.GenericWidget=Backbone.Model.extend({defaults:{id:null,label:"",value:"",link:null},initialize:function(){this.listenTo(this,"change:metric",this.metricChanged),this.loadData()},loadData:function(){var e=this,t="";this.set("label",t);var i=m.globals.urlRootIntegration+"services/random";try{$.ajax({type:"GET",contentType:"application/json",beforeSend:m.utils.setMomentumAuthHeader,url:i}).done(function(t,i,n){if(t.metricInfo)e.set("id",t.metricInfo.metricId),e.set("value",t.metricInfo.metricValue),e.set("label",t.metricInfo.metricLabel),t.metricInfo.metricLink?e.set("link",t.metricInfo.metricLink):e.set("link",null);else if(t.status&&"authRequired"==t.status&&t.authorizationUrl&&e.authAttempts<2){e.authAttempts++;var o=t.winWidth?t.winWidth:600,s=t.winHeight?t.winHeight:510,a=t.windowFeatures?t.windowFeatures:"titlebar,resizable,toolbar,status",l=window.screen.width/2-o/2,r=window.screen.height/2-s/2,d=window.open(t.authorizationUrl,"MomentumAuthWindow",a+",left="+l+",top="+r+",width="+o+",height="+s),c=setInterval(function(){d.closed&&(clearInterval(c),e.metricChanged())},250)}}).fail(function(e,t){console.log("failed")})}catch(n){}},clickMetric:function(){this.get("link")}}),m.views.GenericWidget=Backbone.View.extend({attributes:{id:"generic-stats","class":"metric"},template:Handlebars.compile('<div><span class="metric-stat">{{statvalue}}</span></div><span class="metric-label">{{statlabel}}</span>'),events:{click:"clickMetric",mouseenter:"mouseEnter",mouseleave:"mouseLeave"},initialize:function(){this.renderedOnce=!1,this.render(),this.listenTo(this.model,"change:value",this.render),this.listenTo(this.model,"change:label",this.render)},render:function(){var e=this.model.get("label"),t=this.model.get("value");if(t){var i={statvalue:t,statlabel:e};if(this.renderedOnce)this.$el.html(this.template(i)),this.$time=this.$(".time"),this.$format=this.$(".format");else{var n=(this.options.order||"append")+"To";this.$el[n]("#"+this.options.region).fadeTo(0,0).html(this.template(i)).fadeTo(500,1),this.$time=this.$(".time"),this.$format=this.$(".format"),this.renderedOnce=!0}}},clickMetric:function(e){this.model.clickMetric()}}),m.models.Quote=Backbone.Model.extend({idAttribute:"forDate"}),m.collect.Quotes=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("momentum-quote"),model:m.models.Quote,getActiveQuote:function(){if(this.length>0){var e=getActiveDateString();return this.get(e)}}}),m.models.QuoteManager=Backbone.Model.extend({initialize:function(e,t){m.collect.quotes=new m.collect.Quotes},firstFetch:function(){m.collect.quotes.fetch({reset:!0})},skipErrorMessage:{message:"Oops! We weren't able to get a new quote. Please check your connection and try again.",viewLimit:1},favouriteErrorMessage:{message:"Oops! We weren't able to save the favorite. Please check your connection and try again.",viewLimit:1},getActiveQuote:function(){var e=this;if(m.collect.quotes){var t=m.collect.quotes.getActiveQuote(),i=!1;if(this.currentQuote&&this.currentQuote.get("_id")==t.get("_id")){var n=this.currentQuote;(n.get("body")!=t.get("body")||n.get("source")!=t.get("source")||n.get("twitter")!=t.get("twitter")||n.get("twitterIntentUrl")!=t.get("twitterIntentUrl"))&&(this.currentQuote=t,i=!0)}else this.currentQuote=t,i=!0;return i&&setTimeout(function(){m.trigger("quote:active_changed",e.currentQuote.get("_id"))},50),t}return null},skipQuote:function(e){var t=this,i=m.globals.urlRootApi+"quotes",n=this.getActiveQuote(),o=n.get("_id"),s=n.get("is_custom"),a={operation:"skip",active_uuid:o,is_custom:s};try{$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(a),url:i}).done(function(e){e&&e.success&&m.trigger("sync:download","quote"),e&&e.notification&&m.commandManager.execute("notification.show.enhanced",e.notification)}).fail(function(i,n){m.commandManager.execute("notification.show.enhanced",t.skipErrorMessage),e&&e()})}catch(l){m.commandManager.execute("notification.show.enhanced",t.skipErrorMessage),e&&e()}},toggleFavorite:function(e,t){var i=this,n=m.globals.urlRootApi+"quotes/favorites",o=this.getActiveQuote(),s=o.get("_id"),a=o.get("is_custom"),l={operation:"favorite",active_uuid:s,is_favorite:e,is_custom:a};try{$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify(l),url:n}).done(function(e){e&&e.success&&(m.trigger("sync:download","quote"),m.trigger("quote:favorite",{id:l.active_uuid,is_favorite:l.is_favorite}))}).fail(function(e,n){m.commandManager.execute("notification.show.enhanced",i.favouriteErrorMessage),t&&t()})}catch(r){m.commandManager.execute("notification.show.enhanced",i.favouriteErrorMessage),t&&t()}},latestQuoteDate:function(){var e=null;return m.collect.quotes.models.forEach(function(t){var i=Date.parse(t.id);(!e||i>e)&&(e=i)}),e}}),m.views.Quote=Backbone.View.extend({tagName:"blockquote",attributes:{"class":"quote",id:"shortquote"},template:m.templates.quote.quote,events:{click:"clickWidget","mouseenter .control":"controlHoverOn","mouseleave .control":"controlHoverOff","click .control-twitter":"shareTwitter","click .control-heart":"toggleFavorite","click .control-refresh":"skipQuote"},currentlyActiveQuote:null,initialize:function(){this.renderedOnce=!1,this.listenTo(m,"newDay",this.handleNewDay,this),this.listenTo(this.collection,"reset",this.collectionReady),this.listenTo(m.models.customization,"change:quoteVisible",this.visibleChanged)},handleNewDay:function(){var e=this;e.intervalId=setInterval(function(){e.collection.length>0&&(e.render(),clearInterval(e.intervalId))},50)},parentReady:function(e){this.isParentReady=!0,(this.isCollectionReady||e)&&this.render()},collectionReady:function(){m.trigger("quote:downloaded"),this.isCollectionReady=!0,this.isParentReady&&this.render()},visibleChanged:function(e){var t=m.models.customization.get("quoteVisible");t?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},render:function(e){if(0===this.collection.length)return void m.trigger("sync:downloadIfNeeded");var t=m.models.quoteManager.getActiveQuote();if(!t)return void m.trigger("sync:downloadIfNeeded");var i=!1;if(this.currentlyActiveQuote&&this.currentlyActiveQuote.get("_id")==t.get("_id")){var n=this.currentlyActiveQuote;(n.get("body")!=t.get("body")||n.get("source")!=t.get("source")||n.get("twitter")!=t.get("twitter")||n.get("twitterIntentUrl")!=t.get("twitterIntentUrl"))&&(this.currentlyActiveQuote=t,i=!0)}else this.currentlyActiveQuote=t,i=!0;var o=this,s=t.get("body"),a=t.get("source"),l=t.get("detail_url"),r=t.get("twitter"),d=t.get("twitterIntentUrl"),c=!1,u="";if(t.get("is_favorite")&&(c=!0,u="active"),!d){var h="";h=r?'"'+s+'" —@'+r:'"'+s+'" —'+a,d="https://twitter.com/intent/tweet?text="+encodeURIComponent(h)+"&via=momentumdash&related=momentumdash,levibucsis,jaywaterman"}if(this.renderedOnce)i&&this.$el.fadeTo(500,0,function(){o.$quote_body_text.html("&ldquo;"+s+"&rdquo;"),o.$quote_source_text.html(a),o.$control_twitter.data("url",d),o.$el.fadeTo(500,1)});else{var g={body:s,source:a,twitterIntentUrl:d,fav_class:u},p=(this.options.order||"append")+"To";e?this.$el[p]("#"+o.options.region).html(o.template(g)).fadeTo(500,1):this.$el[p]("#"+o.options.region).fadeTo(0,0).html(o.template(g)).fadeTo(500,1),this.$control_heart=this.$el.find(".control-heart").first(),this.$control_refresh=this.$el.find(".control-refresh").first(),this.$quote_body_text=this.$el.find(".quote-body-text").first(),this.$quote_source_text=this.$el.find(".quote-source-text").first(),this.$control_twitter=this.$el.find(".control-twitter").first(),this.renderedOnce=!0}l&&l.length>0?(this.detail_url=l,this.$el.addClass("has-link")):(this.detail_url=null,this.$el.removeClass("has-link")),this.$control_refresh.removeClass("active"),m.conditionalFeatures.featureEnabled("skip-qt")?this.$el.find(".control-refresh").show():this.$el.find(".control-refresh").hide(),this.$control_heart.show(),c?this.$control_heart.addClass("active"):this.$control_heart.removeClass("active")},clickWidget:function(e){this.detail_url&&this.detail_url.length>0&&(e.preventDefault(),e.stopPropagation(),window.open(this.detail_url,"_blank"))},controlHoverOn:function(){$(this.$el).removeClass("has-link")},controlHoverOff:function(){this.detail_url&&this.detail_url.length>0&&$(this.$el).addClass("has-link")},shareTwitter:function(e){e.stopPropagation();var t=screen.width/2-272.5,i=screen.height/2-210;window.open($(e.currentTarget).data("url"),"share","left="+t+",top="+i+",width=545,height=420,resizeable=0")},toggleFavorite:function(e){e.stopPropagation(),$(e.currentTarget).toggleClass("active");var t=$(e.currentTarget).hasClass("active");m.models.quoteManager.toggleFavorite(t,function(){$(e.currentTarget).toggleClass("active")}),m.sendEvent("Quote",t?"Favourite":"Unfavourite")},skipQuote:function(e){e.stopPropagation(),this.$control_refresh.hasClass("active")||($(e.currentTarget).addClass("active"),m.models.quoteManager.skipQuote(function(){$(e.currentTarget).removeClass("active")}),m.sendEvent("Quote","Skip"))}}),m.bootstrappers.InitializeQuote=function(e,t){e.models.quoteManager=new e.models.QuoteManager},m.bootstrappers.RenderQuote=function(e,t,i){e.conditionalFeatures.checkPreferenceForRender("quoteVisible",function(){e.views.quote=new e.views.Quote({collection:e.collect.quotes,model:e.models.date,region:"bottom"}),e.models.quoteManager.firstFetch(),e.views.quote.parentReady(i),e.widgets.push(e.views.quote)},function(t){e.listenToOnce(e.models.customization,"change:quoteVisible",t)})},m.models.FocusBase=Backbone.Model.extend({defaults:{focus:"",day:"",forDate:null,archived:!1,createdDate:new Date,archivedDate:null,completed:!1,completedDate:null,cached:!1},saveOptions:function(){return this.collection&&this.collection.saveOptions?this.collection.saveOptions:{}},archive:function(){var e=new Date;this.save({archived:!0,archivedDate:e},this.saveOptions())},toggleCompleted:function(){var e=this.saveOptions(),t=!this.get("completed");return this.save({completed:t,completedDate:this.get("completed")?null:new Date},e),t}}),m.models.Focus=m.models.FocusBase.extend({urlRoot:function(){return this.collection?null:m.globals.urlRoot+"focus"},toggleCompleted:function(){var e=this,t=this.saveOptions(),i=!this.get("completed");if(m.conditionalFeatures.featureEnabled("pinfocus")){var n=e.get("todoId");t.success=function(){m.trigger("focus:toggled",i);var t=e.get("refreshTodo");t&&n&&m.trigger("todo:refresh",n)},t.error=function(t,o,s){if(200==o.status){m.trigger("focus:toggled",i);var a=e.get("refreshTodo");a&&n&&m.trigger("todo:refresh",n)}};var o={completed:i,completedDate:this.get("completed")?new Date:null};this.id.startsWith("todo-")&&(o.todoId=this.get("todoId"),o.focus=this.get("focus")),this.save(o,t),m.trigger("todo:set:done",n,i)}else this.save({completed:i,completedDate:this.get("completed")?null:new Date},t);return i},archive:function(){if(!this.id.startsWith("todo-")){var e=new Date;this.save({archived:!0,archivedDate:e},this.saveOptions())}m.conditionalFeatures.featureEnabled("pinfocus")&&m.models.customization.get("autoFocus")&&m.models.customization.set("autoFocus",!1)},saveOptions:function(){return this.collection&&this.collection.saveOptions?this.collection.saveOptions:{patch:!0}}}),m.collect.FocusesBase=Backbone.Collection.extend({saveOptions:{},attributes:{},successfulLoad:!1,loadingFromServer:!0,fetchedOnce:!1,initialize:function(){this.on("reset",this.onReset,this),this.on("add",this.onAdd,this),this.on("change",this.onModelChanged,this)},fetch:function(e){this.fetchedOnce=!0;var t={};return e=_.extend(e||{},t),Backbone.Collection.prototype.fetch.call(this,e)},onReset:function(){this.successfulLoad=!0,this.loadingFromServer=!1,this.trigger("loadingFromServerChanged")},onModelChanged:function(e){var t=e.changedAttributes(),i=_.keys(t),n=_.without(i,"archived","archivedDate");n.length>0&&this.saveCachedFocus(e)},comparator:function(e){var t=e.get("completedDate");return t||(t=e.get("createdDate"))?-Date.parse(t):0},activeFocus:function(){return this.activeFocusBase()},activeFocusBase:function(){if(this.loadingFromServer)return this.fetchedOnce||this.fetch({reset:!0}),this.cachedFocus();if(0===this.length)return localStorage.removeItem("cachedFocus"),null;var e=null,t=getActiveDateString(),i=this.where({completed:!1,archived:!1,forDate:t});if(1===i.length)e=i[0];else if(0===i.length)if(i=this.where({completed:!0,archived:!1,forDate:t}),1===i.length)e=i[0];else if(0===i.length)return localStorage.removeItem("cachedFocus"),null;return null==e&&_.each(i,function(t){if(null==e)e=t;else{var i=t.get("completedDate"),n=e.get("completedDate");i>n&&(e=t)}}),e?this.saveCachedFocus(e):localStorage.removeItem("cachedFocus"),e},saveCachedFocus:function(e){localStorage.cachedFocus=JSON.stringify(e)},cachedFocus:function(){if(localStorage.cachedFocus){var e=JSON.parse(localStorage.cachedFocus),t=getActiveDateString();if(e&&e.forDate===t)return e.cached=!0,new this.model(e)}return null}}),m.collect.Focuses=m.collect.FocusesBase.extend({model:m.models.Focus,url:m.globals.urlRoot+"focus",saveOptions:{patch:!0},activeFocus:function(){if(!m.conditionalFeatures.featureEnabled("pinfocus")||!m.models.customization.get("autoFocus"))return this.activeFocusBase();if(m.models.todoListManager&&m.models.todoListManager.activeProvider&&m.models.todoListManager.activeProvider.selectedList){var e=m.models.todoListManager.activeProvider.selectedList();if(e&&e.itemCollection&&(e.itemCollection.length>0||!e.itemCollection.loadingFromServer)){var t=null;if(m.views.todoPane&&m.views.todoPane.todoList&&m.views.todoPane.todoList.reordered){var i=m.views.todoPane.todoList.getTopActiveTodoId();i&&(t=e.itemCollection.get(i))}else{var n=_(e.itemCollection.activeToday()).chain().filter(function(e){return!e.get("done")}).value();n&&n.length>0&&(t=n[0])}if(t){var o={};o.id="todo-"+t.id,o.focus=t.get("title"),o.day="today",o.todoId=t.id,o.forDate=getActiveDateString();var s=new m.models.Focus(o);return this.saveCachedFocus(s),s}return this.fetchedOnce?this.successfulLoad?this.activeFocusBase():this.cachedFocus():(this.fetch({reset:!0}),this.cachedFocus())}return e&&e.itemCollection&&e.itemCollection.doFetchIfNeeded(),this.cachedFocus()}return this.cachedFocus()},triggerCollectionReset:function(){this.trigger("reset")},selectedListCacheKey:function(){return localStorage.activeTodoProvider?"activeTodoListId-"+localStorage.activeTodoProvider:null}}),m.collect.FocusesLegacy=m.collect.FocusesBase.extend({model:m.models.FocusBase,localStorage:new Backbone.LocalStorage("momentum-focus"),saveOptions:{},onReset:function(){this.loadingFromServer=!1,this.fixNullForDate(),this.trigger("loadingFromServerChanged")},fixNullForDate:function(){var e=this.where({archived:!1,forDate:null});e&&e.length>0&&_.each(e,function(e){var t=e.get("createdDate");if(t){var i=Date.parse(t),n=activeDateStringForDate(i),o=getActiveDateString();n!=o&&e.archive()}else e.archive()},focus)}}),m.views.Focus=Backbone.View.extend({tagName:"li",attributes:{"class":"focus"},template:m.templates.focus["focus-template"],events:{"click .delete":"destroy","click .checkbox":"toggleCompleted"},initialize:function(){this.render(),this.listenTo(this.model,"change",this.render),m.conditionalFeatures.featureEnabled("pinfocus")&&(this.listenTo(m,"todo:changed",this.todoChanged),this.listenTo(m,"todo:changing",this.todoChanging),this.listenTo(m,"focus:toggled",this.focusToggled),this.listenTo(m.models.customization,"change:autoFocus",this.autoFocusChanged))},todoChanged:function(e,t){e==this.model.get("todoId")&&m.conditionalFeatures.featureEnabled("pinfocus")&&m.models.customization.get("autoFocus")&&m.collect.focuses&&t.hasOwnProperty("done")&&m.collect.focuses.fetch({reset:!0})},todoChanging:function(e,t){e==this.model.get("todoId")&&(t.hasOwnProperty("done")&&this.model.set("completed",t.done),t.hasOwnProperty("title")&&this.model.set("focus",t.title),t.hasOwnProperty("done")&&this.displayAutoPinMessage(t.done))},render:function(){var e=m.utils.captionFormatter(this.model.get("focus")),t={focus:e,day:"Today"};return this.$el.html(this.template(t)),this.model.changed.hasOwnProperty("completed")?this.$el.toggleClass("complete",this.model.changed.completed):this.$el.toggleClass("complete",this.model.get("completed")),this.$el.toggleClass("cached",this.model.get("cached")),this},displayAutoPinMessage:function(e){m.conditionalFeatures.featureEnabled("pinfocus")&&m.models.customization.get("autoFocus")&&m.views.focuses.displayLoadingMessage(e)},focusToggled:function(e){e&&m.conditionalFeatures.featureEnabled("pinfocus")&&m.models.customization.get("autoFocus")&&(this.displayAutoPinMessage(e),m.collect.focuses&&m.collect.focuses.fetch({reset:!0}))},destroy:function(){if(this.$el.hasClass("complete"))m.sendEvent("Focus","Add New"),m.trigger("setNewFocus");else{m.sendEvent("Focus","Delete");var e=this;this.$el.fadeTo(500,0,function(){e.destroyed=!0,e.model.archive(),e.remove()})}},autoFocusChanged:function(){this.destroyed&&m.conditionalFeatures.featureEnabled("pinfocus")&&!m.models.customization.get("autoFocus")&&m.trigger("setNewFocus")},removeView:function(){this.remove(),this.unbind()},toggleCompleted:function(){var e=this.model.toggleCompleted();m.views.focuses.displayLoadingMessage(e),m.conditionalFeatures.featureEnabled("serverfocus")||setTimeout(function(){m.views.focuses.dismissConnectionMessage()},3e3),this.$el.toggleClass("complete",e),m.sendEvent("Focus","Done")}}),m.views.FocusPrompt=Backbone.View.extend({attributes:{"class":"prompt"},template:m.templates.focus["focus-prompt-template"],events:{click:"focusInput","focus input":"handleFocus","keypress input":"handleInput","keyup input":"handleKeyup","blur input":"handleBlur"},initialize:function(){this.focusedOnce=!1,this.listenTo(m,"globalEvent:toggleFocus",this.toggleShow),this.listenTo(m,"globalEvent:esc",this.hide),this.render()},render:function(){return this.$el.html(this.template()),this.$input=this.$el.find("input"),this.collection.loadingFromServer||this.$input.focus(),this},focusInput:function(){this.$input.focus()},handleFocus:function(e){this.focusedOnce=!0,m.views.focuses.promptFocused()},handleBlur:function(){this.focusedOnce=!1,this.$el.removeClass("loading")},handleInput:function(e){this.collection.loadingFromServer&&e.preventDefault(),this.clearHelpTimeout(),13==e.keyCode?this.save():this.startHelpTimeout()},handleKeyup:function(){0==this.getInput().length&&m.views.focuses.dismissConnectionMessage()},getInput:function(){return this.$input.val().trim()},inputTimeout:"",startHelpTimeout:function(){var e=this;this.inputTimeout=setTimeout(function(){e.displayHelpMessage()},5e3)},clearHelpTimeout:function(){this.inputTimeout>0&&clearTimeout(this.inputTimeout)},displayHelpMessage:function(){this.getInput().length>0&&m.views.focuses.displayConnectingText("Press enter to set your focus",!0)},save:function(){var e=this.getInput();if(e){var t=this;m.views.focuses.displayConnectingText('<i class="loading-icon"></i>Saving...',!0);var i=getActiveDateString();m.collect.focuses.create({focus:e,day:"today",forDate:i},{wait:!0,success:function(){m.views.focuses.successfulConnection(),t.$el.fadeTo(500,0,function(){t.remove(),m.views.focuses.successfullyCreatedNewFocus()})},error:function(e,i,n){t.$input.addClass("pulse"),m.views.focuses.failedConnection(!0)}})}},toggleShow:function(){this.$input.is(":focus")?this.$input.blur():this.$input.focus()},hide:function(){this.$input.is(":focus")&&this.$input.blur()}}),m.views.Focuses=Backbone.View.extend({attributes:{id:"focuses"},template:m.templates.focus["focuses-template"],events:{"mouseover .todays-focus":"onMouseOver","click .todays-focus":"onClickFocus","click .prompt":"onClickFocus","click .retry":"retryConnection"},offline:!0,loading:!1,clickedOnce:!1,retrying:!0,initialize:function(){var e=["Great work!","Good job!","Nice.","Way to go!"];this.loadingMessage=e[Math.floor(Math.random()*e.length)],this.listenTo(m,"newDay",this.changeDay,this),this.listenTo(m,"setNewFocus",this.setNewFocus,this),this.listenTo(m,"todo:loadingStateChange",this.todoLoadingStateChanged),this.listenTo(m,"todo:managerReady",this.todoLoadingStateChanged),this.listenTo(m,"todo:globalChange",this.todoLoadingStateChanged),this.listenTo(m.collect.focuses,"change:archived",this.todayArchived),this.listenTo(m.collect.focuses,"reset",this.collectionReady),this.listenTo(m.collect.focuses,"sync",this.successfulConnection),this.listenTo(this.collection,"request",this.collectionRequest),this.listenTo(this.collection,"error",this.collectionError),this.listenTo(m.models.customization,"change:focusVisible",this.visibleChanged),this.listenTo(m.models.customization,"change:autoFocus",this.autoFocusChanged),this.listenTo(m,"todo:showAssignedTodosOnlyChanged",this.showAssignedTodosOnlyChanged),this.renderedOnce=!1,this.lastStateFocused=!1,this.focusStateChanged=!0,this.render()},onMouseOver:function(){this.loading&&this.displayConnectingText(null,!0)},onClickFocus:function(){this.offline&&this.displayConnectingText(null,!0),
this.clickedOnce=!0},visibleChanged:function(e){var t=m.models.customization.get("focusVisible");t?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},collectionRequest:function(){this.loading=!0,this.clickedOnce||this.connectingTextOverride},promptFocused:function(){this.loadedOnce||this.displayConnectingText()},displayConnectingText:function(e,t){e&&(this.connectingTextOverride=e),this.$message.html(this.connectingTextOverride?this.connectingTextOverride:'<i class="loading-icon"></i>Loading...'),this.$message.addClass("loading"),this.$message.is(":visible")||this.$message.fadeIn(500)},displayLoadingMessage:function(e){e?this.displayConnectingText('<i class="loading-icon"></i>'+this.loadingMessage,!0):this.displayConnectingText('<i class="loading-icon"></i> Loading...',!0)},todoLoadingStateChanged:function(e){e||this.render()},collectionError:function(e,t,i){return 200===t.status?void this.successfulConnection():void this.failedConnection()},retryConnection:function(e){e.preventDefault(),e.stopPropagation(),this.displayConnectingText('<i class="loading-icon"></i>Loading...',!0),this.retrying=!0;var t=this;m.views.focusPrompt?m.syncCoordinator.pingApi(function(){t.successfulConnection(),m.views.focusPrompt&&m.views.focusPrompt.focusInput()},function(){t.failedConnection(!0)}):this.collection.fetch({reset:!0})},successfulConnection:function(){this.loading=!1,this.offline=!1,this.retrying=!1,this.loadedOnce=!0,this.dismissConnectionMessage()},failedConnection:function(e){this.loading=!1,this.offline=!0,this.render(),this.displayConnectingText('Trouble connecting… <span class="retry">Retry</span>',e||this.clickedOnce)},dismissConnectionMessage:function(){this.$message.is(":visible")&&this.$message.fadeOut(500)},parentReady:function(e){this.isParentReady=!0,(this.isCollectionReady||e)&&this.render()},collectionReady:function(){this.isCollectionReady=!0,this.isParentReady&&this.render(),this.successfulConnection()},setNewFocus:function(){this.render(!0),m.views.focusPrompt&&m.views.focusPrompt.focusInput(),this.dismissConnectionMessage()},autoFocusChanged:function(){this.render()},showAssignedTodosOnlyChanged:function(){this.render()},setFocusState:function(e){this.lastStateFocused==e?this.focusStateChanged=!1:this.focusStateChanged=!0,this.lastStateFocused=e},render:function(e){var t=!1;m.views.focusPrompt&&(t=m.views.focusPrompt.controlFocusedOnce);var i=this;if(!this.renderedOnce){var n=(this.options.order||"append")+"To";this.$el[n]("#"+this.options.region).fadeTo(0,0).html(this.template()).fadeTo(500,1),this.$message=this.$(".message")}this.renderedOnce=!0;var o=null;if(e||(o=this.collection.activeFocus()),o){this.setFocusState(!0);var s=!1,a=null,l=!0;m.views.todayFocus?m.views.todayFocus.model.id!=o.id?m.views.todayFocus.model.id.startsWith("todo-")?m.views.todayFocus.model.get("todoId")!=o.get("todoId")&&(s=!0,a=m.views.todayFocus):(s=!0,a=m.views.todayFocus):m.views.todayFocus.model.collection||(s=!0,a=m.views.todayFocus,l=!1):s=!0,s&&(i.$el.find(".prompt").fadeTo(0,0).remove(),m.views.focusPrompt=null,m.views.todayFocus=new m.views.Focus({model:o}),i.$el.find("ol").append(m.views.todayFocus.render().$el.fadeTo(l?500:0,1))),a&&a.removeView()}else this.setFocusState(!1),m.views.todayFocus&&i.$el.find("li").fadeTo(0,0).remove(),m.views.focusPrompt||(m.views.focusPrompt=new m.views.FocusPrompt({collection:this.collection}),this.$el.prepend(m.views.focusPrompt.render().$el.fadeIn(this.focusStateChanged?500:0))),t&&m.views.focusPrompt.focusInput();return this},addToday:function(e){m.sendEvent("Focus","Save"),m.views.todayFocus=new m.views.Focus({model:e}),this.$el.find("ol").append(m.views.todayFocus.render().$el.fadeTo(500,1))},successfullyCreatedNewFocus:function(){m.views.focuses.successfulConnection(),this.render()},changeDay:function(){m.collect.focuses.fetch({reset:!0})},todayArchived:function(){this.render()}}),m.bootstrappers.InitializeFocus=function(e,t){},m.bootstrappers.RenderFocus=function(e,t,i){e.conditionalFeatures.checkFeatureAndMigrateData("serverfocus","focusVisible","momentum-focus",function(){e.collect.focuses=new e.collect.Focuses,e.views.focuses=new e.views.Focuses({collection:e.collect.focuses,model:e.models.date,region:"center-below",order:"append"}),e.conditionalFeatures.featureEnabled("pinfocus")&&e.models.customization.get("autoFocus")||e.collect.focuses.fetch({reset:!0}),e.views.focuses.parentReady(i),e.widgets.push(e.views.focuses)},function(){e.collect.focuses=new e.collect.FocusesLegacy,e.views.focuses=new e.views.Focuses({collection:e.collect.focuses,model:e.models.date,region:"center-below",order:"append"}),e.collect.focuses.fetch({reset:!0}),e.views.focuses.parentReady(i),e.widgets.push(e.views.focuses)},function(t){e.listenToOnce(e.models.customization,"change:focusVisible",t)})},m.models.legacy=m.models.legacy||{},m.collect.legacy=m.collect.legacy||{},m.views.legacy=m.views.legacy||{},m.models.legacy.TodoBase=Backbone.Model.extend({isTrue:function(e){var t=this.get(e);return void 0===t?!1:1==t},saveOptions:function(){return this.collection.saveOptions},getValue:function(e){var t=null;return this.attemptedSaveValues&&this.attemptedSaveValues.hasOwnProperty(e)&&(t=this.attemptedSaveValues[e]),t||(t=this.get(e)),t}}),m.models.legacy.Todo=m.models.legacy.TodoBase.extend({defaults:function(){return{title:"empty todo...",done:!1,archive:!1,order:0,createdDate:new Date,archivedDate:null,completedDate:null,deleted:!1,deletedDate:null}},archive:function(){this.save({archive:!0,archivedDate:new Date},this.saveOptions())},comparator:"order"}),m.models.legacy.TodoProxy=m.models.legacy.TodoBase.extend({defaults:function(){return{done:!1,isProxy:!0,isLoading:!0,saveFailed:!1,proxyValid:!0}}}),m.collect.legacy.TodosBase=Backbone.Collection.extend({model:m.models.legacy.Todo,saveOptions:{},initialize:function(){this.loadingFromServer=!0,localStorage.showTodoList||(localStorage.showTodoList=!1),this.listenTo(m,"newDay",this.onNewDay),this.listenTo(this,"reset",this.onReset),this.listenTo(this,"add remove change",this.collectionChanged),this.listenTo(this,"reorder",this.reorderItem)},onReset:function(){this.loadingFromServer=!1,this.clearCompleted(),this.onLoadingFromServerChanged(),this.trigger("loadingFromServerChanged")},onNewDay:function(){this.loadingFromServer=!0,this.fetch({reset:!0})},onLoadingFromServerChanged:function(){},clearCompleted:function(){},collectionChanged:function(e){localStorage.setItem("todos-updated",new Date),this.onCollectionChanged(e)},onCollectionChanged:function(e){},completeToday:function(){return this.where({done:!0,archive:!1,deleted:!1})},completedCount:function(){var e=this.completeToday();return e.length},activeToday:function(){return this.where({archive:!1,deleted:!1})},done:function(){return this.where({done:!0})},deleted:function(){return this.where({deleted:!0})},remaining:function(){return this.where({archive:!1,deleted:!1,done:!1})},nextOrder:function(){return this.length?this.last().get("order")+100:100},comparator:"order",create:function(e,t){return void 0==e.order&&(e.order=this.nextOrder()),Backbone.Collection.prototype.create.call(this,e,t)},reorderItem:function(e){},hasValidCachedCompletedCount:function(){return!0}}),m.collect.legacy.Todos=m.collect.legacy.TodosBase.extend({url:m.globals.urlRoot+"todos",previousCount:-1,saveOptions:{patch:!0},reorderItem:function(e){var t={operations:[{REORDER:{move_id:e.move_id,move_target_id:e.move_target_id,move_offset:e.move_offset}}]};$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(t),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"todos"}).done(function(e){}).fail(function(e,t){})},onLoadingFromServerChanged:function(){this.saveCachedCompletedCount()},onCollectionChanged:function(e){this.saveCachedCompletedCount()},completedCount:function(){if(this.loadingFromServer)return this.cachedCompletedCount();var e=this.completeToday();return e.length},saveCachedCompletedCount:function(){if(!this.loadingFromServer){var e=this.completeToday(),t=e.length,i=getActiveDateString();localStorage.cachedCompletedCount=JSON.stringify({count:t,forDate:i}),t!=this.previousCount&&(this.previousCount=t,this.trigger("completedCountChanged"))}},cachedCompletedCount:function(){if(localStorage.cachedCompletedCount){var e=JSON.parse(localStorage.cachedCompletedCount),t=getActiveDateString();if(e&&e.forDate===t)return e.count}return 0},hasValidCachedCompletedCount:function(){if(localStorage.cachedCompletedCount){var e=JSON.parse(localStorage.cachedCompletedCount),t=getActiveDateString();if(e&&e.forDate===t)return!0}return!1},parse:function(e){return e.items?e.items:e}}),m.collect.legacy.TodosLegacy=m.collect.legacy.TodosBase.extend({localStorage:new Backbone.LocalStorage("momentum-todo"),isLegacy:!0,createOrderGaps:function(){var e=100;this.each(function(t){t.save({order:e},{silent:!0}),e+=100})},clearCompleted:function(){var e=!1,t=this.completeToday();_.each(t,function(t){var i=t.get("completedDate");if(i){var n=Date.parse(i),o=activeDateStringForDate(n);o!=getActiveDateString()&&(t.archive(),e=!0)}}),e&&this.trigger("reset")},reorderItem:function(e){var t=this.get(e.move_id),i=this.get(e.move_target_id),n=e.move_offset>0?1:-1,o=this.indexOf(i),s=1;if(o+n>=0&&o+n<this.length){var a=this.at(o+n);s=Math.abs(a.get("order")-i.get("order")),20>=s&&(this.createOrderGaps(),s=Math.abs(a.get("order")-i.get("order")))}var l=i.get("order")+Math.ceil(s/2)*n;t.save({order:l},{silent:!0})}}),m.views.legacy.Todos=Backbone.View.extend({attributes:{id:"todo","class":"widget-bottom-right todo"},template:m.templates.todos["todo-template"],offline:!0,initialFetchStarted:!1,renderedOnce:!1,loadedOnce:!1,events:{"click .todo-list-active":"openList","click .todo-list-chooser-dropdown":"chooseList","click .todo-toggle":"toggleShow","click .show-completed":"showCompleted","click .retry":"onClickRetry","click #clear-completed":"clearCompleted","keyup #todo-new":"handleInput",dragover:"dragover",dragend:"dragend"},initialize:function(){this.subViews=[],this.proxyCollection=new Backbone.Collection({model:m.models.legacy.TodoProxy}),this.show_completed=!1,_.bindAll(this,"addOne","addAll","dragover","dragend","li_index"),this.render(),this.listenTo(m,"globalEvent:esc",this.hide),this.listenTo(m,"globalEvent:toggleTodo",this.toggleShow),this.listenTo(m,"globalEvent:window:resize",this.setMaxWidgetHeight),this.listenTo(this,"connectionOnline",this.connectionOnline),this.listenTo(this.collection,"add",this.addOne),this.listenTo(this.proxyCollection,"add",this.addOne),this.listenTo(this.collection,"reset",this.collectionReset),this.listenTo(this.collection,"request",this.collectionRequest),this.listenTo(this.collection,"change",this.collectionModelChanged),this.listenTo(this.collection,"error",this.collectionError),this.listenTo(m.models.customization,"change:todoVisible",this.visibleChanged),this.collection.isLegacy||m.conditionalFeatures.featureEnabled("prefetchtodos")?this.doFetchIfNeeded():this.collection.hasValidCachedCompletedCount()||this.doFetchIfNeeded(),1==JSON.parse(localStorage.showTodoList)&&(this.$el.toggleClass("show"),this.doFetchIfNeeded()),setTimeout(function(){try{if(m.conditionalFeatures.featureEnabled("plus")&&!localStorage.plus_first_load&&(localStorage.plus_first_load=!0,m.views.legacy.todos))try{m.views.legacy.todos.$el.hide(),m.views.legacy.todos.undelegateEvents(),m.views.legacy.todos.$el.removeData().unbind(),m.views.legacy.todos.remove(),Backbone.View.prototype.remove.call(m.views.legacy.todos),m.bootstrappers.RenderTodos(m,$)}catch(e){}}catch(e){}},500)},render:function(){if(!this.renderedOnce){var e=(this.options.order||"append")+"To";this.$el[e]("#"+this.options.region).fadeTo(0,0).html(this.template()).fadeTo(500,1),this.$placeholder=$("<li></li>").addClass("placeholder"),this.$placeholder.appendTo(this.el),this.$placeholder.hide(),this.updateTodoCount(),this.renderedOnce=!0,this.setMaxWidgetHeight()}return this},visibleChanged:function(e){var t=m.models.customization.get("todoVisible");t?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},setMaxWidgetHeight:function(){var e=$(window).height()-125;$(".pane").css("max-height",e);var t=$(".todo-pane");if(t){var i=t.find(".todo-header").outerHeight(),n=t.find(".todo-message").outerHeight(!0),o=t.find(".todo-new").outerHeight();0==i&&(i=34),null==n&&(n=0),0==o&&(o=39),t.find(".todo-list").css("max-height",e-(i+n+o))}return e},connectionOnline:function(){this.retryConnection()},doFetch:function(){this.initialFetchStarted=!0,this.collection.fetch({reset:!0})},doFetchIfNeeded:function(){if(!this.initialFetchStarted&&(this.doFetch(),m.conditionalFeatures.featureEnabled("localtodonotify"))){var e=this;window.addEventListener("storage",function(t){if(t.key&&0===t.key.indexOf("todos-updated")){if(e.fetching)return;e.fetching=!0,e.collection.fetch({success:function(){e.fetching=!1},error:function(){e.fetching=!1},reset:!0})}},!1)}},initializeGreetings:function(e){if(localStorage.greetings){var t=JSON.parse(atob(localStorage.greetings)),e=t.todo;e&&(e.none&&(this.emptyTodoGreetings=e.none),e.completed&&(this.completedTodoGreetings=e.completed))}this.emptyTodoGreetings||(this.emptyTodoGreetings=[{caption:"Nothing to do",message:"Add a todo to get started, "}]),this.completedTodoGreetings||(this.completedTodoGreetings=[{caption:"All done",message:"Great work, "},{caption:"All done",message:"Good job, "},{caption:"All done",message:"You are awesome, "},{caption:"All done",message:"Good one, "},{caption:"All done",message:"Good on ya, "},{caption:"All done",message:"Congratulations, "},{caption:"All done",message:"You did it, "}])},randomEmptyTodoGreetings:function(){if(this.initializeGreetings(),!this.emptyTodoGreeting){var e=Math.floor(Math.random()*this.emptyTodoGreetings.length);this.emptyTodoGreeting=this.emptyTodoGreetings.splice(e,1)[0]}return this.emptyTodoGreeting},randomCompletedTodoGreetings:function(){if(this.initializeGreetings(),!this.completedTodoGreeting){var e=Math.floor(Math.random()*this.completedTodoGreetings.length);this.completedTodoGreeting=this.completedTodoGreetings.splice(e,1)[0]}return this.completedTodoGreeting},addOne:function(e){var t=new m.views.legacy.Todo({model:e,parent:this});this.subViews.push(t),this.$(".todo-list").append(t.render().el),this.$el.find("#todo-new")[0].scrollIntoView(!1)},addAll:function(){_.each(this.subViews,function(e){e&&e.destroy()}),this.subViews=[],this.$(".todo-list").html(""),_.each(this.collection.activeToday(),this.addOne),_.each(this.proxyCollection.where({proxyValid:!0}),this.addOne),this.successfulConnection(),this.setMaxWidgetHeight()},displayConnectingText:function(e,t){e&&(this.connectingTextOverride=e),this.$el.find(".todo-count").html(this.connectingTextOverride?this.connectingTextOverride:'<i class="loading-icon"></i>Loading...'),this.$el.find(".todo-count").fadeIn(500)},collectionReset:function(){this.loadedOnce=!0,this.render(),this.addAll()},collectionRequest:function(e){this.loadedOnce||this.displayConnectingText('<i class="loading-icon"></i>Loading...')},collectionError:function(e,t,i){return 200===t.status?void this.successfulConnection():void this.failedConnection()},successfulConnection:function(){var e=this.offline;this.offline=!1,this.dismissConnectionError(),this.checkEmptyPaneState(),e&&this.trigger("connectionOnline")},failedConnection:function(e){this.offline=!0,this.displayConnectingText(e?e:'Trouble connecting… <span class="retry">Retry</span>'),this.checkEmptyPaneState()},handleInput:function(e){13==e.keyCode&&this.createOnEnter(),27==e.keyCode&&(e.stopPropagation(),this.$el.find("input").blur())},onClickRetry:function(e){e.preventDefault(),e.stopPropagation(),this.retryConnection()},retryConnection:function(){var e=this;this.loadedOnce?(_.each(this.proxyCollection.where({proxyValid:!0,saveFailed:!0,isLoading:!1}),function(t){e.createNewModel(t,!0)}),_.each(this.collection.where({saveFailed:!0,isLoading:!1}),function(t){e.saveToModel(t)})):this.collection.fetch({reset:!0})},createNewModel:function(e,t){var i=this;t?i.displayConnectingText('<i class="loading-icon"></i>Retrying...'):i.displayConnectingText('<i class="loading-icon"></i>Saving...'),e.set({saveFailed:!1,isLoading:!0}),i.collection.create({title:e.get("title")},{wait:!0,success:function(){i.successfulConnection(),e.set("proxyValid",!1),m.sendEvent("Todo","Add")},error:function(t,n,o){i.failedConnection('Error saving… <span class="retry">Retry</span>'),e.set({saveFailed:!0,isLoading:!1})}})},saveToModel:function(e,t){var i=this;i.displayConnectingText('<i class="loading-icon"></i>Saving...');var n=e.saveOptions();n.wait=!0,n.success=function(){var t={};jQuery.extend(t,e.attemptedSaveValues),e.attemptedSaveValues=null,jQuery.extend(t,{saveFailed:!1,isLoading:!1}),setTimeout(function(){e.set(t),i.successfulConnection()},50)},n.error=function(t,n,o){if(200==n.status){var s={};jQuery.extend(s,e.attemptedSaveValues),e.attemptedSaveValues=null,jQuery.extend(s,{saveFailed:!1,isLoading:!1}),setTimeout(function(){e.set(s),i.successfulConnection()},50)}else e.set({saveFailed:!0,isLoading:!1}),i.failedConnection('Error saving… <span class="retry">Retry</span>')},t?(e.attemptedSaveValues?jQuery.extend(e.attemptedSaveValues,t):e.attemptedSaveValues=t,e.save(t,n)):e.attemptedSaveValues&&(t=e.attemptedSaveValues,e.save(e.attemptedSaveValues,n)),jQuery.extend(t,{saveFailed:!1,isLoading:!0}),e.set(t)},createOnEnter:function(e){var t=this.$el.find("#todo-new")[0].value.trim();if(t){var i=this,n=new m.models.legacy.TodoProxy({title:t});this.proxyCollection.add(n),i.$el.find("#todo-new")[0].value="",this.createNewModel(n)}},dragover:function(e){return e.preventDefault(),e.stopPropagation(),e.originalEvent.dataTransfer.dropEffect="move",!1},dragend:function(e){return e.originalEvent.dataTransfer.dropEffect="move",e.preventDefault(),e.stopPropagation(),"todo"==this.dragmode&&(this.dragging.$el.show(),this.$placeholder.hide(),this.collection.trigger("reorder",{move_id:this.dragging.model.id,move_target_id:this.move_target_id,move_offset:this.move_offset})),!1},li_index:function(e){return this.$("li").index(e)},toggleShow:function(e){e&&e.preventDefault(),this.doFetchIfNeeded(),this.setMaxWidgetHeight(),$("#todo").toggleClass("show"),localStorage.showTodoList=!JSON.parse(localStorage.showTodoList),this.$el.find("#todo-new").focus()},showCompleted:function(e){e.preventDefault(),e.stopPropagation(),this.show_completed=!0,this.addAll()},hide:function(e){$("#todo").hasClass("show")&&this.toggleShow()},openList:function(e){this.$el.find(".todo-list-chooser-dropdown").show()},chooseList:function(e){this.$el.find(".todo-list-chooser-dropdown").hide()},revealConnectionError:function(){"none"===$(".error-message").css("display")&&$(".error-message").slideDown("slow")},dismissConnectionError:function(){"none"!=$(".error-message").css("display")&&$(".error-message").slideUp("slow")},collectionModelChanged:function(e){this.checkEmptyPaneState()},checkEmptyPaneState:function(){if(this.offline||this.show_completed)this.$el.find(".todo-pane").removeClass("is-empty"),this.$el.find(".todo-pane").css("min-height","");else if(0===this.collection.remaining().length)if(this.$el.find(".todo-pane").addClass("is-empty"),this.$el.find(".todo-pane").css("min-height",200),0===this.collection.completeToday().length){var e=this.randomEmptyTodoGreetings();this.$(".title").html(e.caption),m.models.customization.get("displayname")&&this.$(".description").html(e.message+m.models.customization.get("displayname"))}else{var t=this.randomCompletedTodoGreetings();this.$(".title").html(t.caption),m.models.customization.get("displayname")&&this.$(".description").html(t.message+m.models.customization.get("displayname")+"!")}else this.$el.find(".todo-pane").removeClass("is-empty"),this.$el.find(".todo-pane").css("min-height","");this.updateTodoCount()},updateTodoCount:function(){if(!this.offline){var e=this.collection.remaining().length;switch(e){case 0:;break;case 1:;break;default:}this.$(".todo-count").html(e+" to do"),this.$(".todo-count").removeClass("pulsetext")}}}),m.views.legacy.Todo=Backbone.View.extend({tagName:"li",className:"todo-item",template:m.templates.todos["todo-item-template"],events:{"click .todo-item-checkbox":"toggleDone","dblclick .view":"edit","click .destroy":"clear","keyup .edit":"handleInput","blur .edit":"abortEdit","click .error-icon":"retrySave",dragstart:"dragstart",dragenter:"dragenter",dragleave:"dragleave"},editing:!1,initialize:function(e){_.bindAll(this,"dragstart","dragenter","dragleave"),this.parent=e.parent,this.listenTo(this.model,"change",this.render)},render:function(){var e="",t=m.utils.captionFormatter(this.model.getValue("title"));if(done=this.model.getValue("done"),done)var e="checked";var i={title:t,checked:e};return this.$el.html(this.template(i)),this.$el.toggleClass("done",done),this.$el.toggleClass("loading",this.model.isTrue("isLoading")),this.$el.toggleClass("failed",this.model.isTrue("saveFailed")),this.model.isTrue("isProxy")?(this.$el.toggle(this.model.isTrue("proxyValid")),this.$el.addClass("isproxy"),this.$el.data("cid",this.model.cid)):this.$el.prop("draggable","true"),this},destroy:function(){this.remove(),this.unbind()},clear:function(){m.sendEvent("Todo","Delete"),this.$el.hide(),m.views.legacy.todos.saveToModel(this.model,{deleted:!0,deletedDate:new Date})},abortEdit:function(){this.editing=!1,this.$el.find(".edit").val(this.model.get("title")),this.$el.removeClass("editing")},saveEdit:function(){this.editing=!1;var e=this.$el.find(".edit").val();e?(this.$el.removeClass("editing"),m.views.legacy.todos.saveToModel(this.model,{title:e})):this.clear()},retrySave:function(){this.model.isTrue("isProxy")?m.views.legacy.todos.createNewModel(this.model,!0):this.model.attemptedSaveValues&&m.views.legacy.todos.saveToModel(this.model)},edit:function(e){this.$el.hasClass("isproxy")||this.$el.hasClass("loading")||this.$el.hasClass("failed")||(this.editing=!0,this.$el.addClass("editing"),this.$el.find(".edit").focus(),m.sendEvent("Todo","Activate Edit"))},dragstart:function(e){return this.editing?!1:(e.originalEvent.dataTransfer.effectAllowed="move",e.originalEvent.dataTransfer.setData("text","dummy"),this.parent.dragmode="todo",this.parent.dragging=this,void m.sendEvent("Todo","Reorder"))},dragenter:function(e){if("todo"==this.parent.dragmode){this.parent.dragging.$el.hide(),this.parent.li_index(this.parent.$placeholder)<this.parent.li_index(this.$el)?(this.$el.after(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=1):(this.$el.before(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=-1);var t=this.parent.$placeholder;this.parent.$placeholder.css("display","list-item"),t.height(this.$el.height()),t.after(this.parent.dragging.$el)}},dragleave:function(e){},toggleDone:function(){m.sendEvent("Todo","Done");var e=!this.model.get("done");m.views.legacy.todos.saveToModel(this.model,{done:e,completedDate:e?new Date:null})},handleInput:function(e){13==e.keyCode&&(this.saveEdit(),m.sendEvent("Todo","Edit")),27==e.keyCode&&(e.stopPropagation(),this.$el.find("input").blur())}}),m.views.legacy.TodosComplete=Backbone.View.extend({attributes:{id:"todo-complete","class":"metric"},template:m.templates.todos["todo-complete-template"],initialize:function(){this.listenTo(this.collection,"completedCountChanged",this.render),this.render()},render:function(){var e=this.collection.completedCount(),t="todos";1==e&&(t="todo");var i={done:e,item:t},n=(this.options.order||"append")+"To";return this.$el[n]("#"+this.options.region).html(this.template(i)).fadeTo(500,1),e?this.$el.show():this.$el.hide(),this}}),m.bootstrappers.RenderTodos=function(e,t){var i=e.conditionalFeatures.featureEnabled("enhancedtodo");i?e.conditionalFeatures.checkFeatureAndMigrateData("servertodos","todoVisible","momentum-todo",function(){e.views.todoPane=new e.views.TodoPane({region:"bottom-right",order:"append"}),e.widgets.push(e.views.todoPane)},function(){e.collect.legacy.todos=new e.collect.legacy.TodosLegacy,e.views.legacy.todos=new e.views.legacy.Todos({collection:e.collect.legacy.todos,region:"bottom-right",order:"append"}),e.widgets.push(e.views.legacy.todos)},function(t){e.listenToOnce(e.models.customization,"change:todoVisible",t)}):e.conditionalFeatures.checkFeatureAndMigrateData("servertodos","todoVisible","momentum-todo",function(){e.collect.legacy.todos=new e.collect.legacy.Todos,e.views.legacy.todos=new e.views.legacy.Todos({collection:e.collect.legacy.todos,region:"bottom-right",order:"append"}),e.widgets.push(e.views.legacy.todos)},function(){e.collect.legacy.todos=new e.collect.legacy.TodosLegacy,e.views.legacy.todos=new e.views.legacy.Todos({collection:e.collect.legacy.todos,region:"bottom-right",order:"append"}),e.widgets.push(e.views.legacy.todos)},function(t){e.listenToOnce(e.models.customization,"change:todoVisible",t)})},m.models.Weather=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("momentum-weather"),defaults:{location:"",woeid:"",fetchUnit:"c"}}),m.views.Weather=Backbone.View.extend({attributes:{id:"weather","class":"metric weather"},template:m.templates.weather.weather,events:{"dblclick .metric-stat":"toggleUnit","dblclick .location":"editLocation","keypress .location":"onKeypress","keydown .location":"onKeydown","blur .location":"saveLocation","webkitAnimationEnd .location":"onAnimationEnd"},initialize:function(){this.renderedOnce=!1;var e=(this.options.order||"append")+"To";this.$el[e]("#"+this.options.region).fadeTo(0,0),this.listenTo(this.model,"change",this.render),this.listenTo(m.models.customization,"change:temperatureUnit",this.render),this.updateWeather(),this.render(this.options.unitClass="hide"),this.listenTo(m.models.customization,"change:weatherVisible",this.visibleChanged),this.weatherTimer=setInterval(function(){this.updateWeather()}.bind(this),6e5)},render:function(){var e=this.calculateDisplayTemperature(),t=this.model.get("location");t&&0!=t.length||(t="location<br>unknown");var i={temperature:e,location:t,unit:this.displayUnit(),condition:this.model.get("condition"),code:this.getConditionFromCode(this.model.get("code")),unitClass:this.options.unitClass,message:this.model.get("error")},n=this.getManualWeatherLocation();i.message&&n&&(i.location=n.enteredLocation);var o=(this.options.order||"append")+"To";return this.$el[o]("#"+this.options.region).html(this.template(i)).fadeTo(500,1),this.$location=this.$(".location"),this.renderedOnce=!0,this},visibleChanged:function(e){var t=m.models.customization.get("weatherVisible");t?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},calculateDisplayTemperature:function(){var e=this.model.get("fetchTemperature");if(e){var t=this.model.get("fetchUnit");return"c"===this.displayUnit()?"c"===t?e:Math.round(5*(e-32)/9):"c"===t?Math.round(9*e/5+32):e}return null},displayUnit:function(){var e=m.models.customization.get("temperatureUnit");return e?e:"c"},editLocation:function(){this.$el.hasClass("editing")||(this.$location.attr("contenteditable",!0).addClass("editing pulse").focus(),setEndOfContenteditable(this.$location.get(0)))},onAnimationEnd:function(e){"pulse"===e.originalEvent.animationName&&this.$location.removeClass("pulse")},onKeypress:function(e){13==e.keyCode&&(e.preventDefault(),this.saveLocation())},onKeydown:function(e){27===e.keyCode&&(this.$location.html(this.model.get("location")),this.doneEditingLocation())},saveLocation:function(){var e=this.$location.html();if(e&&e.length>0){var t={enteredLocation:e,woeid:null,location_name:null};localStorage.setItem("manual-weather-location",JSON.stringify(t))}else localStorage.removeItem("manual-weather-location");this.doneEditingLocation(),this.updateWeather(),m.sendEvent("Weather","Set Manual Location")},doneEditingLocation:function(){this.$location.attr("contenteditable",!1).removeClass("editing").addClass("pulse")},toggleUnit:function(){this.options.unitClass="","c"===this.displayUnit()?m.models.customization.save("temperatureUnit","f"):m.models.customization.save("temperatureUnit","c")},setUnit:function(e){var t=["US","BM","BZ","JM","PW"];t.indexOf(e)>=0?this.model.save("fetchUnit","f"):this.model.save("fetchUnit","c")},updateWeather:function(){m.commandManager.execute("weather.update",this.model)},getManualWeatherLocation:function(){var e=localStorage.getItem("manual-weather-location");return e?JSON.parse(e):null},getConditionFromCode:function(e){var t={};return t[0]="F",t[1]="F",t[2]="F",t[3]="O",t[4]="P",t[5]="X",t[6]="X",t[7]="X",t[8]="X",t[9]="Q",t[10]="X",t[11]="R",t[12]="R",t[13]="U",t[14]="U",t[15]="U",t[16]="W",t[17]="X",t[18]="X",t[19]="J",t[20]="M",t[21]="J",t[22]="M",t[23]="F",t[24]="F",t[25]="G",t[26]="Y",t[27]="I",t[28]="H",t[29]="E",t[30]="H",t[31]="C",t[32]="B",t[33]="C",t[34]="B",t[35]="X",t[36]="B",t[37]="O",t[38]="O",t[39]="O",t[40]="R",t[41]="W",t[42]="U",t[43]="W",t[44]="H",t[45]="O",t[46]="W",t[47]="O",t[3200]=")",t[e]}}),m.bootstrappers.RenderWeather=function(e,t){e.conditionalFeatures.checkPreferenceForRender("weatherVisible",function(){e.models.weather=new e.models.Weather({id:1}),e.models.weather.fetch(),e.views.weather=new e.views.Weather({model:e.models.weather,region:"top-right",order:"append"}),e.widgets.push(e.views.weather)},function(t){e.listenToOnce(e.models.customization,"change:weatherVisible",t)})},m.models.Message=Backbone.Model.extend({defaults:function(){return{title:null,message:"",priority:5,views:0,viewLimit:3,deleted:!1,createdDate:Date.now(),visible:!1,loginOnClick:!1,fromServer:!1}},showMessage:function(e,t,i,n){m.commandManager.execute("notification.show.enhanced",{title:e,message:t,views:0,viewLimit:i,visible:!0,loginOnClick:n})},showMessageNow:function(e,t,i,n){m.commandManager.execute("notification.show.enhanced",{title:e,message:t,views:0,viewLimit:i,visible:!0,loginOnClick:n})},dismissMessage:function(){m.commandManager.execute("notification.dismiss")},save:function(e,t){if(t||(t={}),e||(e=_.clone(this.attributes)),e.hasOwnProperty("dismissed")&&e.dismissed&&(e.deleted=!0),!t.download_save&&this.get("fromServer"))try{var i=null;for(prop in e)e.hasOwnProperty(prop)&&"changed_props"!=prop&&"sync_success"!=prop&&(i||(i=this.get("changed_props")||[]),_.contains(i,prop)||i.push(prop));i&&(e.changed_props=i,e.sync_success=!1,t.silent=!1)}catch(n){}return Backbone.Model.prototype.save.call(this,e,t)}}),m.collect.Messages=Backbone.Collection.extend({localStorage:new Backbone.LocalStorage("momentum-messages"),model:m.models.Message,cleaned:!1,initialize:function(){this.listenTo(this,"reset",this.cleanupMessagesIfRequired)},cleanupMessagesIfRequired:function(){if(!this.cleaned){this.cleaned=!0;var e=[];this.each(function(t){if(t.get("deleted"))t.get("fromServer")&&t.get("sync_success")&&!t.get("changed_props")&&e.push(t);else{var i=t.get("filter");i&&m.conditionalFeatures.featureEnabled(i)?t.save({deleted:!0,filtered:!0}):5==t.get("priority")?t.get("fromServer")?t.save({deleted:!0}):e.push(t):t.get("visible")||t.save({deleted:!0})}}),e.length>0&&_.each(e,function(e){e.destroy()})}}}),m.models.NotificationSync=Backbone.Model.extend({baseUrl:m.globals.urlRootApi+"notifications",initialize:function(e){this.collection=e.collection,this.listenTo(this.collection,"change:changed_props",this.onChange),this.listenTo(this.collection,"reset",this.onReset)},findHavingAttribute:function(e,t){return e.filter(function(e){return e.has(t)})},hasAttribute:function(e,t){return!!e.find(function(e){return e.has(t)})},onReset:function(){this.syncToServer()},onChange:function(e,t){if(!t.ignoreSave){var i=e.changedAttributes();i&&i.hasOwnProperty("changed_props")&&i.changed_props&&this.syncToServer()}},syncToServer:function(e){var t=this,i=this.findHavingAttribute(this.collection,"changed_props");return i&&0!=i.length?void nimble.each(i,function(e,i){if(e.get("fromServer")){var n=e.get("changed_props");if(!n||0==n.length)return void i();var o={};
if(_.each(n,function(t){"changed_props"!=t&&"sync_success"!=t&&(o[t]=e.get(t))}),1==Object.keys(o).length&&o.hasOwnProperty("views"))return void i();var s=t.baseUrl+"/"+encodeURIComponent(e.id);$.ajax({url:s,contentType:"application/json",type:"PATCH",beforeSend:m.utils.setMomentumAuthHeader,data:JSON.stringify(o)}).done(function(t){t&&t.success&&e.save({changed_props:null,sync_success:!0},{silent:!0})}).fail(function(t,i){e.save({sync_success:!1},{silent:!0})}).always(function(){i()})}},function(){e&&e()}):void(e&&e())}}),m.models.NotificationManager=Backbone.Model.extend({backgroundLoaded:!1,_notificationView:null,_parent:null,settingsVisible:!1,initialize:function(){this.displayed=[],this.collection=new m.collect.Messages,m.models.message=new m.models.Message,this.listenTo(this.collection,"add reset",this.displayPendingMessages),this.listenToOnce(m,"background:loadSuccessful",this.onBackgroundLoaded),this.listenTo(m,"settings:hidden",this.settingsHidden),this.listenTo(m,"settings:visible",this.onSettingsVisible),this.listenTo(m,"notifications:timestamp",this.onAvailableTimestamp),m.conditionalFeatures.featureEnabled("notifySyncOff")||(this.notifySync=new m.models.NotificationSync({collection:this.collection})),this.collection.fetch({reset:!0})},onBackgroundLoaded:function(){this.backgroundLoaded||(this.backgroundLoaded=!0,this.displayPendingMessages(),m.commandManager.execute("clean.localstorage"))},displayPendingMessages:function(){var e=this;if(this.collection.cleanupMessagesIfRequired(),this._parent&&this.backgroundLoaded&&!this.settingsVisible){var t=this.notificationView();if(t&&!t.notifying){var i=_.chain(this.collection.where({deleted:!1,visible:!0})).reject(function(t){var i=t.get("filter");return i&&m.conditionalFeatures.featureEnabled(i)?!0:_.contains(e.displayed,t)}).sortBy("priority").sortBy("createdDate").value();if(i&&0!=i.length){var n=i[0];this.displayed.push(n),t.showMessage(n)}}}},setParent:function(e){e&&(this._parent=e,this.displayPendingMessages())},onAvailableTimestamp:function(e){if(e){var t=localStorage.getItem("ts_notifications");(!t||e>t)&&this.downloadNotifications()}},downloadNotifications:function(){var e=this,t=localStorage.getItem("ts_notifications"),i=m.globals.urlRootApi+"notifications";t&&(t=parseInt(t,10),Number.isInteger(t)&&(i=i+"?ts="+t));try{$.ajax({type:"GET",contentType:"application/json",beforeSend:setMomentumAuthHeader,url:i}).done(function(t){t&&t.timestamp&&(t.notifications&&t.notifications.length>0&&(e.collection.reset(t.notifications),e.collection.invoke("save",null,{download_save:!0})),localStorage.setItem("ts_notifications",t.timestamp))}).fail(function(e,t){})}catch(n){}},showMessage:function(e,t,i,n){var o={title:e,message:t,visible:!0};void 0!=i&&(o.viewLimit=i),void 0!=n&&(o.loginOnClick=n),this.collection.create(o)},showMessageEnhanced:function(e,t,i){e.hasOwnProperty("visible")||(e.visible=!0);var n={};t&&(n.success=t),i&&(n.silent=!0),this.collection.create(e,n)},dismissMessage:function(){this._notificationView&&this.notificationView().hideNotification()},settingsHidden:function(){this.settingsVisible=!1,this.displayPendingMessages()},onSettingsVisible:function(){this.settingsVisible=!0},notificationView:function(){return this._notificationView||(this._notificationView=new m.views.Notification({_parent:this._parent})),this._notificationView}}),m.views.Notification=Backbone.View.extend({attributes:{"class":"notification-container"},template:m.templates.notification.notification,notifying:!1,timeoutId:null,events:{"click .hide":"hideNotificationClicked","click .notification-button":"ctaButtonClicked","click .secondary-text":"secondaryTextClicked"},initialize:function(e){this._parent=e._parent,this.renderedOnce=!1,this.listenTo(m,"settings:visible",this.settingsVisible)},showMessage:function(e){this.model&&this.model.cid==e.cid||(this.model=e,this.render())},render:function(){var e=this;this.notifying=!0,this.incrementViews(),this.renderedOnce?this.$el.fadeTo(0,0).html(this.template(this.model.toJSON())).fadeTo(500,1):(e.$el.html(e.template(e.model.toJSON())).fadeTo(500,1),this._parent.$el.append(e.$el),this.$message=this.$(".notification-description"),this.renderedOnce=!0),this.model.has("message_html")&&this.$message.html(this.model.get("message_html"));var t=this.model.get("display_time");!t||null==t||void 0===t||0>=t||(this.timeoutId=setTimeout(function(){e.hideNotification()},t))},incrementViews:function(){var e=this.model.get("views")+1;e>=this.model.get("viewLimit")?this.model.save({visible:!1,views:e}):this.model.save({views:e},{silent:!0})},settingsVisible:function(){this.hideNotification(!0,!0)},hideNotificationClicked:function(e){e.stopPropagation(),this.hideNotification(),this.model.save({dismissed:!0,visible:!1},{silent:!0})},hideNotification:function(e,t){var i=this;if(clearTimeout(this.timeoutId),this.notifying){var n=t?0:500;this.notifying=!1,this.$el.fadeTo(n,0,function(){i.$el.hide(),e||setTimeout(function(){m.models.notificationManager.displayPendingMessages()},500)})}},ctaButtonClicked:function(e){e.stopPropagation(),this.hideNotification(!0,!0),this.notifying=!1;var t=this.model.get("cta_cmd"),i=this.model.get("cta_options");t&&t.length>0&&(this.model.save({ctaClicked:Date.now(),visible:!1},{silent:!0}),m.commandManager.execute(t,null,i))},secondaryTextClicked:function(e){e.stopPropagation(),this.model.get("secondary_hide")&&(this.hideNotification(!0,!0),this.notifying=!1);var t=this.model.get("secondary_cmd"),i=this.model.get("secondary_options");t&&t.length>0&&(this.model.save({secondaryClicked:Date.now()},{silent:!0}),m.commandManager.execute(t,null,i))}}),m.commands.NotificationShow=m.models.Command.extend({defaults:{id:"notification.show"},execute:function(e,t){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.showMessage(e,t)},10)}}),m.commands.NotificationShowEnhanced=m.models.Command.extend({defaults:{id:"notification.show.enhanced"},execute:function(e,t,i){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.showMessageEnhanced(e,t,i)},10)}}),m.commands.NotificationDismiss=m.models.Command.extend({defaults:{id:"notification.dismiss"},execute:function(){setTimeout(function(){m.models.notificationManager&&m.models.notificationManager.dismissMessage()},5)}}),m.models.QuickLinks=Backbone.Model.extend({defaults:function(){return{title:"New Link",url:"",local:!1,order:0}},saveOptions:function(){return this.collection.saveOptions},saveNewOrder:function(e){this.save({order:e},this.saveOptions())},comparator:"order"}),m.collect.QuickLinksBase=Backbone.Collection.extend({model:m.models.QuickLinks,initialize:function(){this.listenTo(this,"reorder",this.reorderItem)},saveOptions:{},nextOrder:function(){return this.length?this.last().get("order")+100:100},comparator:"order",reorderItem:function(e){}}),m.collect.QuickLinks=m.collect.QuickLinksBase.extend({url:m.globals.urlRoot+"links",saveOptions:{patch:!0},reorderItem:function(e){var t={operations:[{REORDER:{move_id:e.move_id,move_target_id:e.move_target_id,move_offset:e.move_offset}}]};$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(t),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"links"}).done(function(e){}).fail(function(e,t){})}}),m.collect.QuickLinksLegacy=m.collect.QuickLinksBase.extend({localStorage:new Backbone.LocalStorage("momentum-quicklinks"),isLegacy:!0,fetch:function(e){var t=Backbone.Collection.prototype.fetch.call(this,e);return 0!==this.length||localStorage.gmailLinkAdded||(this.create({title:"Gmail",url:"http://mail.google.com/"}),localStorage.gmailLinkAdded=!0),t},createOrderGaps:function(){var e=100;this.each(function(t){t.save({order:e},{silent:!0}),e+=100})},reorderItem:function(e){var t=this.get(e.move_id),i=this.get(e.move_target_id),n=e.move_offset>0?1:-1,o=this.indexOf(i),s=1;if(o+n>=0&&o+n<this.length){var a=this.at(o+n);s=Math.abs(a.get("order")-i.get("order")),20>=s&&(this.createOrderGaps(),s=Math.abs(a.get("order")-i.get("order")))}var l=i.get("order")+Math.ceil(s/2)*n;t.save({order:l},{silent:!0})}}),m.views.QuickLinks=Backbone.View.extend({attributes:{id:"quicklinks","class":"quicklinks top-widget"},template:m.templates.quicklinks["quicklinks-template"],offline:!0,initialFetchStarted:!1,events:{"click .quicklinks-show":"toggleShow","keypress #quicklinks-new-url":"createLink","keypress #quicklinks-new-title":"createLink","click .add":"showAdd","click .hide":"hideUsageHint","click .local":"handleLocal","click .retry":"retryConnection","click .quicklinks-new":"inputsClicked",dragover:"dragover",dragend:"dragend"},initialize:function(){this.subViews=[],_.bindAll(this,"addOne","addAll","dragover","dragend","li_index"),this.renderedOnce=!1,this.render(),this.listenTo(m,"globalEvent:click globalEvent:esc",this.hide),this.listenTo(m,"globalEvent:toggleQuickLinks",this.toggleShow),this.listenTo(this.collection,"add",this.addOne),this.listenTo(this.collection,"reset",this.collectionReset),this.listenTo(this.collection,"error",this.collectionError),this.listenTo(m.models.customization,"change:linksVisible",this.visibleChanged),(this.collection.isLegacy||m.conditionalFeatures.featureEnabled("prefetchlinks"))&&this.doFetchIfNeeded()},render:function(){var e=(this.options.order||"append")+"To";return this.$placeholder=$("<li></li>").addClass("placeholder"),this.$placeholder.appendTo(this.el),this.$placeholder.hide(),this.$el[e]("#"+this.options.region).html(this.template()).fadeTo(500,1),this.$connectionmessage=this.$el.find(".connection-message"),this.$connectionmessage.show(),this.renderedOnce=!0,this},destroy:function(){this.remove(),this.unbind()},visibleChanged:function(e){var t=m.models.customization.get("linksVisible");t?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},doFetch:function(){this.initialFetchStarted=!0,this.collection.fetch({reset:!0})},doFetchIfNeeded:function(){this.initialFetchStarted||this.doFetch()},hideUsageHint:function(e){e.preventDefault(),e.stopPropagation(),m.models.customization.save({linksHintHidden:!0}),this.checkUsageHint()},collectionError:function(e,t,i){return 200===t.status?void this.successfulConnection():void this.failedConnection()},showAdd:function(e){e.preventDefault(),e.stopPropagation(),this.$el.find("#quicklinks-new-title").val(""),this.$el.find("#quicklinks-new-url").val(""),this.$el.find(".add").addClass("active"),this.$el.find(".quicklinks-new").toggle().find("#quicklinks-new-title").focus()},inputsClicked:function(e){e.stopPropagation()},retryConnection:function(e){e.preventDefault(),e.stopPropagation(),this.collection.fetch({reset:!0})},collectionReset:function(){this.addAll()},revealConnectionError:function(){"none"===$(".error-message").css("display")&&$(".error-message").slideDown("slow")},dismissConnectionError:function(){"none"!=$(".error-message").css("display")&&$(".error-message").slideUp("slow")},addOne:function(e){var t=new m.views.QuickLink({model:e,parent:this});this.subViews.push(t),this.$(".quicklinks-pane ol").append(t.render().$el)},addAll:function(){this.offline=!1,_.each(this.subViews,function(e){e&&e.destroy()}),this.subViews=[],this.collection.each(this.addOne),this.successfulConnection()},successfulConnection:function(){this.$connectionmessage.hide(),this.dismissConnectionError(),this.checkUsageHint()},failedConnection:function(){this.$el.find(".connection-message").html('Trouble connecting… <span class="message-action">Retry</span>'),this.$el.find(".connection-message").show(),this.checkUsageHint()},createLink:function(e){if(13==e.keyCode){var t=this.$el.find("#quicklinks-new-title")[0].value,i=this.$el.find("#quicklinks-new-url")[0].value;if(!t){var n=this;return this.$el.find("#quicklinks-new-title").addClass("pulse"),void _.delay(function(){n.$el.find("#quicklinks-new-title").removeClass("pulse")},1e3)}if(!i){var n=this;return this.$el.find("#quicklinks-new-url").addClass("pulse"),void _.delay(function(){n.$el.find("#quicklinks-new-url").removeClass("pulse")},1e3)}if(this.offline)return void this.revealConnectionError();var o=!1;/^chrome|chrome-extension|chrome-search:\/\//i.test(i)&&(o=!0),i=ensureUrlScheme(i),m.sendEvent("Quick Links","Add");var n=this,s=0;if(this.collection.length>0){var a=this.collection.max(function(e){return e.get("order")});s=a.get("order")+100}this.collection.create({title:t,url:i,local:o,order:s},{wait:!0,success:function(){n.successfulConnection(),n.$el.find(".add").removeClass("active"),n.$el.find(".quicklinks-new").css("display","none")},error:function(e,t,i){n.failedConnection(),n.revealConnectionError()}})}},dragover:function(e){return e.preventDefault(),e.stopPropagation(),e.originalEvent.dataTransfer.dropEffect="move",!1},dragend:function(e){return e.originalEvent.dataTransfer.dropEffect="move",e.preventDefault(),e.stopPropagation(),"quicklink"==this.dragmode&&(this.dragging.$el.show(),this.$placeholder.hide(),this.collection.trigger("reorder",{move_id:this.dragging.model.id,move_target_id:this.move_target_id,move_offset:this.move_offset})),!1},toggleShow:function(e){e&&(e.preventDefault(),e.stopPropagation()),m.trigger("globalEvent:click",this),this.doFetchIfNeeded(),this.setMaxWidgetHeight(),$("#quicklinks").toggleClass("show")},hide:function(e){e!=this&&$("#quicklinks").hasClass("show")&&($("#quicklinks").removeClass("show"),this.$el.find(".quicklinks-new").css("display","none"),this.$el.find(".add").removeClass("active"))},li_index:function(e){return this.$("li").index(e)},urlInvalid:function(){var e=this;this.$el.find("#quicklinks-new-url").addClass("pulse"),_.delay(function(){e.$el.find("#quicklinks-new-url").removeClass("pulse")},1e3)},handleLocal:function(e){e.preventDefault(),m.sendEvent("Quick Links","Local Link"),chrome.tabs.update({url:e.currentTarget.href})},setMaxWidgetHeight:function(){var e=$(window).height()-125;this.$el.find(".quicklinks-pane").css("max-height",e)},checkUsageHint:function(){var e=m.models.customization.get("linksHintHidden");this.offline||e?this.$el.find(".link-hint").hide():this.$el.find(".link-hint").show()}}),m.views.QuickLink=Backbone.View.extend({tagName:"li",template:m.templates.quicklinks["quicklinks-item-template"],events:{"keypress .todo-input":"updateOnEnter","click .destroy":"delete",dragstart:"dragstart",dragenter:"dragenter",click:"handleClick","click .local":"handleLocal"},initialize:function(e){_.bindAll(this,"dragstart","dragenter"),this.parent=e.parent,this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"change:archive destroy",this.remove)},render:function(){var e=this,t=m.utils.captionFormatter(this.model.get("title")),i=this.model.get("url"),n=this.model.get("local"),o=new Image;return o.src="https://icons.duckduckgo.com/ip2/encrypted."+detachUrlScheme(i)+".ico",o.onload=function(){var s={title:t,url:i,local:n};48!==o.width?s.favicon_url="https://icons.duckduckgo.com/ip2/encrypted."+detachUrlScheme(i)+".ico":s.favicon_url="https://icons.duckduckgo.com/ip2/"+detachUrlScheme(i)+".ico",e.$el.html(e.template(s)),e.$el.prop("draggable","true")},e},"delete":function(){m.sendEvent("Quick Links","Delete"),this.model.destroy()},dragstart:function(e){e.originalEvent.dataTransfer.effectAllowed="move",e.originalEvent.dataTransfer.setData("text","dummy"),this.parent.dragmode="quicklink",this.parent.dragging=this},dragenter:function(e){if("quicklink"==this.parent.dragmode){this.parent.dragging.$el.hide(),this.parent.li_index(this.parent.$placeholder)<this.parent.li_index(this.$el)?(this.$el.after(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=1):(this.$el.before(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=-1);var t=this.parent.$placeholder;this.parent.$placeholder.css("display","list-item"),t.height(this.$el.height()),t.after(this.parent.dragging.$el)}},handleClick:function(e){e.stopPropagation()},updateOnEnter:function(e){13==e.keyCode&&this.close($(e.currentTarget).data("field"))}}),m.bootstrappers.RenderQuickLinks=function(e,t){e.conditionalFeatures.checkFeatureAndMigrateData("serverlinks","linksVisible","momentum-quicklinks",function(){e.collect.quicklinks=new e.collect.QuickLinks,e.views.quicklinks=new e.views.QuickLinks({collection:e.collect.quicklinks,region:"top-left",order:"prepend"}),e.widgets.push(e.views.quicklinks)},function(){e.collect.quicklinks=new e.collect.QuickLinksLegacy,e.views.quicklinks=new e.views.QuickLinks({collection:e.collect.quicklinks,region:"top-left",order:"prepend"}),e.widgets.push(e.views.quicklinks)},function(t){e.listenToOnce(e.models.customization,"change:linksVisible",t)})},m.models.Customization=Backbone.Model.extend({localStorage:new Backbone.LocalStorage("momentum-customization"),defaults:{linksVisible:!0,focusVisible:!0,todoVisible:!0,weatherVisible:!0,quoteVisible:!0,searchVisible:!1,requestSync:!1,keepTodoState:!0,countdownVisible:!1,themeColour:"dark",autoFocus:!1},initialize:function(){var e=this;e.fetching=!1,this.listenToOnce(this,"sync",this.migrateOldSettings),window.addEventListener("storage",function(t){t.key&&0===t.key.indexOf("momentum-customization-1")&&(e.fetching=!0,e.fetch({success:function(){e.fetching=!1},error:function(){e.fetching=!1},reset:!0}))},!1)},toggle:function(e){if(e){var t=!this.get(e),i={};i[e]=t,this.save(i)}},migrateOldSettings:function(e){if(void 0===this.get("hour12clock")&&(localStorage.hour12clock?(this.save({hour12clock:JSON.parse(localStorage.hour12clock||!0)}),localStorage.removeItem("hour12clock")):this.save({hour12clock:!0})),void 0===this.get("displayname")&&(localStorage.name?(this.save({displayname:localStorage.name}),localStorage.removeItem("name")):this.save({displayname:null})),void 0===this.get("linksHintHidden")&&(localStorage.linksHintHidden?(this.save({linksHintHidden:JSON.parse(localStorage.linksHintHidden||!1)}),localStorage.removeItem("linksHintHidden")):this.save({linksHintHidden:!1})),void 0===this.get("temperatureUnit")){var t=JSON.parse(localStorage.getItem("momentum-weather-1"));if(t){var i=t.unit;i?this.save({temperatureUnit:i}):this.save({temperatureUnit:"c"})}else this.save({temperatureUnit:"c"})}}}),m.models.Settings=Backbone.Model.extend({defaults:{},initialize:function(){}}),m.models.GenericSettings=Backbone.Model.extend({initialize:function(e){this.url=m.globals.urlRoot+e},save:function(e,t){t=t||{},t.patch=!0,Backbone.Model.prototype.save.call(this,e,t)},toggle:function(e){var t={};this.has(e)?t[e]=!this.get(e):t[e]=!0,this.save(t)}}),m.collect.Settings=Backbone.Collection.extend({model:m.models.Settings,saveOptions:{patch:!0},initialize:function(){}}),m.views.settings=m.views.settings||{},m.views.settings.panels=m.views.settings.panels||{},m.views.settings.SettingsPanel=Backbone.View.extend({initialize:function(){},render:function(){var e={};return this.$el.html(this.template(e)),this},close:function(){this.remove(),this.unbind(),this.panelClosing()},panelClosing:function(){}}),m.views.settings=m.views.settings||{},m.views.settings.MainSettings=Backbone.View.extend({attributes:{id:"settings-main","class":"settings-container"},template:m.templates.settings.main,events:{"click .hide":"hideSettings",wheel:"onWheel"},detailsShown:!1,initialize:function(){this.subViews=[],this.renderedOnce=!1,this.visible=!1},render:function(){return this.visible?(this.renderedOnce||(this.$el.html(this.template()).fadeTo(500,1),this.navMenu=new m.views.settings.NavMenu({el:this.$("#nav-menu")}),this.listenTo(this.navMenu,"navItemClicked",this.navItemClicked),this.renderedOnce=!0,this.visible||this.$el.hide()),this.renderActivePanel(),this):void 0},onWheel:function(e){if(0!=e.originalEvent.deltaY){if(this.patchWheelEvents)return this.$popBody[0].scrollTop=this.$popBody.scrollTop()+e.originalEvent.deltaY,void e.preventDefault();if(!this.testingWheelEvents){var t=this,i=this.$popBody.scrollTop();this.testingWheelEvents=!0,setTimeout(function(){var n=t.$popBody.scrollTop();i==n?(t.patchWheelEvents=!0,t.$popBody[0].scrollTop=t.$popBody.scrollTop()+e.originalEvent.deltaY):$(t.el).off("wheel"),t.testingWheelEvents=!1},20)}}},renderActivePanel:function(){this.activePanel&&(this.$container=this.$(".subpanel-container"),this.activePanel.render().$el.detach().appendTo(this.$container),this.$popBody=this.$container.find(".pop-body"))},navItemClicked:function(e){var t=this.getNavItem(e);t&&t.cmd&&t.cmdonly?(this.setActiveNavItem(e),m.commandManager.ensureCommandLoaded(t.cmd,function(){t.hide&&m.commandManager.execute("settings.hide"),m.commandManager.execute(t.cmd,t.options)},function(){},function(e){})):this.activateSection(e,{source:"nav-"+e})},toggleVisible:function(){this.visible?this.hideSettings():this.showSettings()},hideSettings:function(){this.$el.is(":visible")&&(this.visible=!1,m.trigger("settings:hidden"),this.$el.hide(),this.activePanel&&this.activePanel.close())},showSettings:function(e){this.visible=!0,m.commandManager.execute("settings.cache.upgradecopy"),this.renderedOnce||this.render(),m.trigger("settings:visible"),e&&e.section?this.activateSection(e.section,e):this.activateSection("general"),this.$el.show()},getNavItem:function(e){var t=m.settingsManager.getNavItems(),i=_.findWhere(t.navItems,{id:e});return i||(i=_.findWhere(t.secondaryNavItems,{id:e})),i},getPanel:function(e){var t=m.settingsManager.getPanelItems();return _.findWhere(t,{id:e})},showLoadingPanel:function(e){this.loadingPanel||(this.loadingPanel=new m.views.settings.panels.Loading),"loading"!=this.activePanelId&&this.setActivePanel(this.loadingPanel,"loading",null),this.loadingPanel.setDisplayOptions(e),this.renderActivePanel()},setActivePanel:function(e,t,i){e&&(this.activePanel&&this.activePanel.close(),this.activePanel=e,this.activePanelId=t,this.activePanelOptions=i)},setActiveNavItem:function(e){$(".main-nav-item").removeClass("active");var t=this.getNavItem(e);t||(t=this.getPanel(e)),t&&t.section?$('li[data-navitem="'+t.section+'"]').addClass("active"):$('li[data-navitem="'+e+'"]').addClass("active")},activateSection:function(e,t){var i=this;if(e){t&&t.nav?this.setActiveNavItem(t.nav):this.setActiveNavItem(e);var n=this.getNavItem(e);n||(n=this.getPanel(e));var o=null,s=!1,a=!1,l=!1;if(n&&n.cmd)m.commandManager.ensureCommandLoaded(n.cmd,function(){s=!0,o=m.commandManager.execute(n.cmd,t),i.setActivePanel(o,e,t),i.renderActivePanel()},function(){a||s||(a=!0,setTimeout(function(){l||s||i.showLoadingPanel()},400))},function(n){a=!0,l=!0,i.showLoadingPanel({error:"We were unable to load settings.",retryInfo:{id:e,options:t}})});else{if(o=_.findWhere(this.subViews,{panelid:e}),!o){var r=e.charAt(0).toUpperCase()+e.slice(1),d=m.views.settings.panels[r];d&&(o=new d(t))}this.setActivePanel(o,e,t),this.renderActivePanel()}}}}),m.views.settings=m.views.settings||{},m.views.settings.ColorPicker=Backbone.View.extend({template:m.templates.settings["color-picker"],active:!1,attributes:{"class":"color-picker"},events:{"click .swatch":"handleClick"},initialize:function(e,t,i){this.listenTo(m,"globalEvent:settingsclick",this.settingsClick),this.settingName=e,this.optionValue=t,this.options=i,this.options.ignoreClick&&delete this.events["click .swatch"]},render:function(){this.$el.html(this.template()),this.delegateEvents(),this.$swatch=this.$el.find(".swatch").first();var e=m.models.themeManager.getThemeColourRGBA(this.settingName);return this.$swatch.css({backgroundColor:e}),this.picker&&(this.$picker=this.picker.render().$el,this.$el.append(this.$picker)),this},scrollIntoViewElement:function(){return this.$picker&&this.active?this.$picker.find(".cp-color-picker").first()[0]:!1},settingsClick:function(e){var t=$(e.target).closest(".cp-color-picker");if(!(t.length>0)){var i=$(e.currentTarget).data("option-value");i&&i==this.optionValue||this.dismiss()}},setActive:function(){this.active=!0},setInactive:function(){this.active=!1},dismiss:function(){this.$picker&&(this.$picker.hide(),this.$picker.is(":visible")&&m.models.themeManager.saveThemeColour())},ignoreClickEvent:function(e){return"swatch"!=e.className&&"color-picker"!=e.className},handleClick:function(e,t){if(this.active||t){e.stopPropagation();var i=this;if(this.picker)this.$picker&&(this.$picker.toggle(),this.$picker.is(":visible")?(this.picker.setSizes(),this.picker.preRender(!0)):m.models.themeManager.saveThemeColour());else{var n={light:"#fff",dark:"#fff",renderCallback:function(e){if(e){var t=e.colors,n=m.models.themeManager.toRgbA(t);i.$swatch.css({backgroundColor:n,color:t.RGBLuminance>.22?"#222":"#ddd"}),m.models.themeManager.setColorValues(this.settingName,t)}}},o=m.models.themeManager.getThemeColourRGBA(this.settingName);o&&(n.color=o),this.picker=new m.views.settings.ColorPickerPopup(n),this.$picker=this.picker.render().$el,this.$el.append(this.$picker),this.picker.setSizes(),this.picker.preRender(!0)}}},close:function(){m.models.themeManager.saveThemeColour(),this.dismiss()}}),m.views.settings=m.views.settings||{},m.views.settings.SettingsPane=Backbone.View.extend({attributes:{id:"preferences","class":"preferences"},renderedOnce:!1,events:{"click .toggle":"toggleShow"},libraryLoadStarted:!1,initialize:function(){this.subViews=[],this.render(),this.listenTo(m,"globalEvent:esc globalEvent:click",this.hideSettings),this.listenTo(m,"globalEvent:toggleSettings",this.toggleShow),this.listenTo(m,"settings:visible",this.settingsVisible),this.listenTo(m,"settings:hidden",this.settingsHidden)},render:function(){var e=this;if(!this.renderedOnce){var t='<span class="toggle"><svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 340.274 340.274"><path d="M293.629 127.806l-5.795-13.739c19.846-44.856 18.53-46.189 14.676-50.08l-25.353-24.77-2.516-2.12h-2.937c-1.549 0-6.173 0-44.712 17.48l-14.184-5.719c-18.332-45.444-20.212-45.444-25.58-45.444h-35.765c-5.362 0-7.446-.006-24.448 45.606l-14.123 5.734C86.848 43.757 71.574 38.19 67.452 38.19l-3.381.105-27.27 26.737c-4.138 3.891-5.582 5.263 15.402 49.425l-5.774 13.691C0 146.097 0 147.838 0 153.33v35.068c0 5.501 0 7.44 46.585 24.127l5.773 13.667c-19.843 44.832-18.51 46.178-14.655 50.032l25.353 24.8 2.522 2.168h2.951c1.525 0 6.092 0 44.685-17.516l14.159 5.758c18.335 45.438 20.218 45.427 25.598 45.427h35.771c5.47 0 7.41 0 24.463-45.589l14.195-5.74c26.014 11 41.253 16.585 45.349 16.585l3.404-.096 27.479-26.901c3.909-3.945 5.278-5.309-15.589-49.288l5.734-13.702c46.496-17.967 46.496-19.853 46.496-25.221V151.88c-.005-5.519-.005-7.446-46.644-24.074zM170.128 228.474c-32.798 0-59.504-26.187-59.504-58.364 0-32.153 26.707-58.315 59.504-58.315 32.78 0 59.43 26.168 59.43 58.315-.006 32.177-26.656 58.364-59.43 58.364z" fill="#FFF"/></svg></span>',i=(this.options.order||"append")+"To";this.$el[i]("#"+this.options.region).fadeTo(0,0).html(t).fadeTo(500,1),this.renderedOnce=!0,m.views.settings.mainSettings=new m.views.settings.MainSettings,setTimeout(function(){e.$el.append(m.views.settings.mainSettings.$el)},100),this.$el.toggleClass("infinispin",m.settingsManager.infinispin())}return this},toggleShow:function(e){e&&(e.preventDefault(),e.stopPropagation()),m.trigger("globalEvent:click",this),m.commandManager.execute("settings.toggle")},hideSettings:function(e){e!=this&&(e.originalEvent&&"click"==e.type&&e.target&&$.contains(m.views.settings.mainSettings.el,e.target)||m.commandManager.execute("settings.hide"))},settingsVisible:function(){$("#preferences").addClass("show")},settingsHidden:function(e){e&&e.preventDefault(),$("#preferences").removeClass("show")}}),m.views.Gravatar=Backbone.View.extend({className:"avatar",tagName:"img",render:function(){var e=this,t=this.options.email,i=this.options.size,n=!1,o=this.$el.on("error",function(){n||(n=!0,e.$el.attr({src:"/img/gravatar_unknown.jpg"}))}).attr({src:"https://www.gravatar.com/avatar/"+md5(t)+"?s="+i+"&d=mm"});return this.$el.html(o),this}}),m.views.settings.panels.About=m.views.settings.SettingsPanel.extend({attributes:{id:"settings-about","class":"subpanel-container"},template:m.templates.settings.about,panelid:"about",events:{"dblclick #momo-version":"revealUuid","dblclick .thanks":"revealUpgrade","dblclick .about-logo":"logoDblClicked"},render:function(){var e={version:m.globals.version};return this.$el.html(this.template(e)),this},revealUuid:function(e){e.preventDefault(),e.stopPropagation(),this.$el.find(".made").html(localStorage.client_uuid)},revealUpgrade:function(e){e&&(e.preventDefault(),e.stopPropagation()),m.commandManager.execute("settings.display.upgrade",null,{source:"easteregg-thanks"},!0)},logoDblClicked:function(e){e.stopPropagation(),$(".preferences").first().toggleClass("infinispin",m.settingsManager.toggleInfinispin())}}),m.views.settings=m.views.settings||{},m.views.settings.ColorPickerPopup=Backbone.View.extend({template:m.templates.settings["color-picker-popup"],events:{"mousedown .cp-xy-slider,.cp-z-slider,.cp-alpha":"mouseDown"},initialize:function(e){this._color=this.color=new Colors(e),this._options=this._color.options,this._GPU=!1,this._css="",this._pointermove="touchmove.tcp mousemove.tcp pointermove.tcp",this._pointerup="touchend.tcp mouseup.tcp pointerup.tcp"},render:function(){return this.$el.html(this.template()),this.delegateEvents(),this._$z_slider=this.$el.find(".cp-z-slider").first(),this._$xy_slider=this.$el.find(".cp-xy-slider").first(),this._$xy_cursor=this.$el.find(".cp-xy-cursor").first(),this._$z_cursor=this.$el.find(".cp-z-cursor").first(),this._$alpha=this.$el.find(".cp-alpha").first(),this._$alpha_cursor=this.$el.find(".cp-alpha-cursor").first(),this.setSizes(),this.preRender(),this.renderedOnce=!0,this},setSizes:function(){this._$alpha._width=this._$alpha.width(),this._$xy_slider._width=this._$xy_slider.width(),this._$xy_slider._height=this._$xy_slider.height(),this._$z_slider._height=this._$z_slider.height()},resolveEventType:function(e){return e=e.originalEvent&&e.originalEvent.touches?e.originalEvent.touches[0]:e,e.originalEvent?e.originalEvent:e},findElement:function(e){return $(e.find(this._options.doRender)[0]||e[0])},mouseDown:function(e){var t=this;e.stopPropagation(),this._$trigger=$(e.currentTarget),this.setSizes();var i=e.currentTarget.className,n=i.replace(/cp-(.*?)(?:\s*|$)/,"$1").replace("-","_");(e.button||e.which)>1||(e.preventDefault&&e.preventDefault(),e.returnValue=!1,this._$trigger._offset=this._$trigger.offset(),n="xy_slider"===n?this.xy_slider:"z_slider"===n?this.z_slider:this.alpha,n.call(this,e),this.preRender(),this.$el.on(this._pointerup,function(e){t.$el.off(".tcp")}).on("mouseleave.tcp",function(e){n.call(t,e),t.preRender(),t.$el.off(".tcp")}).on(this._pointermove,function(e){n.call(t,e),t.preRender()}))},xy_slider:function(e){var t=this.resolveEventType(e),i=t.pageX-this._$trigger._offset.left,n=t.pageY-this._$trigger._offset.top;this._color.setColor({s:i/this._$xy_slider._width*100,v:100-n/this._$xy_slider._height*100},"hsv")},z_slider:function(e){var t=this.resolveEventType(e).pageY-this._$trigger._offset.top;this._color.setColor({h:360-t/this._$z_slider._height*360},"hsv")},alpha:function(e){var t=this.resolveEventType(e).pageX-this._$trigger._offset.left,i=t/this._$alpha._width;this._color.setColor({},"rgb",i)},preRender:function(e){colors=this._color.colors,hueRGB=colors.hueRGB,RGB=colors.RND.rgb,HSL=colors.RND.hsl,dark=this._options.dark,light=this._options.light,colorText=this._color.toString(this._color._colorMode,this._options.forceAlpha),HUEContrast=colors.HUELuminance>.22?dark:light,alphaContrast=colors.rgbaMixBlack.luminance>.22?dark:light,h=(1-colors.hsv.h)*this._$z_slider._height,s=colors.hsv.s*this._$xy_slider._width,v=(1-colors.hsv.v)*this._$xy_slider._height,a=colors.alpha*this._$alpha._width,translate3d=this._GPU?"translate3d":"",this._$trigger?(triggerValue=this._$trigger[0].value,hasNoValue=this._$trigger[0].hasAttribute("value")&&""===triggerValue&&void 0!==e):(triggerValue=null,hasNoValue=!0),this._$xy_slider._css={backgroundColor:"rgb("+hueRGB.r+","+hueRGB.g+","+hueRGB.b+")"},this._$xy_cursor._css={transform:translate3d+"("+s+"px, "+v+"px, 0)",left:this._GPU?"":s,top:this._GPU?"":v,
borderColor:colors.RGBLuminance>.22?dark:light},this._$z_cursor._css={transform:translate3d+"(0, "+h+"px, 0)",top:this._GPU?"":h,borderColor:"transparent "+HUEContrast},this._$alpha._css={background:"linear-gradient(to left,#"+colors.HEX+",rgba(0,0,0,0))"},this._$alpha_cursor._css={transform:translate3d+"("+a+"px, 0, 0)",left:this._GPU?"":a,borderColor:alphaContrast+" transparent"},this.renderInternal(e)},renderInternal:function(e){this._$xy_slider.css(this._$xy_slider._css),this._$xy_cursor.css(this._$xy_cursor._css),this._$z_cursor.css(this._$z_cursor._css),this._$alpha.css(this._$alpha._css),this._$alpha_cursor.css(this._$alpha_cursor._css),this._options.doRender&&this._$trigger.css(this._$trigger._css),this._options.renderCallback.call(null,this._color,this._$trigger,"boolean"==typeof e?e:void 0)}}),m.views.settings.panels.General=m.views.settings.SettingsPanel.extend({attributes:{id:"settings-general","class":"subpanel-container"},template:m.templates.settings.general,panelid:"general",syncState:!1,events:{"click .slide-toggle":"toggleSlider","click .sync-option":"toggleSyncSlider","click .toggle-option":"toggleOption","click .login":"loginClicked","click .action-logout":"logoutClicked","click .profile":"profileClicked","click .plan":"planClicked"},initialize:function(){this.model=m.models.customization,this.initializeCustomizeItems(),this.listenTo(m.models.customization,"change",this.customizationModelChanged)},initializeCustomizeItems:function(){var e=m.models.themeManager.getAvailableFonts();this.customizeItems=[{name:"Theme",field:"themeColour",widget:"themeColour",options:[{label:"Dark",value:"dark"},{label:"Light",value:"light"},{label:"Custom",value:"custom",view_cmd:"settings.color.picker",view_opt:{settingName:"themeColour",ignoreClick:!0},show_always:!0}],plusOnly:!0,section:"customize"},{name:"Font",field:"themeFont",widget:"themeFont",options:e,plusOnly:!0,section:"customize"},{name:"Links",widget:"linksVisible",field:"linksVisible",section:"widgets"},{name:"Search",widget:"searchVisible",field:"searchVisible",section:"widgets"},{name:"Weather",widget:"weatherVisible",field:"weatherVisible",section:"widgets"},{name:"Focus",widget:"focusVisible",field:"focusVisible",section:"widgets"},{name:"Quote",widget:"quoteVisible",field:"quoteVisible",section:"widgets"},{name:"Todo",widget:"todoVisible",field:"todoVisible",section:"widgets"},{name:"Countdown",widget:"countdownVisible",field:"countdownVisible",plusOnly:!0,message:"Count down the days until an important date",section:"widgets",beta:!0},{name:"Notes",widget:"notesVisible",field:"notesVisible",plusOnly:!0,message:"Take quick notes and store wisdom to review",section:"widgets",feature:"notes-setting",beta:!0},{name:"Weather Units",field:"temperatureUnit",widget:"temp-unit",options:[{label:"°C",value:"c"},{label:"°F",value:"f"}],section:"misc"},{name:"Clock Format",field:"hour12clock",widget:"clock-format","boolean":!0,options:[{label:"12 hour",value:!0},{label:"24 hour",value:!1}],section:"misc"},{name:"Percent Clock",widget:"percentClock",field:"percentClock",message:"Visualize your progression through the workday (8:30am to 5:30pm currently)",section:"misc",beta:!0},{name:"Search Provider",field:"searchProvider",widget:"search-provider",options:[{label:"Google",value:"google"},{label:"Bing",value:"bing"}],section:"misc"}]},render:function(){var e,t=m.models.customization.get("displayname"),i=localStorage.email||null,n=!!localStorage.token;if(m.conditionalFeatures.featureEnabled("serverfocus")||m.conditionalFeatures.featureEnabled("servertodos")||m.conditionalFeatures.featureEnabled("serverlinks")?(e="Your account data is available anywhere you log in",this.syncState=!0):m.models.customization.get("requestSync")&&localStorage.token?(e="Refresh or load a new tab to use your synced account",this.syncState=!0):(e="Access your Momentum account from any computer",this.syncState=!1),this.$el.html(this.template({displayname:t,email:i,loggedIn:n,syncMessage:e})),i){var o=this.$el.find(".user-gravatar");if(o){var s=new m.views.Gravatar({email:i,size:50});o.html(s.render().$el)}}m.conditionalFeatures.featureEnabled("plus")&&this.$el.find(".user").addClass("has-plus"),this.$synclist=this.$el.find(".sync-option"),this.updateSyncToggleState();var a={customize:this.$el.find("#customize-list"),widgets:this.$el.find("#widgets-list"),misc:this.$el.find("#misc-list")};return _.each(a,function(e){e.empty()}),_.each(this.customizeItems,function(e){(!e.feature||m.conditionalFeatures.featureEnabled(e.feature))&&(e.options?a[e.section].append(m.templates.settings["general-toggle-options"](e)):a[e.section].append(m.templates.settings["general-toggle-slider"](e)))}),this.updateControlStates(_.pluck(this.customizeItems,"field")),this},updateSyncToggleState:function(){this.$synclist&&this.$synclist.toggleClass("fixed on",this.syncState)},updateSyncMessage:function(e){if(this.$synclist){var t=this.$synclist.find(".option-message");t.fadeTo(0,0,function(){t.html(e).fadeTo(500,1)})}},updateSyncCaption:function(e){if(this.$synclist){var t=this.$synclist.find(".sync-caption");t.fadeTo(0,0,function(){t.html(e).fadeTo(500,1)})}},toggleSyncSlider:function(e){var t=this;if(!this.syncState){var i=m.models.customization.get("requestSync");localStorage.token?i?t.render():m.syncCoordinator.submitFeatureAccessRequest("sync-early-access",function(){m.models.customization.save({requestSync:!0}),t.updateSyncCaption("Account Sync Activated"),t.updateSyncMessage("Refresh or load a new tab to use your synced account"),t.syncState=!0,t.updateSyncToggleState()},function(){t.syncState=!1,t.updateSyncToggleState(),t.updateSyncCaption("Account Sync Access Request Failed"),t.updateSyncMessage("Please check that you are online and try again"),t.syncState=!1,t.updateSyncToggleState()}):(t.updateSyncCaption("Login required for Account Sync"),t.updateSyncMessage("Click Login above to log in or create an account, and try again"),t.syncState=!1,t.updateSyncToggleState())}},customizationModelChanged:function(e){var t=e.changedAttributes(),i=_.keys(t);this.updateControlStates(i)},updateControlStates:function(e){var t=this;_.each(e,function(e){var i=_.findWhere(t.customizeItems,{field:e});if(i)if(i.options){var n=t.model.get(e);t.$el.find("."+i.widget).removeClass("active");var o=t.$el.find("."+i.widget+"[data-option-value='"+n+"']").first();o.addClass("active"),_.each(i.options,function(e){if(e.view_cmd){o=t.$el.find("."+i.widget+"[data-option-value='"+e.value+"']").first();var s=o.find(".sub-view").first();return!e.view&&e.show_always&&(e.view=m.commandManager.execute(e.view_cmd,e.value,e.view_opt)),0==s.children().length&&(s.html(e.view.render().$el),s.css("display","inline-block")),e.value!=n?(e.show_always||s.hide(),!e.view||!e.view.dismiss||e.view.dismiss(),void(!e.view||!e.view.setInactive||e.view.setInactive())):void(!e.view||!e.view.setActive||e.view.setActive())}})}else{var s=t.$el.find("[data-related-widget='"+i.widget+"']");if(s&&1===s.length){var a=s.first();a.toggleClass("on",t.model.get(e))}}})},toggleOption:function(e){var t=e.currentTarget,i=$(e.currentTarget).attr("data-related-widget"),n=$(e.currentTarget).attr("data-option-value"),o=_.findWhere(this.customizeItems,{widget:i});if(o){if(o.plusOnly&&!m.conditionalFeatures.featureEnabled("plus"))return void m.commandManager.execute("settings.display.upgrade",null,{source:i});this.$el.find("."+i).removeClass("active"),$(t).addClass("active");var s={};o["boolean"]?s[o.field]=JSON.parse(n):s[o.field]=n;var a=_.findWhere(o.options,{value:n});if(a&&a.view&&a.view.handleClick){var l=$(e.target).closest(".sub-view");if(l.length>0&&a.view.ignoreClickEvent&&a.view.ignoreClickEvent(e.target))return;if(a.view.handleClick(e,!0),a.view.scrollIntoViewElement){var r=a.view.scrollIntoViewElement();r&&r.scrollIntoViewIfNeeded()}}this.model.save(s)}m.trigger("globalEvent:settingsclick",e)},toggleSlider:function(e){e.stopPropagation();var t=$(e.currentTarget).attr("data-related-widget");if(t){var i=_.findWhere(this.customizeItems,{widget:t}),n=!this.model.get(t);if(i.plusOnly&&!m.conditionalFeatures.featureEnabled("plus"))return void m.commandManager.execute("settings.display.upgrade",null,{source:t});var o={};o[t]=n,this.model.save(o)}m.trigger("globalEvent:settingsclick",e)},loginClicked:function(e){e.preventDefault(),e.stopPropagation(),m.sendEvent("Settings","Login","Clicked"),m.commandManager.execute("settings.hide"),localStorage.doLoginOnNextLoad=!0,window.location.reload()},logoutClicked:function(e){e.preventDefault(),e.stopPropagation(),m.sendEvent("Settings","Logout","Clicked"),m.commandManager.execute("logout")},profileClicked:function(e){e.preventDefault(),e.stopPropagation(),$(e.currentTarget).html("Launching..."),$.ajax({type:"GET",beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"user/me?setCookie=true"}).done(function(e){e.userValid&&(window.location.href="https://account.momentumdash.com/profile")}).fail(function(e,t){}).always(function(){})},planClicked:function(e){e.preventDefault(),e.stopPropagation(),$(e.currentTarget).html("Launching..."),$.ajax({type:"GET",beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"user/me?setCookie=true"}).done(function(e){e.userValid&&(window.location.href="https://account.momentumdash.com")}).fail(function(e,t){}).always(function(){})},panelClosing:function(){_.each(this.customizeItems,function(e){_.each(e.options,function(e){e.view_cmd&&(!e.view||!e.view.close||e.view.close())})})}}),m.views.settings.panels.Help=m.views.settings.SettingsPanel.extend({attributes:{id:"settings-help","class":"subpanel-container"},template:m.templates.settings.help,panelid:"help",initialize:function(){}}),m.views.settings.panels.Loading=m.views.settings.SettingsPanel.extend({attributes:{id:"settings-loading"},template:m.templates.settings.loading,panelid:"loading",events:{"click .button-retry":"retryClicked"},render:function(){if(!this.renderedOnce){this.renderedOnce=!0;var e={};this.$el.html(this.template(e)),this.$errorMessage=this.$(".settings-loading-error-message"),this.$retryButton=this.$(".button-retry"),this.$loading=this.$(".settings-loading-loading-message")}return this.renderDisplayState(),this},renderDisplayState:function(){if(this.displayOptions){var e=this.displayOptions;if(e.error)return this.$errorMessage.text(e.error),this.$errorMessage.show(),this.$retryButton.show(),void this.$loading.hide()}this.$loading.show(),this.$errorMessage.hide(),this.$retryButton.hide()},setDisplayOptions:function(e){e?this.displayOptions=e:this.displayOptions=null},retryClicked:function(e){if(e.stopPropagation(),this.displayOptions&&this.displayOptions.retryInfo){var t=this.displayOptions.retryInfo,i=t.options||{};i.section=t.id,m.commandManager.execute("settings.display",null,i)}}}),m.views.settings.NavMenu=Backbone.View.extend({template:m.templates.settings.navmenu,events:{"click .main-nav-item":"onClickNavItem"},initialize:function(){this.listenTo(m.settingsManager,"navItemsChanged",this.render),this.render()},render:function(){var e=m.settingsManager.getNavItems();return this.$el.html(this.template(e)),this},onClickNavItem:function(e){e.stopPropagation();var t=$(e.currentTarget).data("navitem");this.trigger("navItemClicked",t)}}),m.views.settings.panels.Todo=m.views.settings.SettingsPanel.extend({attributes:{id:"todo-panel","class":"subpanel-container"},template:m.templates.settings.todo,panelid:"todo",events:{"click .connect-todo":"initiateConnectProvider","click #connect-button":"connectTodoProvider","click .toggle-form":"toggleForm","click .set-active":"setProviderActive","click .disconnect":"disconnectProvider","click .launch-config":"launchConfiguration","click #auto-focus":"toggleAutoFocus","click #remember-open-state":"toggleRememberOpenState","click .back":"cancelConnect"},initialize:function(){var e=this;this.collection=new m.collect.Settings,this.collection.url=m.globals.urlRoot+"settings/todo",this.collection.parse=function(t){return e.collection.lastResponse=t,t.connected_providers},this.listenTo(this.collection,"reset",this.collectionReset),this.listenTo(m,"todo:providerChanged",this.providerChanged),this.listenTo(m.models.customization,"change",this.customizationChanged),this.refreshData()},render:function(){return this.$el.html(this.template({})),this.$connect=$(this.$el.find(".settings-connect")[0]),this.$todo=$(this.$el.find(".settings-todo")[0]),this.setControlStates(),this},providerChanged:function(){this.populateConnectedProviders()},customizationChanged:function(e){var t=e.changedAttributes();(t.hasOwnProperty("autoFocus")||t.hasOwnProperty("keepTodoState"))&&this.setControlStates()},collectionReset:function(){this.populateConnectedProviders(),this.populateAvailableProviders()},refreshData:function(){this.collection.fetch({reset:!0})},initiateConnectProvider:function(e){if(e&&(e.stopPropagation(),e.preventDefault()),this.connect_provider_id=$(e.currentTarget).data("provider-id"),m.conditionalFeatures.featureEnabled("plus")){var t=_.findWhere(this.collection.lastResponse.available_providers,{id:this.connect_provider_id});t.active&&(this.$connect.html(m.templates.settings.connect(t)),this.$todo.hide(),this.$connect.show())}else m.commandManager.execute("settings.display.upgrade",null,{source:"todo-"+this.connect_provider_id})},setProviderActive:function(e){e&&(e.stopPropagation(),e.preventDefault());var t=$(e.currentTarget).closest(".has-provider-id").data("provider-id");t&&m.models.todoListManager&&m.models.todoListManager.changeProvider(t)},disconnectProvider:function(e){var t=this;e&&(e.stopPropagation(),e.preventDefault());var i=$(e.currentTarget).closest(".has-provider-id").data("provider-id"),n=m.globals.urlRootApi+"settings/todo/providers/"+i;$.ajax({type:"DELETE",contentType:"application/json",beforeSend:setMomentumAuthHeader,url:n}).done(function(e){e.status&&"success"==e.status&&(m.models.todoListManager.changeProvider(1),t.refreshData())}).fail(function(e,t){})},launchConfiguration:function(e){e&&(e.stopPropagation(),e.preventDefault());var t=$(e.currentTarget).closest(".has-provider-id").data("provider-id");if(t){var i=this.collection.get(t);if(i){var n=i.get("config_command");n&&m.commandManager.execute(n)}}},toggleRememberOpenState:function(e){e&&(e.stopPropagation(),e.preventDefault()),m.commandManager.execute("todo.toggle.keepstate")},toggleAutoFocus:function(e){e&&(e.stopPropagation(),e.preventDefault()),m.commandManager.execute("todo.toggle.autofocus")},setControlStates:function(){this.$el.find("#auto-focus").toggleClass("on",m.models.customization.get("autoFocus")),this.$el.find("#remember-open-state").toggleClass("on",m.models.customization.get("keepTodoState"))},connectTodoProvider:function(e){e&&(e.stopPropagation(),e.preventDefault());var t=$(this.$el.find("#connect-button")[0]);t.html("Connecting...");var i=this;this.authAttempts=0;var n=this.connect_provider_id,o=m.globals.urlRootApi+"settings/todo/providers",s={provider_id:n};$.ajax({type:"PUT",contentType:"application/json",beforeSend:setMomentumAuthHeader,url:o,data:JSON.stringify(s)}).done(function(e){if(e.status&&"authRequired"==e.status){if(e.authorizationUrl&&i.authAttempts<2){i.authAttempts++;var t=e.winWidth?e.winWidth:600,n=e.winHeight?e.winHeight:510,o=e.windowFeatures?e.windowFeatures:"titlebar,resizable,toolbar,status",a=window.screen.width/2-t/2,l=window.screen.height/2-n/2,r=window.open(e.authorizationUrl,"MomentumAuthWindow",o+",left="+a+",top="+l+",width="+t+",height="+n),d=setInterval(function(){r.closed&&(clearInterval(d),i.$connect.hide(),i.$todo.show(),i.refreshData(),e.change_provider&&m.commandManager.execute("settings.todo.provider.change",null,{provider_id:s.provider_id}),e.config_command&&m.commandManager.execute(e.config_command))},250)}}else e.status&&"success"==e.status&&(i.refreshData(),e.config_command&&m.commandManager.execute(e.config_command))}).fail(function(e,t){})},cancelConnect:function(e){e&&(e.stopPropagation(),e.preventDefault()),this.$connect.hide(),this.$todo.show()},populateConnectedProviders:function(){var e=$(this.$el.find("#connected-providers")[0]),t=JSON.parse(localStorage.activeTodoProvider||1);Number.isInteger(t)||(t=parseInt(t,10)),t&&t>0&&this.collection.forEach(function(e){t==e.id?e.set("provider_active",!0):e.set("provider_active",!1)});var i=m.templates.settings.todo_connected(this.collection.toJSON());e.html(i),this.collection.length<=1?($(this.$el).find(".show-form").hide(),$(this.$el).find(".form").show(),$(this.$el).find(".empty").show(),e.hide()):(e.show(),$(this.$el).find(".empty").hide())},populateAvailableProviders:function(){var e=$(this.$el.find("#available-providers")[0]),t=m.templates.settings.todo_available(this.collection.lastResponse.available_providers);e.html(t),this.collection.lastResponse.available_providers?this.collection.lastResponse.available_providers&&this.collection.lastResponse.available_providers.length>0&&($(this.$el).find(".all-connected").hide(),$(this.$el).find("#available-providers").show()):($(this.$el).find(".all-connected").show(),$(this.$el).find("#available-providers").hide())},toggleForm:function(){$(this.$el).find(".show-form").toggle(),$(this.$el).find(".form").toggle()}}),m.views.settings.panels.Upgrade=m.views.settings.SettingsPanel.extend({attributes:{id:"upgrade-panel","class":"subpanel-container pop-body settings-upgrade"},template:m.templates.settings.upgrade,panelid:"upgrade",events:{"click .button-upgrade":"getPlusClicked"},initialize:function(e){m.sendEvent("Upgrade to Plus","Show Upgrade Panel"),this.listenTo(m,"settings:upgradeCopyChanged",this.render),e&&(e.source?(this.source=e.source,m.commandManager.execute("settings.cache.upgradecopy",!0,e.source)):m.commandManager.execute("settings.cache.upgradecopy",!0),e.utm_source&&(this.utm_source=e.utm_source),e.utm_medium&&(this.utm_medium=e.utm_medium),e.utm_campaign&&(this.utm_campaign=e.utm_campaign))},render:function(){if(this.$el.html(this.template({})),localStorage.cachedUpgradeCopy){var e=JSON.parse(localStorage.cachedUpgradeCopy);if(e.html){var t=Handlebars.compile(e.html);this.$el.html(t({campaignDetails:$.param(this.getCampaignDetails())}))}}return this},getCampaignDetails:function(){var e={utm_source:"extension",utm_medium:"upgrade-panel",utm_campaign:this.source};return this.utm_campaign&&(e={utm_source:this.utm_source,utm_medium:this.utm_medium,utm_campaign:this.utm_campaign}),e},getPlusClicked:function(e){var t=this;e.preventDefault(),e.stopPropagation(),localStorage.token?(m.sendEvent("Upgrade to Plus","Click Get Momentum Plus"),$(e.currentTarget).html("Launching..."),$.ajax({type:"GET",beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"user/me"}).done(function(e){if(e.userValid){var i="https://account.momentumdash.com/upgrade?"+$.param(t.getCampaignDetails());window.location.href=i}}).fail(function(e,t){}).always(function(){})):(m.sendEvent("Upgrade to Plus","Click Get Momentum Plus, but not logged in"),$(this.$el).find(".login-needed").css({opacity:0,display:"block"}).fadeTo(500,1))}}),m.views.settings.panels.Whatsnew=m.views.settings.SettingsPanel.extend({attributes:{id:"whats-new-panel","class":"subpanel-container"},template:m.templates.settings.whatsnew,panelid:"whatsnew",events:{"click .action-back":"clickBack"},initialize:function(){m.sendEvent("Whats New","Show Whats New Panel")},render:function(){return this.$el.html(this.template({})),this.$whatsnew=$(this.$el.find(".whatsnew-body")[0]),this.$whatsnew.html('<span class="loading"><i class="loading-icon"></i>Loading...</span>'),this.fetchLatestWhatsNew(),this},fetchLatestWhatsNew:function(){var e=this;$.ajax({type:"GET",beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"settings/whatsnew"}).done(function(t){t.html&&e.$whatsnew.html(t.html)}).fail(function(t,i){e.$el.html(e.template({}))})}}),m.views.Introduction=Backbone.View.extend({attributes:{id:"introduction"},template:m.templates.introduction["introduction-template"],initialize:function(){this.activeView=null,localStorage.removeItem("doLoginOnNextLoad"),this.render()},render:function(){var e=(this.options.order||"append")+"To";this.$el[e]("#"+this.options.region).fadeTo(0,0).html(this.template()).fadeTo(1e3,1),m.models.customization.get("displayname")?this.promptForEmail():this.promptForName()},promptForName:function(){m.sendEvent("Introduction","Name","Show"),m.views.namePrompt=new m.views.NamePrompt,this.activeView=m.views.namePrompt,this.$el.find(".content").append(m.views.namePrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},promptForEmail:function(){m.views.emailPrompt=new m.views.EmailPrompt,this.activeView=m.views.emailPrompt,this.$el.find(".content").append(m.views.emailPrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},promptForPaswordLogin:function(){m.sendEvent("Introduction","Password For Login","Show"),m.views.loginPasswordPrompt=new m.views.LoginPasswordPrompt,this.activeView=m.views.loginPasswordPrompt,this.$el.find(".content").append(m.views.loginPasswordPrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},promptForPaswordCreate:function(){m.sendEvent("Introduction","Password For Create","Show"),m.views.createPasswordPrompt=new m.views.CreatePasswordPrompt,this.activeView=m.views.createPasswordPrompt,this.$el.find(".content").append(m.views.createPasswordPrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},promptForPaswordReset:function(){m.sendEvent("Introduction","Password For Reset","Show"),m.views.resetPasswordPrompt=new m.views.ResetPasswordPrompt,this.activeView=m.views.resetPasswordPrompt,this.$el.find(".content").append(m.views.resetPasswordPrompt.render().$el.fadeTo(1e3,1)),this.$el.find("#introduction-input").focus()},doneIntroductionWithMessage:function(){localStorage.removeItem("doLoginOnNextLoad"),this.$el.fadeTo(1e3,0,function(){m.bootstrappers.InitializeFocus(m,$),m.appView.render(!0)})},showLoading:function(){this.$el.find(".tip").html('<div class="loading"><span class="loading-icon"></span>Loading...</div>').css("opacity","0").fadeTo(500,1)},hideLoading:function(){}}),m.views.NamePrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keypress input":"updateOnEnter"},render:function(){var e="Hello, what's your name?",t={message:e};return this.$el.html(this.template(t)),this},updateOnEnter:function(e){13==e.keyCode&&this.save()},save:function(){m.sendEvent("Introduction","Name","Submit");var e=this,t=this.$el.find("input")[0].value.trim();t.length<1||(m.models.customization.save({displayname:t}),this.$el.fadeTo(1e3,0,function(){e.remove(),m.views.introduction.promptForEmail()}))}}),m.views.EmailPrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keypress input":"updateOnEnter"},initialize:function(){this.listenTo(m,"globalEvent:esc",this.handleBack),this.loading=!1},render:function(){var e=this,t="What's your email, "+m.models.customization.get("displayname")+"?",i={message:t},n=new m.views.IntroductionButton({value:"Stay logged out",clicked:function(){return e.stayOffline()}});return this.$el.html(this.template(i)),this.$el.find(".buttons").append("Or would you rather stay logged out?").append(n.render().$el),this.$el.find("input")[0].focus(),this},handleBack:function(e){m.sendEvent("Introduction","Email","Escape Pressed"),this.stayOffline()},updateOnEnter:function(e){13==e.keyCode&&this.checkEmail()},stayOffline:function(){m.sendEvent("Introduction","Email","Stay Offline Clicked"),localStorage.stayOffline=!0,m.views.introduction.doneIntroductionWithMessage()},checkEmail:function(){m.sendEvent("Introduction","Email","Submit");var e=this,t=this.$el.find("input")[0].value.trim();if(!(t.length<1)){var i=validateEmail(t);if(!i){var n=new m.views.IntroductionTip({value:"Sorry, "+t+" doesn't seem to be a valid email address. Please try again."});return void this.$el.find(".tip").html(n.render().$el.fadeTo(500,1))}e.loading||(e.loading=!0,localStorage.email=t,m.views.introduction.showLoading(),$.ajax({type:"GET",url:m.globals.urlRootApi+"user-search?email="+encodeURIComponent(t)}).done(function(t){e.$el.fadeTo(1e3,0,function(){e.remove(),m.views.introduction.promptForPaswordLogin()}),m.views.introduction.hideLoading(),e.loading=!1}).fail(function(t,i){return 404!==t.status?(e.loading=!1,void e.$el.find(".tip").html('<div class="loading">Sorry, we\'re having trouble connecting to our server. Please try again.</div>').css("opacity","0").fadeTo(500,1)):(e.$el.fadeTo(1e3,0,function(){e.remove(),m.views.introduction.promptForPaswordCreate()}),e.loading=!1,m.views.introduction.hideLoading(),void 0)}))}}}),m.views.LoginPasswordPrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keypress input":"updateOnEnter"},initialize:function(){this.listenTo(m,"globalEvent:esc",this.handleBack),this.loading=!1},render:function(){var e=this,t="What's your password?",i={message:t},n=new m.views.IntroductionButton({value:"Use a different email address",clicked:function(){return e.changeEmail()}}),o=new m.views.IntroductionButton({value:"Change your password",clicked:function(){return e.resetPassword()}});return this.$el.html(this.template(i)),this.$el.find(".buttons").append(n.render().$el),this.$el.find(".buttons").append(o.render().$el),this.$el.find("input").attr("type","password").focus(),this},handleBack:function(e){m.sendEvent("Introduction","Password For Login","Escape Pressed"),this.changeEmail(e)},updateOnEnter:function(e){13==e.keyCode&&this.login()},changeEmail:function(e){m.sendEvent("Introduction","Password For Login","Change Email Clicked");var t=this;t.$el.fadeTo(1e3,0,function(){t.remove(),m.views.introduction.promptForEmail()})},resetPassword:function(e){m.sendEvent("Introduction","Password For Login","Reset Password Clicked");var t=this;t.$el.fadeTo(1e3,0,function(){t.remove(),m.views.introduction.promptForPaswordReset()})},login:function(){m.sendEvent("Introduction","Password For Login","Submit");var e=this,t=localStorage.email,i=this.$el.find("input")[0].value;if(i.length<6){var n=new m.views.IntroductionTip({value:"Passwords need to be at least 6 characters long."});return void e.$el.find(".tip").html(n.render().$el.fadeTo(500,1))}e.loading||(e.loading=!0,m.views.introduction.showLoading(),$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({username:t,password:i}),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/authenticate"}).done(function(t){e.loading=!1,t.token&&(m.commandManager.execute("notification.dismiss"),localStorage.token=t.token,t.token_uuid&&(localStorage.token_uuid=t.token_uuid),t.features&&m.conditionalFeatures.setFeatures(t.features),m.trigger("user:successfulLogin",function(){m.views.introduction.doneIntroductionWithMessage()}),m.views.introduction.hideLoading())}).fail(function(t,i){if(400!==t.status)return e.loading=!1,void e.$el.find(".tip").html('<div class="loading">Sorry, we\'re having trouble connecting to our server. Please try again.</div>').css("opacity","0").fadeTo(500,1);var n=new m.views.IntroductionTip({value:"The password you entered for the email "+localStorage.email+" isn't right."});e.$el.find(".tip").html(n.render().$el.fadeTo(500,1)),e.loading=!1,m.views.introduction.hideLoading()}))}}),m.views.CreatePasswordPrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keypress input":"updateOnEnter"},initialize:function(){this.listenTo(m,"globalEvent:esc",this.handleBack),this.loading=!1},render:function(){var e=this,t="Please choose a password.",i={message:t},n=new m.views.IntroductionButton({value:"Use a different email address",clicked:function(){return e.changeEmail()}});return this.$el.html(this.template(i)),this.$el.find("input").attr("type","password").focus(),this.$el.find(".buttons").append(n.render().$el),this},updateOnEnter:function(e){13==e.keyCode&&this.create()},handleBack:function(e){m.sendEvent("Introduction","Password For Create","Escape Pressed"),this.changeEmail(e)},changeEmail:function(e){m.sendEvent("Introduction","Password For Create","Change Email Clicked");var t=this;t.$el.fadeTo(1e3,0,function(){t.remove(),m.views.introduction.promptForEmail()})},create:function(){m.sendEvent("Introduction","Password For Create","Submit");var e=this,t=localStorage.email,i=this.$el.find("input")[0].value;if(i.length<6){var n=new m.views.IntroductionTip({value:"Passwords need to be at least 6 characters long."});return void e.$el.find(".tip").html(n.render().$el.fadeTo(500,1))}e.loading||(e.loading=!0,m.views.introduction.showLoading(),$.ajax({type:"POST",contentType:"application/json",beforeSend:setMomentumAuthHeader,data:JSON.stringify({name:m.models.customization.get("displayname"),email:t,password:i,version:m.globals.version}),url:m.globals.urlRootLogin+"user/register"}).done(function(e){e.token?(localStorage.token=e.token,e.token_uuid&&(localStorage.token_uuid=e.token_uuid)):e.first_time_key&&(localStorage.first_time_key=e.first_time_key,localStorage.next_login_attempt=Date.now(),e.token_uuid&&(localStorage.token_uuid=e.token_uuid)),m.views.introduction.doneIntroductionWithMessage()}).fail(function(e,t){}).always(function(){m.views.introduction.hideLoading(),e.loading=!1}))}}),m.views.ResetPasswordPrompt=Backbone.View.extend({tagName:"span",template:m.templates.introduction["introduction-content-template"],events:{"keypress input":"updateOnEnter"},initialize:function(){this.listenTo(m,"globalEvent:esc",this.handleBack),this.loading=!1},render:function(e){var t=this,i="What would you like your new password to be?",n={message:i},o=new m.views.IntroductionButton({value:"Use a different email address",clicked:function(){return t.changeEmail()}});return this.$el.html(this.template(n)),this.$el.find(".buttons").append("Changing password for "+localStorage.email).append(o.render().$el),this.$el.find("input").attr("type","password").focus(),this},handleBack:function(e){m.sendEvent("Introduction","Password For Reset","Escape Pressed"),this.changeEmail(e)},changeEmail:function(e){m.sendEvent("Introduction","Password For Reset","Change Email Clicked");var t=this;t.$el.fadeTo(1e3,0,function(){t.remove(),m.views.introduction.promptForEmail()})},updateOnEnter:function(e){13==e.keyCode&&this.reset()},reset:function(){m.sendEvent("Introduction","Password For Reset","Submit");var e=this,t=localStorage.email,i=this.$el.find("input")[0].value;if(i.length<6){var n=new m.views.IntroductionTip({value:"Passwords need to be at least 6 characters long."});return void e.$el.find(".tip").html(n.render().$el.fadeTo(500,1))}e.loading||(e.loading=!0,m.views.introduction.showLoading(),$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({name:m.models.customization.get("displayname"),email:t,password:i}),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/forgot"}).done(function(e){m.commandManager.execute("notification.show","Password change started","Check your email to change your password. Your password change email may take a few moments to arrive."),m.views.introduction.doneIntroductionWithMessage()}).fail(function(e,t){}).always(function(){e.loading=!1,m.views.introduction.hideLoading()}))}}),m.views.IntroductionTip=Backbone.View.extend({template:m.templates.introduction["introduction-tip-template"],render:function(){var e={value:this.options.value};return this.setElement($($.trim(this.template(e)))),this}}),m.views.IntroductionButton=Backbone.View.extend({template:m.templates.introduction["introduction-button-template"],events:{click:"clicked"},render:function(){var e={value:this.options.value};return this.setElement($($.trim(this.template(e)))),this},clicked:function(e){this.options.clicked()}}),m.models.DropdownMenuItem=Backbone.Model.extend({}),m.collect.TopDropdownMenuItems=Backbone.Collection.extend({model:m.models.DropdownMenuItem,
url:m.globals.urlRoot+"settings/todo/menu",fetchCompleted:!1,initialize:function(e,t){t&&t.listId&&(this.listId=t.listId)},parse:function(e){return e.menuoptions},fetchIfRequired:function(){return this.fetchCompleted?!1:(this.fetchCompleted=!0,this.fetch({reset:!0,error:function(e,t,i){this.fetchCompleted=!1}}),!0)},queueFetch:function(){this.fetchCompleted=!1},fetch:function(e){var t={};return this.listId?(t.data={listId:this.listId},e=_.extend(e||{},t),Backbone.Collection.prototype.fetch.call(this,e)):null}}),m.models.TodoBase=Backbone.Model.extend({isTrue:function(e){var t=this.get(e);return void 0===t?!1:1==t},attemptSave:function(){},retrySave:function(){this.get("isProxy")?this.collection.parentList&&this.collection.parentList.createNewModel&&this.collection.parentList.createNewModel(this):this.attemptedSaveValues&&this.attemptSave(this.model)},saveOptions:function(){return this.collection.saveOptions},getValue:function(e){var t=null;return this.attemptedSaveValues&&this.attemptedSaveValues.hasOwnProperty(e)&&(t=this.attemptedSaveValues[e]),t||(t=this.get(e)),t},isSibling:function(e){return e.get("parentId")==this.get("parentId")}}),m.models.Todo=m.models.TodoBase.extend({defaults:function(){return{title:"empty todo...",done:!1,archive:!1,order:0,createdDate:new Date,archivedDate:null,completedDate:null,deleted:!1,deletedDate:null,listId:"inbox"}},parse:function(e){return e&&e.done&&e.archive&&(e.listId="1-done"),e},archive:function(){this.save({archive:!0,archivedDate:new Date},this.saveOptions())},displayConnectingText:function(e){},successfulConnection:function(){},failedConnection:function(e){},attemptSave:function(e){var t=this;t.displayConnectingText('<i class="loading-icon"></i>Saving...');var i=t.saveOptions();i.wait=!0,i.success=function(){var e={};jQuery.extend(e,t.attemptedSaveValues),t.attemptedSaveValues=null,jQuery.extend(e,{saveFailed:!1,isLoading:!1}),m.trigger("todo:changed",t.id,e),setTimeout(function(){t.set(e),t.successfulConnection()},50)},i.error=function(e,i,n){if(200==i.status){var o={};jQuery.extend(o,t.attemptedSaveValues),t.attemptedSaveValues=null,jQuery.extend(o,{saveFailed:!1,isLoading:!1}),m.trigger("todo:changed",t.id,o),setTimeout(function(){t.set(o),t.successfulConnection()},50)}else t.set({saveFailed:!0,isLoading:!1}),t.failedConnection('Error saving… <span class="retry">Retry</span>')},e?(t.attemptedSaveValues?jQuery.extend(t.attemptedSaveValues,e):t.attemptedSaveValues=e,t.save(e,i)):t.attemptedSaveValues?(e=t.attemptedSaveValues,t.save(t.attemptedSaveValues,i)):t.pendingReorderData&&(t.set({isLoading:!0}),$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(t.pendingReorderData),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"todos"}).done(function(e){t.set({isLoading:!1,saveFailed:!1})}).fail(function(e,i){t.set({saveFailed:!0,isLoading:!1})})),jQuery.extend(e,{saveFailed:!1,isLoading:!0}),t.set(e),m.trigger("todo:changing",t.id,e)},comparator:"order",save:function(e,t){t||(t={}),e||(e=_.clone(this.attributes));try{if(this.collection&&this.collection.parentList&&this.collection.parentList.collection&&this.collection.parentList.collection.aux_data&&jQuery.extend(e,{aux_data:this.collection.parentList.collection.aux_data}),this.collection&&this.collection.parentList&&this.collection.parentList.collection&&this.collection.parentList.collection.aux_data_cmd){var i=m.commandManager.execute(this.collection.parentList.collection.aux_data_cmd,this,this.collection.parentList.collection.aux_data);jQuery.extend(e,{aux_data:this.collection.parentList.collection.aux_data,aux_data_result:i})}}catch(n){}return Backbone.Model.prototype.save.call(this,e,t)}}),m.models.TodoProxy=m.models.TodoBase.extend({defaults:function(){return{done:!1,isProxy:!0,isLoading:!0,saveFailed:!1,proxyValid:!0}}}),m.models.TodoList=Backbone.Model.extend({itemFetchStarted:!1,showAssignedTodosOnly:!1,defaults:{selected:!1},initialize:function(){this.itemCollection=new m.collect.Todos(null,{parentList:this}),this.listenTo(this.itemCollection,"add remove change reset",this.triggerChangeEvent),this.listenTo(this.itemCollection,"remainingCountChanged",this.remainingCountChanged),this.proxyCollection=new m.collect.TodoProxy(null,{parentList:this}),this.listenTo(this.proxyCollection,"add change",this.triggerChangeEvent),this.get("assigned_support")&&(this.listenTo(m.models.customization,"change:assigned-"+this.id,this.showAssignedTodosOnlyChanged),this.refreshShowAssignedTodosOnly())},todoItemMenuOptions:function(){if(this.itemCollection.menuOptions&&(this._todoItemMenuOptions=new Backbone.Collection(this.itemCollection.menuOptions)),!this._todoItemMenuOptions){var e=[{captionText:"Move to Inbox",commandId:"todo.move.type",options:{target:"inbox"}},{captionText:"Move to Today",commandId:"todo.move.type",options:{target:"today"}},{captionText:"Archive",commandId:"todo.move.done"},{css_class:"line"},{captionText:"Delete",commandId:"todo.delete"}];this._todoItemMenuOptions=new Backbone.Collection(e)}return this._todoItemMenuOptions},showAssignedTodosOnlyChanged:function(){this.refreshShowAssignedTodosOnly(),this.itemCollection.checkRemainingItemCount(),m.trigger("todo:showAssignedTodosOnlyChanged",this.id)},refreshShowAssignedTodosOnly:function(){this.showAssignedOnly=m.models.customization.get("assigned-"+this.id)},topMenuItems:function(){return this._topMenuItems||(this._topMenuItems=new m.collect.TopDropdownMenuItems(null,{listId:this.id})),this._topMenuItems},refreshItems:function(){this.doItemFetchIfNeeded(!0)},doItemFetchIfNeeded:function(e){(e||!this.itemFetchStarted)&&(this.itemFetchStarted=!0,this.itemCollection.doFetchIfNeeded(e))},triggerChangeEvent:function(){this.trigger("change",this),m.trigger("todo:globalChange")},getDefaultCommands:function(){return[{commandId:"todo.move.type",options:{target:"inbox"}},{commandId:"todo.move.type",options:{target:"today"}}]},isDoneList:function(){var e=this.get("type");return"done"==e?!0:!1},listType:function(){return this.get("type")},displayConnectingText:function(e){},successfulConnection:function(){},failedConnection:function(e){},remainingTodoCount:function(){var e=this.get("count");return e?e:""},showAssignedTodosOnly:function(){return this.get("assigned_support")&&this.showAssignedOnly},remainingCountChanged:function(e){var t=this.get("count");t!=e&&this.set("count",e)},supportsReordering:function(){var e=this.get("reorder");return e?!0:!1},groupingInfo:function(){return this.isDoneList()?{type:"date",field:"completedDate"}:null},createNewModel:function(e,t){var i=null;e instanceof Backbone.Model?i=e:this.isDoneList()?(e.listId="##default",i=new m.models.TodoProxy(e)):(e.listId=this.id,i=new m.models.TodoProxy(e),this.proxyCollection.add(i));var n=this;t?n.displayConnectingText('<i class="loading-icon"></i>Retrying...'):n.displayConnectingText('<i class="loading-icon"></i>Saving...'),i.set({saveFailed:!1,isLoading:!0}),n.itemCollection.create({title:i.get("title"),listId:i.get("listId")},{wait:!0,success:function(){n.successfulConnection(),i.set("proxyValid",!1),m.sendEvent("Todo","Add")},error:function(e,t,o){n.failedConnection('Error saving… <span class="retry">Retry</span>'),i.set({saveFailed:!0,isLoading:!1}),i.targetList=n}})}}),m.models.TodoProvider=Backbone.Model.extend({fetchStarted:!1,initialize:function(){this.prefetchTodos=this.get("prefetchTodos"),this.listCollection=new m.collect.ProviderTodoLists(null,{provider:this,prefetchTodos:this.prefetchTodos}),this.listenTo(this,"add",this.onAdd),this.listenTo(this,"change:count",this.countChanged),this.listenTo(this.listCollection,"reset selectionChanged",this.triggerChangeEvent)},refreshItems:function(){this.listCollection.fetch()},doFetchIfNeeded:function(e){(e||!this.fetchStarted)&&(this.fetchStarted=!0,this.listCollection.doFetchIfNeeded(e),this.refreshTodoItems())},refreshTodoItems:function(){var e=this.selectedList();e&&e.refreshItems()},getListOfType:function(e){return this.listCollection.getListOfType(e)},triggerChangeEvent:function(){this.trigger("change",this)},selectedList:function(){return this.listCollection?this.listCollection.selectedItem():null},providerStatus:function(){if(this.listCollection.listStatus)return this.listCollection.listStatus;var e=this.selectedList();return e?e.itemCollection.listStatus:null},selectList:function(e){var t=this.listCollection;t.selectItem(e)},selectPreviousList:function(){if(this.listCollection){var e=this.listCollection.selectedItem();if(e){var t=this.listCollection.indexOf(e);if(t>0){var i=this.listCollection.at(t-1);i&&this.selectList(i.id)}}}},selectNextList:function(){if(this.listCollection){var e=this.listCollection.selectedItem();if(e){var t=this.listCollection.indexOf(e);if(t<this.listCollection.length-1){var i=this.listCollection.at(t+1);i&&this.selectList(i.id)}}}}}),m.collect.TodoProxy=Backbone.Collection.extend({model:m.models.TodoProxy,initialize:function(e,t){t&&t.parentList&&(this.parentList=t.parentList)}}),m.collect.TodosBase=Backbone.Collection.extend({model:m.models.Todo,saveOptions:{},initialize:function(e,t){t&&t.parentList&&(this.parentList=t.parentList),localStorage.showTodoList||(localStorage.showTodoList=!1),this.listenTo(m,"newDay",this.onNewDay),this.listenTo(this,"reset",this.onReset),this.listenTo(this,"sync",this.onSync),this.listenTo(this,"add remove change",this.collectionChanged),this.listenTo(this,"reorder",this.reorderItem)},onReset:function(){this.loadingFromServer=!1,this.clearCompleted(),this.onLoadingFromServerChanged(),this.trigger("loadingFromServerChanged")},onSync:function(){this.loadingFromServer=!1,this.clearCompleted(),this.onLoadingFromServerChanged(),this.trigger("loadingFromServerChanged")},onNewDay:function(){this.fetch({reset:!0})},onLoadingFromServerChanged:function(){},clearCompleted:function(){},collectionChanged:function(e){localStorage.setItem("todos-updated",new Date),this.onCollectionChanged(e)},onCollectionChanged:function(e){},completeToday:function(){var e=this;return this.filter(function(t){var i=t.get("completedDate");if(i){var n="";if(i instanceof Date)n=activeDateStringForDate(i);else{var o=i.split("T");if(o.length>1)var n=o[0]}var s=getActiveDateString();if(n!=s)return!1}return 1==t.get("done")&&0==t.get("archive")&&0==t.get("deleted")&&t.get("listId")==e.parentList.id?!0:void 0})},completedCount:function(){var e=this.completeToday();return e.length},activeToday:function(){var e=this;return this.parentList.isDoneList()?this.where({deleted:!1,done:!0}):this.filter(function(t){if(0==t.get("archive")&&0==t.get("deleted")){var i=t.get("listId");if(i==e.parentList.id||!i)return!0;if("1-##default"==e.parentList.id)return!0}})},done:function(){return this.where({done:!0})},deleted:function(){return this.where({deleted:!0})},remaining:function(){var e=this.activeToday();if(this.parentList.isDoneList())return e;var t=_.filter(e,function(e){return!e.get("done")});return t},nextOrder:function(){return this.length?this.last().get("order")+100:100},comparator:"order",create:function(e,t){return void 0==e.order&&(e.order=this.nextOrder()),Backbone.Collection.prototype.create.call(this,e,t)},reorderItem:function(e){},hasValidCachedCompletedCount:function(){return!0}}),m.collect.ProviderTodoLists=Backbone.Collection.extend({model:m.models.TodoList,url:m.globals.urlRoot+"todos/lists",loadedFromCache:!1,listStatus:null,initialize:function(e,t){if(this.listenTo(this,"reset",this.collectionChanged),this.listenTo(this,"sync",this.collectionSync),this.listenTo(this,"change:count",this.handleCountChanged),t&&t.prefetchTodos&&(this.externallyFetchedOnce=!0),t&&t.provider){this.provider=t.provider;var i=this.listCacheKey(),n=localStorage[i];if(n){var o=JSON.parse(n);o&&o.length>0&&(this.loadedFromCache=!0,this.reset(o))}}},comparator:"order",mergeLists:function(e){var t=e;e&&e.lists&&(t=e.lists);var i=this,n=this.selectedItem();if(0==t.length?_.each(t,function(e){i.add(e,{merge:!0})}):this.set(t,{merge:!0}),!this.contains(n)){var o=this.models[0];this.selectItem(o.id)}},listCacheKey:function(){return this.provider?"listCache-"+this.provider.id:"listCache-default"},selectedListCacheKey:function(){return this.provider?"activeTodoListId-"+this.provider.id:null},cacheLists:function(){var e=JSON.stringify(this.models),t=this.listCacheKey();localStorage[t]=e},doFetchIfNeeded:function(e){this.forceFetch=!0,this.externallyFetchedOnce=!0,this.loadedFromCache?this.fetch():this.fetch({reset:!0})},parse:function(e){return e.aux_data_cmd&&(this.aux_data_cmd=e.aux_data_cmd),e.aux_data&&(this.aux_data=e.aux_data),e.lists},handleCountChanged:function(){this.checkSelectedItem(),this.cacheLists()},collectionSync:function(){this.setStatus(null),this.checkSelectedItem(this.forceFetch),this.forceFetch=!1,this.cacheLists()},setStatus:function(e){this.listStatus=e,m.trigger("todo:loadingStateChange",e)},fetch:function(e){var t=this,i=e||{};if(this.provider){var n={};n.data={provider_id:this.provider.id},i=_.extend(i,n)}return i.error=function(e,i,n){return this.externallyFetchedOnce=!0,403==i.status&&i.responseJSON&&i.responseJSON.status&&"authRequired"==i.responseJSON.status?void t.setStatus({status:"error",message:"Authentication Required…",actionMessage:"Connect",action:"auth.connect",actionParameter:i.responseJSON}):void t.setStatus({status:"error",message:"Trouble connecting…",actionMessage:"Retry",action:"todo.connection.retry"})},i&&void 0!=i.reset?this.setStatus({status:"loading",message:"Loading..."}):this.listStatus&&"loading"!=this.listStatus.status&&this.setStatus({status:"loading",message:"Loading..."}),Backbone.Collection.prototype.fetch.call(this,i)},collectionChanged:function(){this.setStatus(null),this.checkSelectedItem(this.forceFetch),this.forceFetch=!1},selectedItem:function(){return this.selectedListId?this.get(this.selectedListId):null},getListOfType:function(e){return this.findWhere({type:e})},unSelectedItems:function(){var e=this;return this.selectedListId?this.reject(function(t){return t.id==e.selectedListId}):this.toArray()},isDoneList:function(){var e=this.selectedItem();return e&&e.get("done")?!0:!1},checkSelectedItem:function(e){if(!this.selectedListId){var t=null,i=this.selectedListCacheKey();if(i&&localStorage.getItem(i)){var n=localStorage.getItem(i);t=this.findWhere({id:n})}if(t||(t=this.findWhere({selected:!0})),!t&&this.models.length>0)return t=this.models[0],void this.selectItem(t.id);t?this.selectItem(t.id):this.selectItem(null)}},selectItem:function(e){if(e!=this.selectedListId){var t=this.selectedListCacheKey();t&&localStorage.setItem(t,e),this.selectedListId=e,this.trigger("selectionChanged"),null!=e&&this.externallyFetchedOnce&&this.selectedItem().doItemFetchIfNeeded(!0)}}}),m.collect.Todos=m.collect.TodosBase.extend({url:m.globals.urlRoot+"todos",previousCount:-1,saveOptions:{patch:!0},listStatus:null,firstLoadCompleted:!1,reorderItem:function(e){var t=this,i={operations:[{REORDER:{move_id:e.move_id,move_target_id:e.move_target_id,move_offset:e.move_offset}}]},n=this.get(e.move_id);n&&(n.set({isLoading:!0}),$.ajax({type:"PATCH",contentType:"application/json",data:JSON.stringify(i),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"todos"}).done(function(e){n.set({isLoading:!1}),t.fetch()}).fail(function(e,t){n.pendingReorderData=i,n.set({saveFailed:!0,isLoading:!1})}))},onLoadingFromServerChanged:function(){this.setStatus(null),this.checkRemainingItemCount()},onCollectionChanged:function(e){this.checkRemainingItemCount()},completedCount:function(){var e=this.completeToday();return e.length},checkRemainingItemCount:function(){if(!this.loadingFromServer){this.firstLoadCompleted=!0;var e=this.remaining(),t=e.length;t!=this.previousCount&&(this.previousCount=t,this.trigger("remainingCountChanged",t))}},doFetchIfNeeded:function(e){this.firstItemFetchStarted?this.fetch():(this.firstItemFetchStarted=!0,this.fetch({reset:!0}))},setStatus:function(e){this.listStatus=e,m.trigger("todo:loadingStateChange",e)},parse:function(e){return e.items?(e.sections?this.itemSections=e.sections:this.itemSections=null,e.menu_options?this.menuOptions=e.menu_options:this.menuOptions=null,e.default_commands?this.defaultCommands=e.default_commands:this.defaultCommands=null,e.items):e},activeToday:function(){var e=this;if(!this.firstItemFetchStarted)return this.doFetchIfNeeded(),[];if(this.parentList.isDoneList()){if(e.parentList.showAssignedTodosOnly()&&!item.get("assigned"))return;return this.where({deleted:!1,done:!0})}return this.filter(function(t){if((!e.parentList.showAssignedTodosOnly()||t.get("assigned"))&&0==t.get("archive")&&0==t.get("deleted")){var i=t.get("listId");if(i==e.parentList.id||!i)return!0;if("1-##default"==e.parentList.id)return!0}})},fetch:function(e){var t=this;if(!this.loadingFromServer){this.loadingFromServer=!0;var i={};return this.parentList&&(i.data={listId:this.parentList.id}),i.error=function(e,i,n){return t.loadingFromServer=!1,403==i.status&&i.responseJSON&&i.responseJSON.status&&"authRequired"==i.responseJSON.status?void t.setStatus({status:"error",message:"Authentication Required…",actionMessage:"Connect",action:"auth.connect",actionParameter:i.responseJSON}):void t.setStatus({status:"error",message:"Trouble connecting…",actionMessage:"Retry",action:"todo.connection.retry"})},e=_.extend(e||{},i),e&&void 0!=e.reset?this.setStatus({status:"loading",message:"Loading..."}):this.listStatus&&"loading"!=this.listStatus.status&&this.setStatus({status:"loading",message:"Loading..."}),Backbone.Collection.prototype.fetch.call(this,e)}}}),m.collect.TodosLegacy=m.collect.TodosBase.extend({localStorage:new Backbone.LocalStorage("momentum-todo"),isLegacy:!0,fetch:function(e){return e=e||{},Backbone.Collection.prototype.fetch.call(this,e)},createOrderGaps:function(){var e=100;this.each(function(t){t.save({order:e},{silent:!0}),e+=100})},clearCompleted:function(e){var t="archived-"+getActiveDateString();if(e||!localStorage[t]){localStorage.setItem(t,Date.now());var i=!1,n=this.completeToday();_.each(n,function(e){var t=e.get("completedDate");if(t){var n=Date.parse(t),o=activeDateStringForDate(n);o!=getActiveDateString()&&(e.archive(),i=!0)}}),i&&this.trigger("reset")}},reorderItem:function(e){var t=this.get(e.move_id),i=this.get(e.move_target_id),n=e.move_offset>0?1:-1,o=this.indexOf(i),s=1;if(o+n>=0&&o+n<this.length){var a=this.at(o+n);s=Math.abs(a.get("order")-i.get("order")),20>=s&&(this.createOrderGaps(),s=Math.abs(a.get("order")-i.get("order")))}var l=i.get("order")+Math.ceil(s/2)*n;t.save({order:l},{silent:!0})}}),m.collect.TodoProviders=Backbone.Collection.extend({model:m.models.TodoProvider,url:m.globals.urlRoot+"todos/providers",loadedOnce:!1,initialize:function(e,t){this.listenTo(this,"reset",this.collectionReset)},collectionReset:function(){this.loadedOnce=!0},parse:function(e){return e.connected?e.connected:null}}),m.models.TodoListManager=Backbone.Model.extend({mergeLists:function(e){},defaults:{activeTodoList:null},initialize:function(e){if(e&&e.prefetchTodos&&(this.prefetchTodos=!0),this.todoProviders=new m.collect.TodoProviders,this.listenTo(this.todoProviders,"reset",this.todoProvidersReset),!localStorage.activeTodoProvider)return void this.changeProvider(1,!0);var t=JSON.parse(localStorage.activeTodoProvider);return t?void this.changeProvider(t,!0):void this.changeProvider(1,!0)},triggerChangeEvent:function(){this.trigger("change",this)},doFetchIfNeeded:function(e){this.externallyFetchedOnce=!0,this.activeProvider.doFetchIfNeeded(e)},changeProvider:function(e,t){var i=this.todoProviders.get(e);i||(this.todoProviders.add({id:e,prefetchTodos:this.prefetchTodos}),i=this.todoProviders.get(e)),i&&this.activeProvider!=i&&(m.trigger("todo:topmenu:reset"),localStorage.activeTodoProvider=JSON.stringify(i.id),this.activeProvider&&this.stopListening(this.activeProvider),this.activeProvider=i,this.listenTo(this.activeProvider,"change",this.triggerChangeEvent),this.triggerChangeEvent(),(this.externallyFetchedOnce||this.prefetchTodos)&&(this.activeProvider.refreshTodoItems(),this.activeProvider.doFetchIfNeeded(!0)),m.trigger("todo:providerChanged",e))},todoProvidersReset:function(){this.pendingResetCallback&&(this.pendingResetCallback(),this.pendingResetCallback=null)},todoProviderDetails:function(e){if(this.todoProviders){if(this.todoProviders.loadedOnce)return this.todoProviders.get(e);if(this.cachedTodoProviders){var t=this.cachedTodoProviders.findWhere({id:e});if(t)return t}if(localStorage.cachedTodoProviders){this.cachedTodoProviders=new Backbone.Collection(JSON.parse(localStorage.cachedTodoProviders));var t=this.cachedTodoProviders.findWhere({id:e});if(t){if(localStorage.tsCachedTodoProviders){var i=new Date,n=JSON.parse(localStorage.tsCachedTodoProviders),o=new Date(n),s=new Date(i.getTime()-864e5);s>o&&this.fetchAndCacheTodoProviders()}else this.fetchAndCacheTodoProviders();return t}}return this.fetchAndCacheTodoProviders(),null}},fetchAndCacheTodoProviders:function(e){var t=this;this.fetchingTodoProviders||(this.fetchingTodoProviders=!0,this.pendingResetCallback=function(){t.cacheTodoProviders(),e?e():t.triggerChangeEvent()},this.todoProviders.fetch({reset:!0}))},cacheTodoProviders:function(){if(this.todoProviders&&this.todoProviders.loadedOnce){var e=new Date;localStorage.setItem("tsCachedTodoProviders",JSON.stringify(e.getTime()));var t=this.todoProviders.toJSON();localStorage.setItem("cachedTodoProviders",JSON.stringify(t))}},selectPreviousProvider:function(){var e=this,t=function(){var t=e.todoProviders.get(e.activeProvider.id);if(t){var i=e.todoProviders.indexOf(t);if(i>0){var n=e.todoProviders.at(i-1);n&&e.changeProvider(n.id,!0)}}};this.todoProviders&&(this.todoProviders.loadedOnce?t():this.fetchAndCacheTodoProviders(t))},selectNextProvider:function(){var e=this,t=function(){var t=e.todoProviders.get(e.activeProvider.id);if(t){var i=e.todoProviders.indexOf(t);if(i<e.todoProviders.length-1){var n=e.todoProviders.at(i+1);n&&e.changeProvider(n.id,!0)}}};this.todoProviders&&(this.todoProviders.loadedOnce?t():this.fetchAndCacheTodoProviders(t))}}),m.views.TodoDropdownMenu=Backbone.View.extend({template:m.templates.todos.dropdownmenu,expanded:!1,renderedOnce:!1,menuOptionsFetched:!1,events:{"click .control-dropdown":"toggleDropdown","dblclick .control-dropdown":"eatDblClick","click li":"clickMenuItem"},initialize:function(e){this.menuItems=e.menuItems,this.parentContext=e.parentContext,this.comparisonNode=e.comparisonNode,this.iClassName=e.iClassName,this.heightChangeCallback=e.heightChangeCallback,this.listenTo(this.menuItems,"add remove reset",this.renderMenuOptions),this.listenTo(m,"globalEvent:closeDropdowns",this.closeDropdown),this.listenTo(m,"globalEvent:esc globalEvent:click",this.closeDropdown),this.subViews=[]},render:function(){var e={};this.iClassName&&(e.iClassName=this.iClassName);var t=this.template(e);this.$el.html(t),this.$dropdown=$(this.$el.find(".dropdown")[0])},resetMenuItems:function(){this.menuOptionsFetched=!1;var e=this.expanded;this.expanded=void 0,e&&this.setExpandedState(e)},setExpandedState:function(e){this.expanded!=e&&(void 0!=e&&(this.expanded=e),this.$el.toggleClass("active",this.expanded),this.expanded?(this.$dropdown.show(),this.menuOptionsFetched||(this.$dropdown.html('<li class="loading"><i class="loading-icon"></i> Loading...</li>'),this.renderMenuOptions())):this.$dropdown.hide(),this.ensureVisible())},eatDblClick:function(e){e&&(e.preventDefault(),e.stopPropagation())},closeDropdown:function(e){this!=e&&this.expanded===!0&&this.setExpandedState(!1)},attachMenuItems:function(e,t){this.menuItems&&this.menuItems!=t&&this.stopListening(this.menuItems),this.$el!=e&&(this.setElement(e),this.renderedOnce=!1),this.menuItems!=t&&(this.menuItems=t,this.listenTo(this.menuItems,"add remove reset",this.renderMenuOptions),this.menuOptionsFetched=!1),this.expanded=!1,this.render()},renderMenuOptions:function(){var e=this;if(this.items=this.getActiveMenuOptions(),this.items){this.$dropdown.html("");var t=this.items.filter(function(t){return m.commandManager.canExecute(t.get("commandId"),e.model,t.get("options"),e.parentContext)}),i=t.length;if(i>0){var n=0;_.each(t,function(t){var o=t.get("css_class");if("line"==o&&(0==n||n==i-1))return void(n+=1);var s=$("<li/>");if(t.id?s.attr("data-itemid",t.id):s.attr("data-itemid",t.cid),t.get("captionText")&&s.text(t.get("captionText")),t.get("imageUrl")){var a=$("<img />");a.addClass("dropdown-list-icon"),a.attr("src",t.get("imageUrl")),s.prepend(a)}if(t.get("checkStateCmd")){var l=m.commandManager.execute(t.get("checkStateCmd"),e.model,t.get("options"),e.parentContext);l&&s.prepend('<i class="icon icon-check dropdown-list-icon"></i>')}o&&s.addClass(o),e.$dropdown.append(s),n+=1})}}else 0==this.items&&e.$dropdown.html('<li class="loading"><i class="loading-icon"></i> Loading...</li>');this.ensureVisible(),this.menuOptionsFetched=!0},getActiveMenuOptions:function(){return this.menuItems.fetchIfRequired&&this.menuItems.fetchIfRequired()?!1:this.menuItems},toggleDropdown:function(e){e&&(e.stopPropagation(),e.preventDefault()),this.expanded||m.trigger("globalEvent:closeDropdowns",this),this.setExpandedState(!this.expanded)},clickMenuItem:function(e){e.preventDefault(),e.stopPropagation();var t=$(e.target),i=t.data("itemid");if(i&&this.items){var n=this.items.get(i),o=m.commandManager.execute(n.get("commandId"),this.model,n.get("options"),this.parentContext);n.get("checkStateCmd")&&this.renderMenuOptions(),o||this.closeDropdown()}},expandedHeight:function(){return this.expanded?this.$dropdown.outerHeight():0},ensureVisible:function(){if(this.heightChangeCallback&&this.heightChangeCallback(),this.comparisonNode&&this.$dropdown&&this.expanded){var e=$(this.comparisonNode),t=this.$dropdown.parentsUntil(".todo-item").parent(),i=(t.find(".control-dropdown"),this.$dropdown.outerHeight());i>e.outerHeight()&&this.comparisonNode.css({"min-height":i+2+"px"});var n=e.offset().top+e.outerHeight(),o=t.offset().top+t.outerHeight()+i,s=n-o;0>s?this.$dropdown.css({top:s+18+"px",right:"15px"}):this.$dropdown.css({top:"20px"}),this.$dropdown.css({bottom:"auto"}).show()}}}),m.views.NewTodoInput=Backbone.View.extend({events:{keyup:"handleKeyup",keydown:"handleKeydown"},initialize:function(e){this.parent=e.parent,this.listenTo(m,"todo:loadingStateChange",this.render)},render:function(){var e=this.model.activeProvider.selectedList();return e&&e.get("add_hidden")?(this.$el.prop("disabled",!0),void this.$el.prop("placeholder","")):void(this.$el.is(":disabled")&&(this.$el.prop("disabled",!1),this.$el.prop("placeholder","New Todo")))},createOnEnter:function(e){var t=this.$el.val();if(t&&0!=t.length&&0!=t.trim().length){var i=this.model.activeProvider.selectedList();i&&(m.trigger("todo:hint:countChanged",null,!0),this.$el[0].value="",i.createNewModel({title:t}))}},focusInputField:function(){this.$el.focus()},handleKeyup:function(e){13==e.keyCode&&this.createOnEnter(),27==e.keyCode&&(e.stopPropagation(),this.$el.blur())},handleKeydown:function(e){var t=null;if(32==e.keyCode?t="globalEvent:spacebar":37==e.keyCode?t="globalEvent:arrowLeft":39==e.keyCode&&(t="globalEvent:arrowRight"),t){var i=this.$el.val();i&&0!=i.length&&0!=i.trim().length||(e.preventDefault(),e.stopPropagation(),m.trigger(t,e))}}}),m.views.TodoListHeader=Backbone.View.extend({events:{"click .todo-list-active":"toggleChooser","click .todo-list-choice":"chooseList","click .control-autofocus":"toggleAutoFocus","click #status-action":"statusActionClick"},choosing:!1,initialize:function(e){this.parent=e.parent,this.$activecontainer=$(this.$el.find(".todo-list-active")[0]),this.$choosercontainer=$(this.$el.find(".todo-list-chooser-dropdown")[0]),this.listenTo(m,"globalEvent:closeDropdowns",this.stopChoosing),this.listenTo(this.model,"change",this.handleManagerChange),this.listenTo(m,"todo:loadingStateChange",this.handleTodoLoadingStateChange),this.listenTo(m,"todo:providerChanged",this.providerChanged),this.listenTo(m,"todo:changed",this.todoChanged),this.listenTo(m.models.customization,"change:autoFocus",this.autoFocusChanged),this.listenTo(m,"globalEvent:click",this.globalClick),this.listenTo(m,"todo:showAssignedTodosOnlyChanged",this.showAssignedTodosOnlyChanged),this.listenTo(m,"todo:hint:countChanged",this.handleTodoCountHint),this.listenTo(m,"todo:status",this.renderActiveItem),this.listenTo(m,"todo:topmenu:reset",this.topMenuReset)},render:function(e){this.renderActiveItem(e),this.renderListChooser(),this.renderTopMenu()},toggleChooser:function(e){e&&(e.preventDefault(),e.stopPropagation()),this.model.activeProvider.listCollection.length>1&&(m.trigger("globalEvent:closeDropdowns",this),this.setChoosingState(!this.choosing))},globalClick:function(e){e!=this&&this.setChoosingState(!1)},todoChanged:function(e,t){t&&(t.hasOwnProperty("done")||t.hasOwnProperty("listId"))&&this.renderActiveItem()},topMenuReset:function(){this.topMenuDropdownView&&this.topMenuDropdownView.resetMenuItems()},autoFocusChanged:function(e){var t=e.changedAttributes();t.hasOwnProperty("autoFocus")&&this.renderActiveItem()},showAssignedTodosOnlyChanged:function(){this.renderActiveItem()},setChoosingState:function(e){this.choosing=e,this.$activecontainer.toggleClass("choosing",this.choosing),this.choosing?this.$choosercontainer.show():this.$choosercontainer.hide(),this.parent.setTodoListMinimumHeight()},expandedHeight:function(){var e=0,t=0;return this.choosing&&(e=this.$choosercontainer.outerHeight()),this.topMenuDropdownView&&(t=this.topMenuDropdownView.expandedHeight()),_.max([e,t])},stopChoosing:function(e){m.views;e!=this&&e!=m.views.todoPane&&this.setChoosingState(!1)},chooseList:function(e){e&&e.stopPropagation(),this.stopChoosing();var t=$(e.currentTarget).data("list-id");this.model.activeProvider.selectList(t)},toggleAutoFocus:function(e){e&&(e.preventDefault(),e.stopPropagation()),m.commandManager.execute("todo.toggle.autofocus")},statusActionClick:function(e){if(e){e.preventDefault(),e.stopPropagation();var t=$(e.currentTarget).data("action");t&&m.commandManager.execute(t,this.lastStatus)}},handleTodoCountHint:function(e,t){var i=this.model.activeProvider.selectedList();if(i&&i.itemCollection){var n=i.itemCollection.remaining(),o=n.length;t&&o++,this.$el.find("span.active-todo-count").text(o)}},renderActiveItem:function(e){if(this.model.activeProvider.listCollection){var t={};e||(e=this.model.activeProvider.providerStatus()),e&&(this.lastStatus=e,"loading"==e.status?(t.loadingClass="loading-icon",t.loadingMessage=e.message):e.message&&(t.statusMessage=e.message,e.actionMessage&&(t.actionMessage=e.actionMessage),e.action&&(t.action=e.action)));var i=this.model.activeProvider.selectedList();if(i&&(t.listTitle=i.get("title"),t.providerLogo=i.get("small_icon_url"),t.remaining=i.remainingTodoCount()),!t.providerLogo&&this.model.activeProvider&&1!=this.model.activeProvider.id){var n=this.model.todoProviderDetails(this.model.activeProvider.id);n&&(t.providerLogo=n.get("small_icon_url"))}if(!this.compareObjects(t,this.lastContext)){this.lastContext=t;var o=m.templates.todos.todolistactive(t);if(this.$activecontainer.html(o),i){var s=$(this.$el.find("#todo-top-menu")[0]);this.topMenuDropdownView?this.topMenuDropdownView.attachMenuItems(s,i.topMenuItems()):this.topMenuDropdownView=new m.views.TodoDropdownMenu({el:s,iClassName:"icon-cog",menuItems:i.topMenuItems(),heightChangeCallback:this.topMenuDropdownHeightChanged.bind(this),model:i}),this.topMenuDropdownView.render()}}this.$activecontainer.find(".control-autofocus").toggleClass("active",m.models.customization.get("autoFocus"));var a=!i||this.model.activeProvider.listCollection.length<=1;this.$activecontainer.find(".icon-angle-down").toggle(!a),a&&this.$activecontainer.find("li").css({Cursor:"default"}),this.parent.setMaxWidgetHeight()}},topMenuDropdownHeightChanged:function(){this.parent.setTodoListMinimumHeight()},compareObjects:function(e,t){return e==t?!0:JSON.stringify(e)==JSON.stringify(t)?!0:!1},renderListChooser:function(){var e=this,t=this.model.activeProvider.listCollection;if(t){var i=t.unSelectedItems();
this.$choosercontainer.html(""),_.map(i,function(t){var i={};i.listId=t.id,i.title=t.get("title"),i.count=t.get("count");var n=m.templates.todos.todolistchoice(i);e.$choosercontainer.append(n)})}},renderTopMenu:function(){},handleManagerChange:function(){this.render()},handleTodoLoadingStateChange:function(e){this.render(e)},providerChanged:function(){this.render()}}),m.views.TodoItem=Backbone.View.extend({attributes:{"class":"todo-item"},tagName:"li",template:m.templates.todos.todoitem,events:{"click .todo-item-checkbox":"toggleDone","dblclick .view":"edit","keyup .edit":"handleInput","blur .edit":"abortEdit","click .error-icon":"retrySave",dragstart:"dragstart",dragenter:"dragenter",mouseenter:"onMouseEnter",mouseleave:"onMouseLeave"},editing:!1,renderedOnce:!1,initialize:function(e){this.parent=e.parent,this.provider=e.provider,this.listId=e.list_id,this.menu_options=e.menu_options,this.selectedList=this.provider.selectedList(),this.isDoneList=this.selectedList.isDoneList(),this.listenTo(this.model,"change",this.render),this.listenTo(m,"todo:refresh",this.refreshTodo),this.listenTo(m,"todo:set:done",this.setDone)},refreshTodo:function(e){e==this.model.id&&this.model.fetch()},setDone:function(e,t){e==this.model.id&&this.model.set("done",t)},render:function(){if(this.model.get("deleted"))return this.hideTodoItem(),this;if(!this.isDoneList&&this.model.get("listId")!=this.listId)return this.hideTodoItem(),this;var e=m.utils.captionFormatter(this.model.getValue("title"));if(this.renderedOnce)this.$title.text(e),this.$edit.val(e);else{var t={title:e};this.$el.html(this.template(t)),this.$title=this.$el.find(".todo-item-title").first(),this.$edit=this.$el.find(".todo-input").first(),this.$view=this.$el.find(".view").first(),this.$checkbox=this.$el.find(".todo-item-checkbox").first(),this.renderedOnce=!0}if(this.$checkbox.prop("checked",this.model.isTrue("done")),this.$view.toggleClass("done",this.model.isTrue("done")),this.$view.toggleClass("loading",this.model.isTrue("isLoading")),this.$view.toggleClass("failed",this.model.isTrue("saveFailed")),this.$el.attr("data-todo-id",this.model.id),this.model.isTrue("isProxy")?(this.$el.toggle(this.model.isTrue("proxyValid")),this.$el.addClass("isproxy"),this.$el.data("cid",this.model.cid)):this.selectedList.supportsReordering()&&this.$el.prop("draggable","true"),this.menu_options){var i=$(this.$el.find(".dropdown-container")[0]);this.topMenuDropdownView||(this.topMenuDropdownView=new m.views.TodoDropdownMenu({el:i,iClassName:"icon-ellipsis",menuItems:this.menu_options,model:this.model,parentContext:this.provider,comparisonNode:this.parent.$el})),this.topMenuDropdownView.render()}return this},hideTodoItem:function(){this.$el.html(""),this.$el.hide(),this.stopListening(m,"globalEvent:spacebar"),this.parent&&(this.parent.setListHeight(),this.parent.checkForEmptyState())},isHidden:function(){return!this.$el.is(":visible")},scrollIntoView:function(){this.$el[0].scrollIntoView(!1)},destroy:function(){this.stopListening(),this.remove(),this.unbind()},abortEdit:function(){this.editing=!1,this.$edit.val(this.model.get("title")),this.$el.removeClass("editing")},saveEdit:function(){this.editing=!1;var e=this.$edit.val();e?(this.$el.removeClass("editing"),this.model.attemptSave({title:e})):this.clear()},retrySave:function(){this.model.isTrue("isProxy")?this.model.targetList&&this.model.targetList.createNewModel(this.model,!0):(this.model.attemptedSaveValues||this.model.pendingReorderData)&&this.model.attemptSave()},edit:function(e){if(e.stopPropagation(),!(this.$el.hasClass("isproxy")||this.$view.hasClass("loading")||this.$view.hasClass("failed"))){this.editing=!0,this.$el.addClass("editing"),this.$edit.focus();var t=this.$edit[0];t.selectionStart=t.selectionEnd=t.value.length,t.scrollLeft=t.scrollWidth,m.sendEvent("Todo","Activate Edit")}},dragstart:function(e){if(e.stopPropagation(),this.editing)return!1;if(e.originalEvent.dataTransfer.effectAllowed="move",e.originalEvent.dataTransfer.setData("todo_id",this.model.id),0==this.model.get("leafNode")){var t=e.currentTarget.querySelector(".view").cloneNode(!0);t.className="ghost",t.style.position="absolute",t.style.zIndex="-1",t.querySelector(".todo-item-checkbox").style.marginTop="3px",e.currentTarget.appendChild(t),e.originalEvent.dataTransfer.setDragImage(t,e.originalEvent.offsetX-15,e.originalEvent.offsetY+2)}this.parent.dragmode="todo",this.parent.dragging=this,this.parent.original_index=this.parent.li_index(this.$el,!0),0!=this.parent.original_index?(this.parent.$preceeding_item=this.previousSiblingTodo(),this.parent.preceedingTodoId=this.previousSiblingTodoId()):(this.parent.$preceeding_item=null,this.parent.preceedingTodoId=null),m.sendEvent("Todo","Reorder")},dragenter:function(e){if(e.stopPropagation(),"todo"==this.parent.dragmode){if(!this.isSibling(this.parent.dragging.model))return!0;this.parent.dragging.$el.hide(),this.parent.li_index(this.parent.$placeholder)<this.parent.li_index(this.$el)?(this.$el.after(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=1):(this.$el.before(this.parent.$placeholder),this.parent.move_target_id=this.model.id,this.parent.move_offset=-1);var t=this.parent.$placeholder;return this.parent.$placeholder.css("display","list-item"),t.height(this.parent.dragging.$el.height()),t.after(this.parent.dragging.$el),!1}},isSibling:function(e){return this.model.isSibling(e)},previousSiblingTodo:function(){return this.$el.prevAll("li").not(".placeholder").first()},previousSiblingTodoId:function(){return this.$el.prevAll("li").not(".placeholder").first().data("todo-id")},onMouseEnter:function(e){this.listenTo(m,"globalEvent:spacebar",this.invokeDefaultCommand)},onMouseLeave:function(e){this.stopListening(m,"globalEvent:spacebar")},invokeDefaultCommand:function(){var e=this,t=this.selectedList.getDefaultCommands();if(t&&t.length>0){var i=_.find(t,function(t){return m.commandManager.canExecute(t.commandId,e.model,t.options,e.provider)?!0:!1});i&&m.commandManager.execute(i.commandId,e.model,i.options,e.provider)}},toggleDone:function(e){if(e&&e.stopPropagation(),this.selectedList.has("done_disabled")){e&&e.preventDefault();var t=this.selectedList.get("done_disabled");return void(t.message&&m.trigger("todo:status",t))}m.sendEvent("Todo","Done");var i=!this.model.get("done");this.model.attemptSave({done:i,completedDate:i?new Date:null}),this.topMenuDropdownView.resetMenuItems(),m.trigger("todo:hint:countChanged",this.model.id)},handleInput:function(e){13==e.keyCode&&(this.saveEdit(),m.sendEvent("Todo","Edit")),27==e.keyCode&&(e.stopPropagation(),this.$el.find("input").blur())}}),m.views.TodoList=Backbone.View.extend({events:{dragover:"dragover",dragend:"dragend",drop:"drop","click .empty-link":"clickEmptyStateLink"},reordered:!1,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],weekdayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],itemsRendered:!0,initialize:function(){this.subViews=[],this.listenTo(this.model,"change",this.providerChanged),this.listenTo(m,"todo:loadingStateChange",this.handleTodoLoadingStateChange),this.listenTo(m,"todo:providerChanged",this.providerChanged),this.listenTo(m,"todo:showAssignedTodosOnlyChanged",this.showAssignedTodosOnlyChanged),this.providerChanged()},render:function(){this.renderedOnce||(this.$placeholder=$("<li></li>").addClass("placeholder"),this.$placeholder.appendTo(this.el),this.$placeholder.hide(),this.renderedOnce=!0),this.$el.removeClass().addClass("todo-list");var e=this.model.activeProvider.selectedList();if(e){var t=e.get("list_class");t&&this.$el.addClass(t)}var i=this.addAll();i?e&&e.isDoneList()&&this.$el.append('<li class="todo-load-more">Load More (Coming soon)</li>'):this.renderEmptyState()},dismissEmptyState:function(){this.emptyStateActive&&(this.$el.find(".empty").hide(),this.emptyStateActive=!1)},checkForEmptyState:function(){if(this.subViews){var e=_.every(this.subViews,function(e){return e.isHidden()});e&&this.render()}},renderEmptyState:function(){var e=this.model.activeProvider.selectedList();if(e&&e.itemCollection&&e.itemCollection.firstLoadCompleted){var t={};if(e.has("empty_message"))t.message=e.get("empty_message"),t.submessage=e.get("empty_submessage"),t.use_command=!!e.get("empty_command");else if("today"==e.listType()){t.message="Add a todo to get started";var i=this.model.activeProvider.listCollection.getListOfType("inbox");if(i){t.targetListId=i.id;var n=i.get("count");1==n?t.submessage="1 todo in Inbox":n>1?t.submessage=n+" todos in Inbox":t.submessage="Switch to Inbox"}}else if("inbox"==e.listType()){t.message="Add a todo to get started";var o=this.model.activeProvider.listCollection.getListOfType("today");o&&(t.targetListId=o.id,t.submessage="Switch to Today")}else if("done"==e.listType()){t.message="Add a todo to get started";var o=this.model.activeProvider.listCollection.getListOfType("today");o&&(t.targetListId=o.id,t.submessage="Switch to Today")}else t.message="Add a todo to get started";this.emptyStateActive=!0,this.$el.append(m.templates.todos["todo-list-empty-state"](t)),this.itemsRendered=!0,this.setListHeight()}},addedToProxyCollection:function(e){this.dismissEmptyState(),this.addOne(e)},addOne:function(e,t){var i=null,n=this.model.activeProvider.selectedList();n&&(i=n.todoItemMenuOptions());var o=new m.views.TodoItem({model:e,parent:this,menu_options:i,provider:this.model.activeProvider,list_id:n.id});this.subViews.push(o);var s=e.get("parentId");if(s){var a=this.getTodoSubelementContainer(s);a?a.append(o.render().el):this.$el.append(o.render().el)}else this.$el.append(o.render().el);e.get("isProxy")&&e.get("proxyValid")&&(o.scrollIntoView(),this.newTodoAdded=!0),t||this.setListHeight()},getTodoSubelementContainer:function(e){var t=this.$el.find('[data-todo-id="'+e+'"]');if(t&&t.length>0){var i=$(t[0]).find("ol");if(!i||0==i.length){var n=$("<ol />");return $(t[0]).append(n),n}return $(i)}return null},addAll:function(){var e=this,t=!1;this.reordered=!1,_.each(this.subViews,function(e){e&&e.destroy()}),this.subViews=[],this.$el.html("");var i=this.model.activeProvider.selectedList();if(i){var n=i.itemCollection.activeToday(),o=i.proxyCollection.where({proxyValid:!0});n.length>0&&(t=!0),o&&o.length>0&&(t=!0);var s=!1,a=i.groupingInfo();if(a&&"date"==a.type){if(!_.isEmpty(n)){var l=_.map(n,function(e){var t=e.get(a.field),i=new Date(t);return{sortDate:i.getTime(),year:i.getFullYear(),month:i.getMonth(),day:i.getDate(),item:e}}),r=_(l).chain().sortBy("sortDate").reverse().value(),d=null,c=null,u=null;_.each(r,function(t){if(t.year!=d||t.month!=c||t.day!=u){d=t.year,c=t.month,u=t.day;var i=e.formatDate(t);e.$el.append('<li class="todo-section" title="'+i.calendarDate+'">'+i.friendlyDate+"</li>")}e.addOne(t.item,!0)})}s=!0}s||(_.each(n,function(t){e.addOne(t,!0)},this),_.each(o,function(t){e.addOne(t,!0)},this))}if(t&&(this.itemsRendered=!0),this.setListHeight(),this.newTodoAdded){var h=this.$el.children().last();h&&h.length>0&&h[0].scrollIntoView(!1),this.newTodoAdded=!1}return t},formatDate:function(e){var t=new Date,i=this.monthNames[e.month]+" "+e.day;if(e.year==t.getFullYear()&&e.month==t.getMonth()&&e.day==t.getDate())return{friendlyDate:"Today",calendarDate:i};var n=new Date(t.getTime()-864e5);if(e.year==n.getFullYear()&&e.month==n.getMonth()&&e.day==n.getDate())return{friendlyDate:"Yesterday",calendarDate:i};var o=new Date(e.sortDate),s=new Date(t.getTime()-5184e5);return o>s?{friendlyDate:this.weekdayNames[o.getDay()],calendarDate:i}:{friendlyDate:i,calendarDate:""}},setListHeight:function(e){var t=0;this.itemsRendered?(this.$el.css("min-height",0),t=this.$el.height(),this.storedTodoPaneHeight(t)):t=this.storedTodoPaneHeight(),void 0!=e&&(t=_.max([t,e]));var i=this.$el.css("max-height");if(i&&"none"!=i){var n=parseInt(i,10);t=_.min([t,n])}this.$el.css("min-height",t)},clickEmptyStateLink:function(e){if(e&&e.currentTarget){e.preventDefault(),e.stopPropagation();var t=$(e.currentTarget).data("use-command");if(t){var i=this.model.activeProvider.selectedList(),n=i.get("empty_command"),o=i.get("empty_command_options");return void m.commandManager.execute(n,null,o)}var s=$(e.currentTarget).data("target-list-id");s&&this.model.activeProvider.selectList(s)}},dragover:function(e){return e.preventDefault(),e.stopPropagation(),e.originalEvent.dataTransfer.dropEffect="move",!1},dragend:function(e){if(e.preventDefault(),e.stopPropagation(),"todo"==this.dragmode){var t=this.dragging.$el;"none"==e.originalEvent.dataTransfer.dropEffect&&(null!=this.$preceeding_item?this.$preceeding_item.after(t):this.$el.prepend(t)),this.$placeholder.hide(),t.show(),t.find(".ghost").remove()}return!1},drop:function(e){if("todo"==this.dragmode){var t=this.dragging.$el,i=$(this.move_target),n=this.dragging.model.id,o=this.move_target_id,s=this.move_offset,a=this.li_index(this.dragging.$el,!0);if(0==a&&0==this.original_index)return!1;if(n==o)return!1;if(this.preceedingTodoId==this.dragging.previousSiblingTodoId())return!1;var l=this.model.activeProvider.selectedList(),r=l.itemCollection.get(n),d=l.itemCollection.get(o);if(!r||!d||!r.isSibling(d))return!1;-1==this.move_offset?i.before(t):i.after(t),this.$placeholder.hide(),t.show(),l.itemCollection.reorderItem({move_id:n,move_target_id:o,move_offset:s}),this.reordered=!0}},getTopActiveTodoId:function(){return this.$("li").not(":has(>.done)").not(".placeholder").first().data("todo-id")},li_index:function(e,t){return t?this.$("li").not(".placeholder").index(e):this.$("li").index(e)},handleManagerChange:function(){this.render()},handleTodoLoadingStateChange:function(){this.render()},showAssignedTodosOnlyChanged:function(e){var t=this.model.activeProvider.selectedList();t&&t.id==e&&this.render()},providerChanged:function(){var e=this.model.activeProvider.selectedList();this.selectedList!=e&&(this.itemsRendered=!1,this.selectedList&&this.stopListening(this.selectedList.proxyCollection),this.selectedList=e,e&&this.listenTo(e.proxyCollection,"add",this.addedToProxyCollection)),this.render()},storedTodoPaneHeight:function(e){if(void 0!=e)return e>0&&localStorage.setItem("todo-pane-height",e),e;var t=localStorage["todo-pane-height"];return t?JSON.parse(t):null}}),m.views.TodoPane=Backbone.View.extend({attributes:{id:"todo","class":"widget-bottom-right todo"},template:m.templates.todos.todopane,renderedOnce:!1,todoListOpen:!1,events:{"click .todo-toggle":"toggleShow"},libraryLoadStarted:!1,initialize:function(){this.subViews=[],this.render(),this.listenToOnce(m,"background:loadSuccessful",this.onBackgroundLoaded),this.listenTo(m,"globalEvent:toggleTodo",this.toggleShow),this.listenTo(m,"globalEvent:toggle:bottom-right",this.onToggleBottomRight),this.listenTo(m,"globalEvent:esc",this.setTodoStateClosed),this.listenTo(m,"todo:visible",this.todoVisible),this.listenTo(m,"globalEvent:key:N",this.handleKeyPressN),this.listenTo(m,"globalEvent:arrowLeft",this.arrowLeft),this.listenTo(m,"globalEvent:arrowRight",this.arrowRight),this.listenTo(m,"globalEvent:window:resize",this.windowResize),this.listenTo(m,"todo:hidden",this.todoHidden),this.listenTo(m.models.customization,"change:todoVisible",this.visibleChanged),m.models.customization.get("keepTodoState")&&this.showTodoList()&&this.toggleShow()},showTodoList:function(){var e=localStorage.getItem("showTodoList");return e?JSON.parse(e):!1},render:function(){if(!this.renderedOnce){this.setMaxWidgetHeight();var e=this.template({}),t=(this.options.order||"append")+"To";this.$el[t]("#"+this.options.region).fadeTo(0,0).html(e).fadeTo(500,1),this.$panecontainer=this.$el.find(".todo-pane")[0],this.$listcontainer=this.$el.find(".todo-list")[0],this.$headercontainer=this.$el.find(".todo-header")[0],this.$newtodoinput=this.$el.find("#todo-new")[0],$("#todo").toggleClass("show",this.todoListOpen),this.setTodoListMinimumHeight(),this.renderedOnce=!0}return this},toggleShow:function(e){e&&(e.preventDefault(),e.stopPropagation()),m.trigger("globalEvent:click",this),m.trigger("globalEvent:closeDropdowns",this),m.trigger("globalEvent:toggle:bottom-right",this);var t=!this.todoListOpen;t?this.todoVisible():this.todoHidden(),this.setMaxWidgetHeight()},onToggleBottomRight:function(e){e!=this&&this.todoListOpen&&this.todoHidden()},setTodoStateClosed:function(e){e!=this&&(e.originalEvent&&"click"==e.type&&e.target&&$.contains(this.el,e.target)||this.todoHidden())},setTodoOpenState:function(e){this.todoListOpen=e,m.models.customization.get("keepTodoState")?localStorage.showTodoList=e:localStorage.showTodoList=!1,$("#todo").toggleClass("show",this.todoListOpen),e?(this.newTodoInput&&this.newTodoInput.focusInputField(),this.doFirstFetch()):this.todoHeader&&this.todoHeader.stopChoosing()},windowResize:function(){this.setMaxWidgetHeight(),this.setTodoListMinimumHeight()},setMaxWidgetHeight:function(){var e=$(window).height()-125;$(".pane").css("max-height",e);var t=$(".todo-pane");if(t){var i=t.find(".todo-list-active").outerHeight(),n=t.find(".todo-message").outerHeight(!0),o=t.find(".todo-new").outerHeight();0==i&&(i=39),null==n&&(n=0),0==o&&(o=38),t.find(".todo-list").css("max-height",e-(i+n+o)-3)}return e},doFirstFetch:function(){this.initializeManager(),m.models.todoListManager.externallyFetchedOnce=!0,m.models.todoListManager.activeProvider.doFetchIfNeeded(),m.models.todoListManager.activeProvider.refreshTodoItems()},todoVisible:function(){this.setTodoOpenState(!0)},todoHidden:function(){this.setTodoOpenState(!1)},onBackgroundLoaded:function(){this.initializeManager()},setTodoListMinimumHeight:function(){var e=0;this.todoHeader&&(e=this.todoHeader.expandedHeight());var t=this.storedTodoPaneHeight();if(t&&(e=_.max([e,t])),this.todoList)this.todoList.setListHeight(e);else{var i=$(".todo-list").css("max-height");if(i&&"none"!=i){var n=parseInt(i,10);e=_.min([e,n])}$(".todo-list").css("min-height",e)}},initializeManager:function(){m.models.todoListManager||(m.models.todoListManager=new m.models.TodoListManager({prefetchTodos:this.todoListOpen}),m.trigger("todo:managerReady"),this.todoHeader=new m.views.TodoListHeader({el:this.$headercontainer,model:m.models.todoListManager,parent:this}),this.todoList=new m.views.TodoList({el:this.$listcontainer,model:m.models.todoListManager}),this.newTodoInput=new m.views.NewTodoInput({el:this.$newtodoinput,model:m.models.todoListManager}),this.setMaxWidgetHeight())},visibleChanged:function(e){var t=m.models.customization.get("todoVisible");t?this.renderedOnce?this.$el.fadeIn(500):this.render():this.$el.fadeOut(500)},arrowLeft:function(e){this.todoListOpen&&(e.shiftKey?m.models.todoListManager.selectPreviousProvider():m.models.todoListManager.activeProvider&&m.models.todoListManager.activeProvider.selectPreviousList())},arrowRight:function(e){this.todoListOpen&&(e.shiftKey?m.models.todoListManager.selectNextProvider():m.models.todoListManager.activeProvider&&m.models.todoListManager.activeProvider.selectNextList())},handleKeyPressN:function(e){this.todoListOpen&&e.altKey&&(e&&(e.preventDefault(),e.stopPropagation()),this.newTodoInput.focusInputField())},storedTodoPaneHeight:function(e){if(void 0!=e)return e>0&&localStorage.setItem("todo-pane-height",e),e;var t=localStorage["todo-pane-height"];return t?JSON.parse(t):null}}),m.views.Greeting=Backbone.View.extend({id:"greeting",template:m.templates.greeting["greeting-template"],events:{"dblclick .name":"editName","keypress .name":"onKeypress","keydown .name":"onKeydown","blur .name":"saveName","webkitAnimationEnd .name":"onAnimationEnd"},initialize:function(){this.render(),this.listenTo(this.model,"change:time",this.updatePeriod,this),this.listenTo(m.models.customization,"change:displayname",this.onUpdateName)},render:function(){var e=this.getPeriod(),t=m.models.customization.get("displayname"),i={period:e,name:t},n=(this.options.order||"append")+"To";this.$el[n]("#"+this.options.region).fadeTo(0,0).html(this.template(i)).fadeTo(500,1),this.$period=this.$(".period"),this.$name=this.$(".name")},getPeriod:function(){var e,t=this.model.get("date"),i=t.getHours();return i>=3&&12>i&&(e="morning"),i>=12&&17>i&&(e="afternoon"),(i>=17||3>i)&&(e="evening"),e},updatePeriod:function(){this.$period.html(this.getPeriod())},editName:function(){this.$name.hasClass("editing")||(this.$name.attr("contenteditable",!0).addClass("editing pulse").focus(),setEndOfContenteditable(this.$name.get(0)))},onUpdateName:function(){this.$name.html(m.models.customization.get("displayname")),this.$name.attr("contenteditable",!1).addClass("pulse")},onAnimationEnd:function(e){"pulse"===e.originalEvent.animationName&&this.$name.removeClass("pulse")},onKeypress:function(e){13==e.keyCode&&(e.preventDefault(),this.saveName())},onKeydown:function(e){27===e.keyCode&&(this.$name.html(m.models.customization.get("displayname")),this.doneEditingName())},saveName:function(){var e=this.$name.html();""===e?this.$name.html(m.models.customization.get("displayname")):m.models.customization.save({displayname:e}),this.doneEditingName()},doneEditingName:function(){this.$name.attr("contenteditable",!1).removeClass("editing").addClass("pulse")}}),m.views.CenterClock=Backbone.View.extend({id:"centerclock",events:{dblclick:"toggleMode"},initialize:function(){this.listenTo(m.models.customization,"change:percentClock",this.percentClockToggled),this.render()},render:function(){var e=(this.options.order||"append")+"To";return this.$el[e]("#"+this.options.region).html("").fadeTo(500,1),m.models.customization.get("percentClock")&&"on"==localStorage.getItem("clockPercent")?m.views.clockView=new m.views.PercentClock({model:this.model,parent:this}):m.views.clockView=new m.views.DefaultClock({model:this.model,parent:this}),this.$el.append(m.views.clockView.render().$el),this},percentClockToggled:function(){m.models.customization.get("percentClock")&&localStorage.setItem("clockPercent","on"),this.render()},toggleMode:function(){m.models.customization.get("percentClock")&&("on"==localStorage.getItem("clockPercent")?localStorage.setItem("clockPercent","off"):localStorage.setItem("clockPercent","on"),this.render())}}),m.views.DefaultClock=Backbone.View.extend({attributes:{"class":"clock default-clock"},template:m.templates.centerclock.clock,events:{dblclick:"toggleFormat"},initialize:function(){this.render(),this.listenTo(this.model,"change:time",this.update,this),this.listenTo(m.models.customization,"change:hour12clock",this.timeFormatSettingChanged)},render:function(){var e={time:this.model.getTimeString(),format:"AM"};return this.$el.html(this.template(e)),this.$time=this.$(".time"),this.$format=this.$(".format"),this},update:function(){this.$time.html(this.model.getTimeString())},toggleFormat:function(){if(!m.models.customization.get("percentClock")){var e=m.models.customization.get("hour12clock");e=!e,m.models.customization.save({hour12clock:e}),this.setTimeFormat(e)}},timeFormatSettingChanged:function(){var e=m.models.customization.get("hour12clock");this.setTimeFormat(e)},setTimeFormat:function(e){e?(setTimeout(function(){$(".format").addClass("show")},40),this.$format.html(this.model.getTimePeriod())):$(".format").removeClass("show")}}),m.views.PercentClock=Backbone.View.extend({attributes:{"class":"percent-clock"},template:m.templates.centerclock.clock,events:{},initialize:function(){this.render(),this.listenTo(this.model,"change:time",this.update,this)},render:function(){return this.$el.html(this.template({time:this.getPercent(),format:"%"})),this.$time=this.$(".time"),this.$format=this.$(".format"),this.$format.css({opacity:1,"font-size":"250%",left:"106%",bottom:"11%"}),this},getPercent:function(){var e=3,t=8,i=30,n=17,o=30,s=60*(n+o/60-(t+i/60))*60*1e3,a=new Date,l=new Date;a.getHours()<e&&(l=new Date(Date.now()+-864e5)),l.setHours(t,i,0,0);var r=a.getTime()-l.getTime(),d=Math.floor(r/s*100);return d>100&&(d="+"+(d-100)),d},update:function(){this.$time.html(this.getPercent())}}),m.commands.AuthConnect=m.models.Command.extend({defaults:{id:"auth.connect"},execute:function(e){var t=e.actionParameter,i=0;if(t&&t.status&&"authRequired"==t.status&&t.authorizationUrl&&2>i){i++;var n=t.winWidth?t.winWidth:600,o=t.winHeight?t.winHeight:510,s=t.windowFeatures?t.windowFeatures:"titlebar,resizable,toolbar,status",a=window.screen.width/2-n/2,l=window.screen.height/2-o/2,r=window.open(t.authorizationUrl,"MomentumAuthWindow",s+",left="+a+",top="+l+",width="+n+",height="+o),d=setInterval(function(){r.closed&&(clearInterval(d),m.models.todoListManager.doFetchIfNeeded(!0))},250)}}}),m.commands.CleanLocalStorage=m.models.Command.extend({defaults:{id:"clean.localstorage"},initialize:function(){this.twoDaysAgo=Date.now()-1728e5},execute:function(){var e=this,t=localStorage.getItem("last_cleanup");if(!(t>this.twoDaysAgo))var i=setTimeout(function(){try{var t=0;if(!m||!m.collect||!m.collect.backgrounds)return;clearTimeout(i);for(var n=[],o=!1,s=null,a=0;a<localStorage.length;a++)o=!1,s=localStorage.key(a),"archived-"==s.substring(0,9)&&(o=!0),"fallback-"==s.substring(0,9)&&(o=!0),"image_displayed-"==s.substring(0,16)&&(o=!0),"weather-loc-"==s.substring(0,12)?o=!0:"ddl-bg-"==s.substring(0,7)?localStorage.getItem(s)<e.twoDaysAgo&&(o=!0):"ddl-qt-"==s.substring(0,7)&&localStorage.getItem(s)<e.twoDaysAgo&&(o=!0),o&&n.push(s);for(var a=0;a<n.length;a++)localStorage.removeItem(n[a]);t+=n.length,t+=e.collectionCleaner(m.collect.backgrounds),t+=e.collectionCleaner(m.collect.quotes),t+=e.collectionCleaner(m.collect.shortquotes),m.commandManager.execute("clean.localstorage.addin"),localStorage.setItem("last_cleanup",Date.now())}catch(l){}},500)},collectionCleaner:function(e,t){var i=this;if(e){t=t||"forDate",entriesToClean=[],e.each(function(e){var n=e.get(t);Date.parse(n)<i.twoDaysAgo&&entriesToClean.push(n)});for(var n=0;n<entriesToClean.length;n++){var o=e.get(entriesToClean[n]);o.destroy()}return entriesToClean.length}return 0}}),m.commands.LoadAddins=m.models.Command.extend({defaults:{id:"addins.load"},execute:function(e){if(e){if(!this.addInsLoaded)for(this.addInsLoaded=!0,i=0;i<e.length;i++){var t=e[i];t&&m.addinManager.loadAddin(t)}m.trigger("processAddIns")}}}),m.commands.Logout=m.models.Command.extend({defaults:{id:"logout"},execute:function(){var e=this;if(localStorage.token&&localStorage.token_uuid){var t={token:localStorage.token,token_uuid:localStorage.token_uuid};$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(t),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/logout"}).done(function(e){}).fail(function(e,t){}).always(function(t,i){localStorage.removeItem("token"),localStorage.removeItem("token_uuid"),m.conditionalFeatures.clearFeatures(),e.showLogoutMessageAndReload()})}else localStorage.removeItem("token"),this.showLogoutMessageAndReload()},showLogoutMessageAndReload:function(e){m.commandManager.execute("notification.show.enhanced",{message:"You have been logged out.",display_time:5e3,viewLimit:1,priority:2},function(){window.location.reload()},!0)}}),m.commands.WindowNavigate=m.models.Command.extend({defaults:{id:"window.navigate"},execute:function(e,t){if(t){var i=null;t.url&&(i=t.url),e&&t.urlField&&(i=e.get(t.urlField)),i&&(window.location.href=i)}}}),m.commands.WindowOpen=m.models.Command.extend({defaults:{id:"window.open"},execute:function(e,t){if(t){var i=null;t.url&&(i=t.url),e&&t.urlField&&(i=e.get(t.urlField)),i&&window.open(i,t.windowName||"_blank")}}}),m.commands.SettingsColorPicker=m.models.Command.extend({defaults:{id:"settings.color.picker"},initialize:function(){this.views=[]},execute:function(e,t){if(t&&t.settingName){var i=_.findWhere(this.views,{settingName:t.settingName});return i||(i=new m.views.settings.ColorPicker(t.settingName,e,t),this.views.push(i)),i}return null}}),m.commands.SettingsDisplay=m.models.Command.extend({defaults:{id:"settings.display"},execute:function(e,t){m.views.settings.mainSettings&&m.views.settings.mainSettings.showSettings(t)}}),m.commands.SettingsDisplayUpgrade=m.models.Command.extend({defaults:{id:"settings.display.upgrade"},execute:function(e,t,i){m.views.settings.mainSettings&&(t=t||{},t.section="upgrade",m.views.settings.mainSettings.showSettings(t))}}),m.commands.SettingsToggle=m.models.Command.extend({defaults:{id:"settings.toggle"},execute:function(e,t){m.views.settings.mainSettings&&m.views.settings.mainSettings.toggleVisible()}}),m.commands.SettingsHide=m.models.Command.extend({defaults:{id:"settings.hide"},execute:function(e,t){m.views.settings.mainSettings&&m.views.settings.mainSettings.hideSettings()}}),m.commands.SettingEnable=m.models.Command.extend({defaults:{id:"setting.enable"},execute:function(e,t){if(t&&t.name){var i={};i[t.name]=!!t.value,m.models.customization.set(i)}}}),m.commands.SettingsCacheUpgradeCopy=m.models.Command.extend({defaults:{id:"settings.cache.upgradecopy"},fetching:!1,fetched:!1,execute:function(e,t){var i=this;if((e||!m.conditionalFeatures.featureEnabled("plus"))&&(e||!i.fetching&&!i.fetched)){i.fetching=!0;var n=m.globals.urlRootApi+"settings/upgradecopy";t&&e?n=n+"?refresh=1&src="+encodeURIComponent(t):t?n=n+"?src="+encodeURIComponent(t):e&&(n+="?refresh=1"),$.ajax({type:"GET",beforeSend:setMomentumAuthHeader,url:n}).done(function(e){i.fetching=!1,e&&(i.fetched=!0,localStorage.setItem("cachedUpgradeCopy",JSON.stringify(e)),m.trigger("settings:upgradeCopyChanged"))}).fail(function(e,t){i.fetched=!1,i.fetching=!1}),setTimeout(function(){i.fetching&&(i.fetching=!1)},1e4)}}}),m.commands.TodoMove=m.models.Command.extend({defaults:{id:"todo.move.id"},execute:function(e,t){e.attemptSave({listId:t.target_id})},canExecute:function(e,t){return t?e.get("done")?!1:e.get("listId")==t.target_id?!1:!0:!1}}),m.commands.TodoMoveToListType=m.models.Command.extend({defaults:{id:"todo.move.type"},execute:function(e,t,i){var n=i.getListOfType(t.target);return n?void e.attemptSave({listId:n.id}):!1},canExecute:function(e,t,i){if(!t)return!1;if(e.get("done"))return!1;var n=i.getListOfType(t.target);return n?e.get("listId")==n.id?!1:!0:!1}}),m.commands.TodoMoveDone=m.models.Command.extend({defaults:{id:"todo.move.done"},execute:function(e,t,i){if(e.get("done")){var n=i.getListOfType("done");if(!n)return!1;e.get("listId")==n.id?e.archive():e.attemptSave({listId:n.id})}},canExecute:function(e,t,i){if(e.get("done")){var n=i.getListOfType("done");return n?!0:!1}return!1}}),m.commands.TodoDelete=m.models.Command.extend({defaults:{id:"todo.delete"},execute:function(e){e.attemptSave({deleted:!0,deletedDate:(new Date).toISOString()})},canExecute:function(e,t){return e.get("done")?!1:!0}}),m.commands.TodoFocusPin=m.models.Command.extend({defaults:{id:"todo.focus.pin"},execute:function(e){m.views.focuses.displayConnectingText('<i class="loading-icon"></i>Saving...',!0);var t=getActiveDateString(),i={todoId:e.id,listId:e.get("listId"),forDate:t};$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify(i),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootApi+"focus/pin"}).done(function(e){e.success&&1==e.success&&(m.views.focuses.successfulConnection(),m.models.customization.get("autoFocus")?m.models.customization.set("autoFocus",!1):m.collect.focuses.fetch({reset:!0}))}).fail(function(e,t){})},canExecute:function(e,t){return e.get("done")?!1:!0}}),m.commands.TodoRetryConnection=m.models.Command.extend({defaults:{id:"todo.connection.retry"},execute:function(e){m.models.todoListManager&&m.models.todoListManager.doFetchIfNeeded(!0)}}),m.commands.ToggleAutoFocus=m.models.Command.extend({defaults:{id:"todo.toggle.autofocus"},execute:function(e){m.conditionalFeatures.featureEnabled("pinfocus")?m.models.customization.toggle("autoFocus"):m.commandManager.execute("settings.display",null,{section:"upgrade",source:"autofocus"})}}),m.commands.ToggleKeepTodoState=m.models.Command.extend({defaults:{id:"todo.toggle.keepstate"},execute:function(e){m.models.customization.toggle("keepTodoState"),m.models.customization.get("keepTodoState")||(localStorage.showTodoList=!1)}}),m.commands.TodoListDefaultCommand=m.models.Command.extend({defaults:{
id:"todo.list.defaultcommand"},execute:function(e,t){if(t&&t.get("done"))return{captionText:"Archive to Done",commandId:"todo.move.done"};var i=e.get("id");return"today"==i?{captionText:"Move to Inbox",commandId:"todo.move",options:{target:"inbox"}}:"inbox"==i?{captionText:"Move to Today",commandId:"todo.move",options:{target:"today"}}:null}}),m.commands.TodoListArchiveAllDone=m.models.Command.extend({defaults:{id:"todo.list.archive"},execute:function(e,t){if(e&&!e.isDoneList()){var i=m.collect.todos.completeToday();_.each(i,function(e){e.archive()})}},canExecute:function(e){if(e&&e.isDoneList())return!1;var t=e.itemCollection;return t&&t.completedCount()>0?!0:!1}}),m.commands.TodoProviderChange=m.models.Command.extend({defaults:{id:"settings.todo.provider.change"},execute:function(e,t){t&&t.provider_id&&m.models.todoListManager.changeProvider(t.provider_id)}}),m.commands.TodoListCheckStateAssigned=m.models.Command.extend({defaults:{id:"todo.list.check.state.assigned"},execute:function(e,t,i){var n=e.collection.selectedListId,o=m.models.customization.get("assigned-"+n);return o?!0:!1}}),m.commands.TodoListCheckToggleAssigned=m.models.Command.extend({defaults:{id:"todo.list.check.toggle.assigned"},execute:function(e,t){var i=e.collection.selectedListId,n=m.models.customization.get("assigned-"+i);return m.models.customization.set("assigned-"+i,!n),!1}}),m.commands.TodoTrelloAuxData=m.models.Command.extend({defaults:{id:"todo.trello.aux"},execute:function(e,t){var i={};return e.collection&&e.collection.parentList&&(i.showAssignedOnly=m.models.customization.get("assigned-"+e.collection.parentList.id)),i}}),m.commands.TodoTrelloOpenConfig=m.models.Command.extend({defaults:{id:"todo.trello.config"},execute:function(){m.commandManager.execute("settings.display",null,{section:"trello"})}}),m.commands.WeatherProcessFetched=m.models.Command.extend({defaults:{id:"weather.process.fetched"},execute:function(e,t){}}),m.commands.WeatherUpdate=m.models.Command.extend({defaults:{id:"weather.update"},locationMigrated:!1,execute:function(e,t){if(!this.locationMigrated){var i=this.getManualWeatherLocation();if(i){if(e.has("manualLocation"))return this.locationMigrated=!0,e.unset("manualLocation"),void e.save({})}else{var n=e.get("manualLocation");if(n&&n.length>0)return i={enteredLocation:n,woeid:null,location_name:null},localStorage.setItem("manual-weather-location",JSON.stringify(i)),this.locationMigrated=!0,e.unset("manualLocation"),void e.save({})}this.locationMigrated=!0}this.updateWeather(e)},updateWeather:function(e){function t(){navigator.geolocation.getCurrentPosition(n,o)}function i(t){var i={};e.get("location")!=t.location_name&&(i.location=t.location_name),e.get("woeid")!=t.woeid&&(i.woeid=t.woeid),e.set(i)}function n(e){try{var t=!0,n=d.getLastWeatherLocation();n&&+n.latitude.toFixed(3)==+e.coords.latitude.toFixed(3)&&+n.longitude.toFixed(3)==+e.coords.longitude.toFixed(3)&&(t=!1,i(n),r(n.woeid)),t&&l("("+e.coords.latitude+","+e.coords.longitude+")",e.coords)}catch(o){console.log(o)}}function o(t){console.log("Error getting location: "+t.code+", msg: "+t.message);var i=d.getManualWeatherLocation();i?l():e.save("error","location error")}function s(e){var t={woeid:e.woeid};return e.locality1&&e.locality1.content?t.city=e.locality1.content:t.city=e.name,e.country&&(t.countrycode=e.country.code),t}function a(t){var i="https://query.yahooapis.com/v1/public/yql?q=SELECT%20*%20FROM%20geo.places%20WHERE%20text%3D%22"+encodeURIComponent(t)+"%22&format=json";$.getJSON(i,function(i){var n=i.query.count,o=null,a=!1;if(n>1?(a=!0,o=s(i.query.results.place[0])):1==n?i.query.results.place&&(a=!0,o=s(i.query.results.place)):e.save("error","not found"),a){var l={enteredLocation:t,woeid:o.woeid,location_name:o.city};localStorage.setItem("manual-weather-location",JSON.stringify(l))}if(o&&o.countrycode&&(e.get("location")||d.setUnit(o.countrycode,e),localStorage.country=o.countrycode),o){var c=o.city,u=o.woeid;e.save({location:c,woeid:u,error:null}),r(u)}}).error(function(e){console.log("Error getting WoeID")})}function l(t,i){var n=d.getManualWeatherLocation();n&&(t=n.enteredLocation);var o="https://query.yahooapis.com/v1/public/yql?q=SELECT%20*%20FROM%20geo.places%20WHERE%20text%3D%22"+encodeURIComponent(t)+"%22&format=json";$.getJSON(o,function(t){var n=t.query.count,o=null;if(n>1)validYQLResult=!0,o=s(t.query.results.place[0]);else if(1==n)t.query.results.place&&(validYQLResult=!0,o=s(t.query.results.place));else{var a=d.getLastWeatherLocation();a?o={woeid:a.woeid,city:a.location}:e.save("error","not found")}try{if(validYQLResult&&i){var l={latitude:i.latitude,longitude:i.longitude,woeid:o.woeid,location_name:o.city};localStorage.setItem("last-weather-location",JSON.stringify(l)),m.commandManager.execute("weather.process.fetched",i,t.query.results)}}catch(c){console.log(c)}if(o&&o.countrycode&&(e.get("location")||d.setUnit(o.countrycode,e),localStorage.country=o.countrycode),o){var a=o.city,u=o.woeid;e.save({location:a,woeid:u,error:null}),r(u)}}).error(function(e){console.log("Error getting WoeID")})}function r(t){var i=d.displayUnit();i||(i="c");var n=i,o="https://query.yahooapis.com/v1/public/yql?q="+encodeURIComponent("select * from weather.forecast where woeid="+t+' and u="'+i+'"')+"&format=json";$.getJSON(o,function(t){if(t&&t.query&&1==t.query.count){var i=t.query.results.channel.item.condition,o=t.query.results.channel.units;o&&o.temperature&&(n=o.temperature.toLowerCase()),i&&e.save({fetchTemperature:i.temp,fetchUnit:n,code:i.code,condition:i.text,updated:new Date,error:null})}}).error(function(e){console.log("Error getting weather data: "+e)})}var d=this,c=this.getManualWeatherLocation();c?c.woeid?(i(c),r(c.woeid)):a(c.enteredLocation):t()},setUnit:function(e,t){var i=["US","BM","BZ","JM","PW"];i.indexOf(e)>=0?t.save("fetchUnit","f"):t.save("fetchUnit","c")},getLastWeatherLocation:function(){var e=localStorage.getItem("last-weather-location");return e?JSON.parse(e):null},displayUnit:function(){var e=m.models.customization.get("temperatureUnit");return e?e:"c"},getManualWeatherLocation:function(){var e=localStorage.getItem("manual-weather-location");return e?JSON.parse(e):null}}),m.isValidDate=function(e){return"[object Date]"!==Object.prototype.toString.call(e)?!1:!isNaN(e.getTime())},m.models.Date=Backbone.Model.extend({defaults:function(){var e=new Date;return{date:e}},initialize:function(){this.listenTo(this,"change:date",this.updateTime,this)},startUpdateTimer:function(){this.dateIntervalId=setInterval(function(){m.models.date.set("date",new Date)},100)},getTimeString:function(e){var t=m.models.customization.get("hour12clock");e=e||this.get("date");var i=e.getHours(),n=e.getMinutes();return 1==t&&(i=(i+11)%12+1),10>i&&!t&&(i="0"+i),10>n&&(n="0"+n),i+":"+n},getTimePeriod:function(){return this.get("date").getHours()>=12?"PM":"AM"},updateTime:function(){var e=this.getTimeString();this.get("time")!=e&&this.set("time",e)}}),m.views.Dashboard=Backbone.View.extend({initialize:function(){m.models.themeManager=new m.models.ThemeManager,m.models.customization.fetch({error:function(){m.models.customization.save(),m.models.themeManager.initializeThemes()},success:function(){m.models.themeManager.initializeThemes()}}),this.listenTo(m,"processAddIns",this.processAddIns),m.models.backgroundManager=new m.models.BackgroundManager,m.views.background=new m.views.Background({region:"background"}),m.views.backgroundInfo=new m.views.BackgroundInfo({region:"bottom-left"}),m.models.backgroundManager.firstFetch(),m.models.notificationManager=new m.models.NotificationManager,m.bootstrappers.InitializeQuote(m,$),m.models.date&&m.models.date.startUpdateTimer(),this.newDayIntervalId=setInterval(function(){if(localStorage.activeDate){if(localStorage.activeDate!=getActiveDateString()){var e=9e3*Math.random()+1e3;setTimeout(function(){localStorage.activeDate=getActiveDateString(),m.trigger("newDay")},e)}}else localStorage.activeDate=getActiveDateString()},1e4),!m.models.customization.get("displayname")||localStorage.doLoginOnNextLoad?m.views.introduction=new m.views.Introduction({region:"full"}):(m.bootstrappers.InitializeFocus(m,$),this.render());var e=$("body"),t=new Dragster(document.body);m.conditionalFeatures.featureEnabled("custom-bg")&&!m.models.customization.get("disableDrop")&&(this.addEventHandler(document.body,"dragover",function(e){e.stopPropagation(),e.preventDefault(),_.contains(e.dataTransfer.types,"Files")?e.dataTransfer.dropEffect="copy":e.dataTransfer.dropEffect="none"}),document.addEventListener("dragster:enter",function(t){_.contains(t.detail.dataTransfer.types,"Files")&&e.addClass("drop")},!1),document.addEventListener("dragster:leave",function(t){e.removeClass("drop")},!1),this.addEventHandler(document.body,"drop",function(i){if(i.stopPropagation(),i.preventDefault(),e.removeClass("drop"),t.removeListeners(),t=new Dragster(document.body),_.contains(i.dataTransfer.types,"Files")){if(!m.conditionalFeatures.featureEnabled("custom-bg"))return void m.commandManager.execute("settings.display.upgrade",null,{source:"customBackgrounds-dropFiles"});var n=i.dataTransfer.files;n&&n.length>0&&m.commandManager.ensureCommandLoaded("background.custom.uploadfiles",function(){m.commandManager.execute("background.custom.uploadfiles",n)},null,function(e){})}})),this.initializeCompleted=!0},addEventHandler:function(e,t,i){e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent?e.attachEvent("on"+t,i):e["on"+t]=i},processAddIns:function(){var e=this;e.processAddInsIntervalId=setInterval(function(){e.initializeCompleted&&(clearInterval(e.processAddInsIntervalId),m.addinManager.processPending(),m.conditionalFeatures.featureEnabled("randomWidget")&&(m.models.genericWidget=new m.models.GenericWidget,m.views.genericWidget=new m.views.GenericWidget({model:m.models.genericWidget,region:"top-right",order:"prepend"}),m.widgets.push(m.views.genericWidget)))},50)},render:function(e){m.bootstrappers.RenderQuote(m,$,e),m.bootstrappers.RenderFocus(m,$,e),m.views.backgroundInfo&&(m.views.backgroundInfo.parentReady(e),m.widgets.push(m.views.backgroundInfo)),m.views.settingsPane=new m.views.settings.SettingsPane({region:"bottom-left",order:"prepend"}),m.widgets.push(m.views.settingsPane),m.models.notificationManager.setParent(m.views.settingsPane),m.bootstrappers.RenderSearch(m,$),m.bootstrappers.RenderQuickLinks(m,$),m.views.greeting=new m.views.Greeting({model:m.models.date,region:"center",order:"prepend"}),m.widgets.push(m.views.greeting),m.views.centerClock=new m.views.CenterClock({model:m.models.date,region:"center",order:"prepend"}),m.widgets.push(m.views.centerClock),m.bootstrappers.RenderTodos(m,$),m.bootstrappers.RenderWeather(m,$)},getViewById:function(e){var t=null;return _.each(m.widgets,function(i){i.el.id===e&&(t=i)}),t},removeView:function(e){_.each(m.widgets,function(t){t.el.id===e&&t.$el.fadeTo(500,0,function(){t.remove(),m.widgets.splice(m.widgets.indexOf(t),1)})})},removeAllViews:function(e){_.each(m.widgets,function(e){e&&e.$el.fadeTo(500,0,function(){e.remove()})}),m.widgets=[],_.delay(e,475)}}),$(function(){var e=function(){try{for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;1e3>i;i++)e+=t.charAt(Math.floor(Math.random()*t.length));localStorage.setItem("capacityTest",e),localStorage.removeItem("capacityTest")}catch(n){try{localStorage.removeItem("capacityTest");for(var o=Date.now()-1728e5,s=[],a=!1,l=null,i=0;i<localStorage.length;i++)a=!1,l=localStorage.key(i),"last_cleanup"==l.substring(0,12)&&(a=!0),"archived-"==l.substring(0,9)&&(a=!0),"fallback-"==l.substring(0,9)&&(a=!0),"listCache-"==l.substring(0,10)&&(a=!0),"font-"==l.substring(0,5)&&(a=!0),"image_displayed-"==l.substring(0,16)&&(a=!0),"weather-loc-"==l.substring(0,12)?a=!0:"ddl-bg-"==l.substring(0,7)?localStorage.getItem(l)<o&&(a=!0):"ddl-qt-"==l.substring(0,7)&&localStorage.getItem(l)<o&&(a=!0),a&&s.push(l);for(var i=0;i<s.length;i++)localStorage.removeItem(s[i])}catch(n){}}};e(),m.utils.captionFormatter=function(e){return e},m.utils.setMomentumAuthHeader=setMomentumAuthHeader,m.utils.validateEmail=validateEmail,m.utils.getQueryParameter=getQueryParameter,m.utils.getActiveDateString=getActiveDateString,m.utils.activeDateStringForDate=activeDateStringForDate,m.utils.twoDigit=twoDigit,m.utils.memberwiseCompareObject=function(e,t,i){if(e===t)return!0;if(!(e instanceof Object&&t instanceof Object))return!1;if(e.constructor!==t.constructor)return!1;for(var n in e)if((!i||!_.contains(i,n))&&e.hasOwnProperty(n)){if(!t.hasOwnProperty(n))return!1;if(e[n]!==t[n]){if("object"!=typeof e[n])return!1;if(!Object.equals(e[n],t[n]))return!1}}for(n in t)if((!i||!_.contains(i,n))&&t.hasOwnProperty(n)&&!e.hasOwnProperty(n))return!1;return!0},m.models.customization=new m.models.Customization({id:1}),m.models.date=new m.models.Date,m.conditionalFeatures=new m.models.ConditionalFeatures,$(document).click(function(e){m.trigger("globalEvent:click",e)}),$(document).keyup(function(e){switch(e.which){case 27:m.trigger("globalEvent:esc",e)}}),$(document).keydown(function(e){if(!(e.ctrlKey||e.metaKey||e.altKey&&78!=e.keyCode||"INPUT"==document.activeElement.tagName||"TEXTAREA"==document.activeElement.tagName||1==document.activeElement.isContentEditable)){if(76==e.keyCode)var t="Quick Links";else if(70==e.keyCode)var t="Focus";else if(84==e.keyCode)var t="Todo";else if(83==e.keyCode)var t="Search";else if(188==e.keyCode){if(e.metaKey)return;var t="Settings"}else{if(67==e.keyCode){var t="Chrome Tab";return m.sendEvent(t,"Hotkey"),void chrome.tabs.update({url:"chrome-search://local-ntp/local-ntp.html"})}8==e.keyCode?m.trigger("globalEvent:key:backspace",e):13==e.keyCode?m.trigger("globalEvent:key:enter",e):32==e.keyCode?m.trigger("globalEvent:spacebar",e):38==e.keyCode?m.trigger("globalEvent:arrowUp",e):40==e.keyCode?m.trigger("globalEvent:arrowDown",e):37==e.keyCode?m.trigger("globalEvent:arrowLeft",e):39==e.keyCode?m.trigger("globalEvent:arrowRight",e):78==e.keyCode&&m.trigger("globalEvent:key:N",e)}t&&(m.trigger("globalEvent:toggle"+t.replace(/\s+/g,"")),m.sendEvent(t,"Toggle Show","Hotkey"),e.preventDefault())}}),"safari"==m.globals.platform&&$("a").on("click",function(e){safari.self.tab.dispatchMessage("sendClick",{link:this.href,time:(new Date).getTime()})}),m.listenTo(m,"user:successfulLogout",function(){m.appView.removeAllViews(function(){m.appView=new m.views.Dashboard})}),m.addinManager=new m.models.AddinManager,m.commandManager=new m.CommandManager,m.settingsManager=new m.models.SettingsManager,m.widgetManager=new m.models.WidgetManager,m.appView=new m.views.Dashboard,$(window).resize(function(){m.trigger("globalEvent:window:resize")}),localStorage.client_uuid||$.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({action:"registerClient"}),beforeSend:setMomentumAuthHeader,url:m.globals.urlRootLogin+"user/client"}).done(function(e){e.client_uuid&&localStorage.client_uuid!=e.client_uuid&&(localStorage.client_uuid=e.client_uuid,m.trigger("client:id_created"))}).fail(function(e,t){}),m.syncCoordinator=new m.models.SyncCoordinator,window.addEventListener("storage",function(e){if("activeDate"==e.key&&e.oldValue!=e.newValue){var t=9e3*Math.random()+1e3;setTimeout(function(){m.trigger("newDay")},t)}}),localStorage.firstSynchronized&&m.trigger("sync:downloadIfNeeded"),function(){var e={sampleRate:1};ga("create",m.globals.googleAnalyticsCode,"auto",e),ga("set","checkProtocolTask",function(){}),ga("require","displayfeatures"),ga("send","pageview","/dashboard.html?v="+m.globals.version)}(),m.syncCoordinator.syncSettings()}),function(e,t,i,n,o,s,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,s=t.createElement(i),a=t.getElementsByTagName(i)[0],s.async=1,s.src=n,a.parentNode.insertBefore(s,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga");